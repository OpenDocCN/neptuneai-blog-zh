<html>
<head>
<title>How to Train Your Own Object Detector Using TensorFlow Object Detection API </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何使用TensorFlow对象检测API训练自己的对象检测器</h1>
<blockquote>原文：<a href="https://web.archive.org/web/https://neptune.ai/blog/how-to-train-your-own-object-detector-using-tensorflow-object-detection-api#0001-01-01">https://web.archive.org/web/https://neptune.ai/blog/how-to-train-your-own-object-detector-using-tensorflow-object-detection-api#0001-01-01</a></blockquote><div><div class="l-content content-wrapper js-content">
            
<p>目标检测是一项计算机视觉任务，最近受到机器学习进展的影响。</p>



<p>在过去，创建一个定制的对象检测器看起来是一项耗时且具有挑战性的任务。现在，有了像<a href="https://web.archive.org/web/20221206004728/https://tensorflow-object-detection-api-tutorial.readthedocs.io/en/latest/index.html" target="_blank" rel="noreferrer noopener nofollow"> TensorFlow对象检测API </a>这样的工具，我们可以快速轻松地创建可靠的模型。</p>





<p>在本文中，我们将重点介绍第二代TensorFlow对象检测API，它:</p>



<ul>
<li>支持张量流2，</li>



<li>允许您使用最先进的模型架构进行对象检测，</li>



<li>为您提供了一种配置模型的简单方法。</li>
</ul>



<p>如果你有兴趣了解TensorFlow 2及其API中所有可用的特性，你可以在Google 的<a href="https://web.archive.org/web/20221206004728/https://blog.tensorflow.org/2020/07/tensorflow-2-meets-object-detection-api.html" target="_blank" rel="noreferrer noopener nofollow">官方公告中找到它们。</a></p>



<p>阅读完本文后，您应该能够创建自己的自定义对象检测器。</p>



<p>我们将使用基于<a href="https://web.archive.org/web/20221206004728/https://ai.googleblog.com/2020/04/efficientdet-towards-scalable-and.html" target="_blank" rel="noreferrer noopener nofollow"> EfficientDet的模型</a>作为示例，但是您也将学习如何使用<a href="https://web.archive.org/web/20221206004728/https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/tf2_detection_zoo.md" target="_blank" rel="noreferrer noopener nofollow">您选择的任何架构</a>来启动并运行模型。敬请期待！你自己的物体探测器就在眼前。</p>





<h2 id="h-before-you-start">开始之前</h2>



<p>让我简单地谈谈开发您自己的对象检测器所必需的先决条件:</p>



<ul>
<li>你应该在你的电脑上安装Python。如果你需要安装它，我推荐<a href="https://web.archive.org/web/20221206004728/https://docs.anaconda.com/anaconda/install/" target="_blank" rel="noreferrer noopener nofollow">遵循Anaconda </a>的官方指南。</li>



<li>如果你的计算机有一个支持CUDA的GPU(NVIDIA制造的GPU)，那么需要一些相关的库来支持基于GPU的训练。如果您需要启用GPU支持，请查看NVIDIA网站上的<a href="https://web.archive.org/web/20221206004728/https://docs.nvidia.com/cuda/archive/10.1/index.html#installation-guides" target="_blank" rel="noreferrer noopener nofollow">指南</a>。您的目标是为您的操作系统安装CUDA工具包和cuDNN的最新版本。</li>
</ul>



<p id="separator-block_ba5e4c76a015358a674b54b7ced9632f" class="block-separator block-separator--5">安装和设置</p>



<h2 id="h-installation-and-setup">让我们首先确保我们已经准备好开始使用TensorFlow对象检测API所需的一切。我将回顾整个设置过程，并解释每一步的工作原理。</h2>



<p>如果您已经使用过TF API，您仍然可以快速浏览一下这一部分，只是为了确保我们遵循相同的方向。</p>



<p>但是如果您是第一次安装Tensorflow对象检测API，我强烈建议您完成本节中的所有步骤。让我们跳进来吧！</p>



<p><strong> 1。创建项目目录</strong></p>







<h3>在您选择的路径下，创建一个新文件夹。命名为<code>Tensorflow</code>。</h3>



<p><strong> 2。创建新的虚拟环境</strong></p>



<h3>打开一个<em>终端</em>窗口<em> </em>，使用<code>cd</code>命令导航到步骤1中创建的<code>Tensorflow</code>文件夹。</h3>



<ul>
<li>使用<code>venv</code>库创建一个新的虚拟环境:</li>
</ul>



<ul>
<li>如果您的机器上已经安装了<code>venv</code>(或者您更喜欢使用另一个工具来管理环境，如<em><a href="https://web.archive.org/web/20221206004728/https://www.anaconda.com/" target="_blank" rel="noreferrer noopener nofollow">【Anaconda</a></em>)，那么直接进行新环境的创建。</li>
</ul>



<p>如果你不知道什么是<code>venv</code>或者没有安装它，你可以在你的<em>终端</em>窗口中输入以下命令:</p>



<p>为了使用<code>venv</code>创建一个新环境，在您的<em>终端</em>窗口中键入以下命令:</p>



<pre class="hljs">pip install venv
</pre>



<p>一旦执行完毕，<code>venv</code>将创建一个名为<code>tf2_api_env</code>的新虚拟环境。</p>



<pre class="hljs">python -m venv tf2_api_env
</pre>



<p>激活新创建的虚拟环境:</p>



<ul>
<li>为了激活我们刚刚创建的虚拟环境，您首先需要确保您当前的工作目录是<code>Tensorflow</code>。您可以通过在您的<em>终端</em>窗口中键入并执行以下命令来检查您当前的工作目录:</li>
</ul>



<p>为了激活您的虚拟环境，从您的<em>终端</em>窗口运行以下命令:</p>



<pre class="hljs">pwd
</pre>



<p>如果您在您的<em>终端</em>窗口的命令行开头看到您的环境的名称，那么您就一切就绪了。它应该是这样的:</p>



<pre class="hljs">source tf2_api_env/bin/activate</pre>



<p>是时候在我们的环境中安装TensorFlow了。确保您的环境已激活，并通过执行以下命令进行安装:</p>


<div class="wp-block-image">
<figure class="aligncenter size-large"><img decoding="async" src="../Images/4ea4c8b5514d57dc2581901b300934d0.png" alt="virtual environment activation" class="wp-image-28884" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20221206004728im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/virtual-environment-activation.png?ssl=1"/><figcaption class="wp-element-caption"><em>Successful virtual environment activation in the Terminal window</em></figcaption></figure></div>






<p><strong>注:</strong>在我写这篇文章的时候，最新的TensorFlow版本是2.3。您可以使用这个版本，但这不是必需的。我们在本指南中所做的一切都是与2.3兼容的，它也可能适用于以后的更新。这取决于你去尝试。如果有任何问题，您可以随时降级到2.3并继续前进。</p>



<pre class="hljs">pip install tensorflow==<span class="hljs-number">2.</span>*
</pre>



<p><strong> 3。下载并提取TensorFlow模型花园</strong></p>



<h3>模型花园是github.com的官方张量流存储库。在这一步中，我们希望将这个回购克隆到我们的本地机器上。</h3>



<p>确保在你的<em>终端</em>窗口中，你位于<code>Tensorflow</code>目录中。</p>



<ul>
<li>在您的web浏览器中，转到<a href="https://web.archive.org/web/20221206004728/https://github.com/tensorflow/models" target="_blank" rel="noreferrer noopener nofollow"> Model Garden Repo </a>并点击<em>代码</em>按钮，以便选择最适合您的克隆方法(选项有HTTPS、SSH或GitHub CLI)。</li>
</ul>



<ul>
<li>选择克隆方法后，将存储库克隆到您的本地<code>Tensorflow</code>目录。如果你在克隆方面需要额外的帮助，请查看官方GitHub指南。</li>
</ul>


<div class="wp-block-image">
<figure class="aligncenter size-large"><img decoding="async" src="../Images/d556d48c5f6ab252cb6eb3fbb82227aa.png" alt="cloning metod" class="wp-image-28886" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20221206004728im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/cloning-method.png?ssl=1"/><figcaption class="wp-element-caption"><em>Selecting a cloning method for an official Model Garder Tensorflow repo</em></figcaption></figure></div>


<ul>
<li>到现在为止，在<code>Tensorflow</code>目录下应该有如下结构:</li>
</ul>



<p><strong> 4。下载、安装并编译Protobuf </strong></p>



<pre class="hljs">Tensorflow/
└─ tf2_api_env/
   ├─ bin/
   ├─ include/
   └── …
└─ models/
   ├─ community/
   ├─ official/
   ├─ orbit/
   └── …
</pre>



<h3>默认情况下，TensorFlow对象检测API使用Protobuf来配置模型和训练参数，因此我们需要这个库来继续。</h3>



<p>前往<a href="https://web.archive.org/web/20221206004728/https://github.com/protocolbuffers/protobuf/releases" target="_blank" rel="noreferrer noopener nofollow">官方协议发布页面</a>下载与您的操作系统和处理器架构兼容的最新protobuf版本的档案。</p>



<ul>
<li>比如我用的是<em> Ubuntu </em>。我的CPU是<em> AMD64 </em> (64位处理器)。当我写这篇文章时，最新的协议版本是<em> 3.13.0 </em>。鉴于所有这些信息，我将从官方协议发布页面下载<em>protocol-3 . 13 . 0-Linux-x86 _ 64 . zip</em>文件。</li>
</ul>



<p>在<code>Tensorflow</code>项目目录中，创建一个名为<code>protoc</code>的新文件夹。将下载的档案内容解压到<code>Tensorflow/protoc</code>目录。</p>



<ul>
<li>现在，您的<code>Tensorflow</code>目录结构应该如下所示:</li>
</ul>



<p>确保在你的<em>终端</em>窗口中，你位于<code>Tensorflow</code>目录中。要编译proto文件，请执行以下命令:</p>



<pre class="hljs">Tensorflow/
└─ protoc/
   ├─ bin/
   ├─ include/
   ├─ readme.txt
└─ tf2_api_env/
   ├─ bin/
   ├─ include/
   └── …
└─ models/
   ├─ community/
   ├─ official/
   ├─ orbit/
   └── …
</pre>







<p><strong> 5。安装COCO API </strong></p>



<pre class="hljs">protoc/bin/protoc models/research/object_detection/protos/*.proto
--python_out=.
</pre>



<h3>COCO API是一个不直接与对象检测API相关的依赖项。您应该单独安装它。手动安装COCO API引入了一些新功能(例如，一组流行的<a href="https://web.archive.org/web/20221206004728/https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/evaluation_protocols.md" target="_blank" rel="noreferrer noopener nofollow">检测或/和分割指标</a>可用于模型评估)。安装过程如下:</h3>



<p>如果您使用的是Windows:</p>



<p>确保在你的<em>终端</em>窗口中，你位于<code>Tensorflow</code>目录中。逐一运行以下命令:</p>



<ul>
<li>如果您使用的是Linux:</li>
</ul>



<pre class="hljs">pip install cython
pip install git+https://github.com/philferriere/cocoapi.git
</pre>



<p>确保在你的<em>终端</em>窗口中，你位于<code>Tensorflow</code>目录中。逐一运行以下命令:</p>



<ul>
<li>在这一步结束时，您的<code>Tensorflow</code>目录结构应该如下所示:</li>
</ul>



<pre class="hljs">pip install cython
git clone https://github.com/cocodataset/cocoapi.git
cd cocoapi/PythonAPI
make
cp -r pycocotools ./models/research/
</pre>



<p><strong> 6。对象检测API安装</strong></p>



<pre class="hljs">Tensorflow/
└─ cocoapi/
   ├─ common/
   ├─ LuaAPI/
   └── …
└─ protoc/
   ├─ bin/
   ├─ include/
   ├─ readme.txt
└─ tf2_api_env/
   ├─ bin/
   ├─ include/
   └── …
└─ models/
   ├─ community/
   ├─ official/
   ├─ orbit/
   └── …
</pre>



<h3>这是我们的安装和设置块的最后一步！我们将安装对象检测API本身。你可以通过安装<em> object_detection </em>包来实现。方法如下:</h3>



<p>确保在你的<em>终端</em>窗口中，你位于<code>Tensorflow</code>目录中。</p>



<ul>
<li>使用<code>cd</code>命令将当前工作目录从<code>Tensorflow</code>更改为<code>Tensorflow/models/research</code></li>
</ul>



<ul>
<li>在您的<em>终端</em>窗口中逐一运行以下命令:</li>
</ul>



<ul>
<li><strong>注意:</strong><strong/>第二个命令可能会给你一个错误。一点也不担心。只需再运行一次，直到你看到一个完整的安装。</li>
</ul>



<pre class="hljs">cp object_detection/packages/tf2/setup.py .
python -m pip install .
</pre>



<p>在<em>终端</em>窗口的<code>Tensorflow/models/research</code>目录下运行以下命令，测试安装是否成功:</p>



<ul>
<li>一旦测试完成，您将在您的<em>终端</em>窗口中看到一条打印出来的消息。如果所有20个测试都运行了，并且它们的状态是“OK”(有些可能会被跳过，这完全没问题)，那么您就完成了安装！</li>
</ul>



<pre class="hljs">python object_detection/builders/model_builder_tf2_test.py</pre>



<p>工作量很大，所以恭喜你！干得好！</p>





<p>数据准备</p>



<h2 id="h-data-preparation">当您完成所有安装步骤时，您需要考虑稍后将输入到自定义对象检测模型中的数据。</h2>



<p>基于TensorFlow对象检测API的模型需要一种特殊的格式用于所有的输入数据，称为<a href="https://web.archive.org/web/20221206004728/https://www.tensorflow.org/tutorials/load_data/tfrecord" target="_blank" rel="noreferrer noopener nofollow"> <em> TFRecord </em> </a>。我们将讨论如何将您的数据转换成<em> TFRecord </em>格式(为了更好地理解什么是<em> TFRecord </em>格式，我强烈推荐阅读<a href="https://web.archive.org/web/20221206004728/https://medium.com/mostly-ai/tensorflow-records-what-they-are-and-how-to-use-them-c46bc4bbb564" target="_blank" rel="noreferrer noopener nofollow">这篇文章</a>)，但是首先让我们讨论一些关于您的数据可用性及其注释的假设。具体来说，我们假设:</p>



<p>您已经<strong>收集了数据(图像)</strong>用于模型训练、验证和测试，</p>



<ul>
<li>您的<strong>图像被注释用于对象检测</strong>，这意味着您的数据集中可能出现的所有感兴趣对象的区域被手动定义为边界框，并且为每个框设置了基本事实标签。</li>



<li>如果这些假设对你来说是错误的，你将无法继续进行你的物体检测创作。很简单:没有数据，没有模型。</li>
</ul>



<p>好消息是有许多公共图像数据集。我强烈建议花些时间搜索你感兴趣的数据集。很有可能你会找到值得你花时间去做的事情。</p>



<p>如果你需要注释，有<a href="https://web.archive.org/web/20221206004728/https://lionbridge.ai/articles/image-annotation-tools-for-computer-vision/" target="_blank" rel="noreferrer noopener nofollow">吨的解决方案</a>可用。挑一个你喜欢的。它们都会给你JSON或XML格式的注释。两者都适合我们的目的。</p>



<p>这里我不会在图像收集和注释上花太多时间——我希望您能够自己解决这个问题，这样我们就可以进入下一个重要步骤:数据转换。</p>



<figure class="wp-block-video aligncenter"><video autoplay="" controls="" loop="" muted="" src="https://web.archive.org/web/20221206004728im_/https://neptune.ai/wp-content/uploads/2022/11/image-annotation-process.mp4" playsinline=""/><figcaption class="wp-element-caption"><em>Image Annotation Process | Source: <a href="https://web.archive.org/web/20221206004728/https://lionbridge.ai/articles/image-annotation-tools-for-computer-vision/" target="_blank" rel="noreferrer noopener nofollow">Article by Rei Morikawa at lionbridge.ai</a></em></figcaption></figure>



<p> </p>



<p id="separator-block_ba5e4c76a015358a674b54b7ced9632f" class="block-separator block-separator--5"><strong>数据转换</strong></p>



<h3>我提到过您的输入数据需要<em> TFRecord </em>格式。这一步的目标是将每个数据集(训练、验证和测试)转换成<em> TFRecord </em>格式。</h3>



<p>为了确保可比性，让我们在您的<code>Tensorflow</code>目录中创建一个名为<code>workspace</code>的子文件夹。我们将使用<code>workspace</code>文件夹来存储所有与模型相关的属性，包括数据。</p>



<p>为了存储所有的数据，让我们在<code>Tensorflow/workspace</code>中创建一个名为<code>data</code>的单独文件夹。我们最终得到的所有转换后的数据集都将被放置在<code>Tensorflow/workspace/data</code>中。</p>



<p>在这一步结束时，您的<code>Tensorflow</code>目录将如下所示:</p>



<p>现在回到数据转换。使用流行的图像注释工具创建的大多数注释文件都有两种格式:JSON或XML。</p>



<pre class="hljs">Tensorflow/
└─ cocoapi/
└─ protoc/
└─ tf2_api_env/
└─ models/
└─ workspace/
   └─ data/
      ├─ train.record
      ├─ validation.record
      ├─ test.record
</pre>



<p>弄清楚你的数据有什么格式的注释。你需要它来选择一个合适的工具来转换到<em> TFRecord </em>。</p>



<p><strong>选项#1: </strong>您的注释是JSON格式的。我的建议是:</p>



<p><strong>选项#2: </strong>你的注释采用的格式类似于COCO、Kitti或Pascal等流行数据集所采用的格式(注意:Pascal注释采用的是我们已经知道的XML格式，并且之前在<strong>选项#1 </strong>中使用过)。在这种情况下，我建议你:</p>







<p> </p>







<p id="separator-block_ba5e4c76a015358a674b54b7ced9632f" class="block-separator block-separator--5"><strong>标签地图创建</strong></p>



<h3>标签地图是一种简单的。txt文件(。确切的说是pbtxt)。它将标签链接到一些整数值。TensorFlow对象检测API需要此文件来进行训练和检测。</h3>



<p>为了理解如何创建这个文件，让我们看一个简单的例子，其中我们只想检测两个类:汽车和自行车。别的都不重要，就这两个物件。让我们看看<code>label_map.pbtxt</code>对于这样一个任务会是什么样子:</p>



<p>现在您知道如何创建自己的标注地图了。选择您选择的文本编辑器(或IDE)(我使用了<a href="https://web.archive.org/web/20221206004728/https://atom.io/" target="_blank" rel="noreferrer noopener nofollow"> atom </a>，并创建一个标签映射文件，该文件反映了您将使用未来对象检测器检测的类的数量。给所有的类起一个有意义的名字，这样你就可以很容易的理解和区分它们。</p>


<div class="wp-block-image">
<figure class="aligncenter size-large"><img decoding="async" src="../Images/e0d3cda21ca069e74ff0fe783028fd83.png" alt="label map file" class="wp-image-28892" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20221206004728im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/label-map-file.png?ssl=1"/><figcaption class="wp-element-caption"><em>Example of a label map file for two classes: car and bike</em></figcaption></figure></div>


<p>完成后，将新创建的<code>label_map.pbtxt</code>放入<code>Tensorflow/workspace/data</code>目录。你的<code>Tensorflow/workspace/data</code>目录现在应该包含4个文件:</p>



<p><code>train.record</code>，</p>



<ul>
<li><code>validation.record</code>，</li>



<li><code>test.record</code>，</li>



<li><code>label_map.pbtxt</code>。</li>



<li>数据准备到此为止！你向你的物体探测器又迈进了一大步。每一个机器学习项目最本质(可以说)的部分都完成了。您已经有了数据，并准备好输入到您的模型中。</li>
</ul>



<p>接下来，我们将继续模型架构的选择和配置。继续前进！</p>





<p> </p>



<p id="separator-block_ba5e4c76a015358a674b54b7ced9632f" class="block-separator block-separator--5">型号选择和配置</p>



<h2 id="h-model-selection-and-configuration">在教程的这一部分，我们要做两件事:</h2>



<p>首先，<strong>选择一个要使用的模型架构</strong>。幸运的是，有很多选择，而且都很棒。</p>



<ul>
<li>第二，我们将致力于<strong>模型配置</strong>，因此它可以处理期望的任务，高效，在您可能经历的资源限制下工作，并且具有足够好的概括能力以用于现实世界。</li>



<li>这是我最喜欢的部分之一，因为这是机器学习开始的地方！我们开始吧！</li>
</ul>



<p> </p>



<p id="separator-block_ba5e4c76a015358a674b54b7ced9632f" class="block-separator block-separator--5"><strong>型号选择</strong></p>



<h3>TensorFlow对象检测API最酷的功能之一是有机会与一组先进的模型一起工作，这些模型是在COCO数据集上预先训练的！我们可以根据我们的目的微调这些模型，并获得很好的结果。</h3>



<p>现在，您需要选择并下载模型:</p>





<p>单击您选择的型号名称开始下载。</p>







<ul>
<li>在<code>Tensorflow/workspace/</code>目录中，创建一个名为<code>pre_trained_models</code>的新文件夹，并将下载的模型解压到这个新创建的目录中。</li>
</ul>



<ul>
<li>如果你想用不同的架构训练多个模型，然后比较它们的性能来选择一个胜出的模型(听起来是个好主意！)，您现在应该下载这些模型并将它们全部解压缩到<code>pre_trained_models</code>目录。</li>
</ul>



<ul>
<li>现在，您的项目目录应该如下所示:</li>
</ul>



<p> </p>



<pre class="hljs">Tensorflow/
└─ cocoapi/
└─ protoc/
└─ tf2_api_env/
└─ models/
└─ workspace/
   └─ data/
   └─ pre_trained_models/
      ├─ &lt;folder <span class="hljs-keyword">with</span> the <span class="hljs-number">1</span>st model of your choice&gt;
      ├─ &lt;folder <span class="hljs-keyword">with</span> the <span class="hljs-number">2</span>nd model of your choice&gt;
      ├─ …
      ├─ &lt;folder <span class="hljs-keyword">with</span> the N model of your choice&gt;

</pre>



<p id="separator-block_ba5e4c76a015358a674b54b7ced9632f" class="block-separator block-separator--5"><strong>车型配置介绍</strong></p>



<h3>我们下载并提取了一个预先训练好的模型。现在我们要对它进行配置。我们想这么做可能有多种原因。让我给你举几个例子，这样你就能明白为什么配置是必不可少的:</h3>



<p>您的问题域和您的数据集与用于训练原始模型的不同:您需要一个<strong>自定义对象检测器</strong>(可能是您阅读本文的原因)，</p>



<ul>
<li>您有不同数量的对象类别要检测，</li>



<li>您尝试检测的对象可能与预训练模型应该检测的对象完全不同，</li>



<li>你可能有较少的计算能力来训练一个模型，这也应该被考虑在内。</li>



<li>所以你明白为什么你需要配置你的模型了。原因不胜枚举，但让我们继续前进。我们稍后会用一个真实的例子详细讨论它。</li>
</ul>



<p>现在，我希望大家记住，模型配置是一个让我们定制模型相关工件(例如超参数、损失函数等)的过程，以便可以对其进行训练(微调)来处理我们感兴趣的对象的检测。就是这样。</p>



<p>TensorFlow对象检测API允许通过预训练模型附带的<code>pipeline.config</code>文件进行模型配置。</p>



<p> </p>



<p id="separator-block_ba5e4c76a015358a674b54b7ced9632f" class="block-separator block-separator--5"><strong>项目目录组织</strong></p>



<h3>在进入模型配置之前，让我们首先组织我们的项目目录。这是帮助我们保持整个项目结构整洁和易于理解的重要一步。</h3>



<p>我们现在想要创建另一个目录，用于存储与不同模型架构及其配置相关的文件。</p>





<p>你可能会问:</p>



<p>“等等，安东，我们已经有了模型架构的<code>pre_trained_models</code>文件夹！我们究竟为什么不用它？”</p>



<p>这是一个公平的观点，但我的个人经验引导我找到了一个不同的、更干净的解决方案。相信我，最后你会喜欢的！你需要做的是:</p>



<p>转到<code>Tensorflow/workspace</code>并创建一个名为<code>models</code>的新目录。</p>



<ul>
<li>在<code>Tensorflow/workspace/models</code>中，创建另一个目录，其名称对应于您决定使用的模型架构(您下载到<code>Tensorflow/workspace/pre_trained_models</code>的那些模型)。</li>
</ul>



<ul>
<li>例如，我想训练一个基于EfficientDet架构的对象检测器。我注意到在<a href="https://web.archive.org/web/20221206004728/https://github.com/tensorflow/models/blob/master/research/object_detection/g3doc/tf2_detection_zoo.md" target="_blank" rel="noreferrer noopener nofollow"> TF 2检测模型Zoo </a>页面有多个EfficientDets可用，它们有不同的深度(从D0到D7，更多信息可以在<a href="https://web.archive.org/web/20221206004728/https://arxiv.org/abs/1911.09070" target="_blank" rel="noreferrer noopener nofollow">这里</a>找到)。</li>
</ul>



<p>我想我会首先使用最基本的一个，即<a href="https://web.archive.org/web/20221206004728/http://download.tensorflow.org/models/object_detection/tf2/20200711/efficientdet_d0_coco17_tpu-32.tar.gz" target="_blank" rel="noreferrer noopener nofollow"> EfficientDet D0 512×512 </a>，但后来也尝试了<a href="https://web.archive.org/web/20221206004728/http://download.tensorflow.org/models/object_detection/tf2/20200711/efficientdet_d1_coco17_tpu-32.tar.gz" target="_blank" rel="noreferrer noopener nofollow"> EfficientDet D1 640×640 </a>，它更深入，可能会获得更好的性能。因此，在我的例子中，我需要创建两个文件夹:<code>efficientdet_d0</code>和<code>efficiendet_d1</code>。</p>



<p>目录名的选择由你决定。重要的是为您想要使用的每个模型架构创建一个目录，并且在文件夹的名称中包含模型架构信息。就是这样。</p>



<p>到目前为止，您的项目目录结构应该类似于以下内容:</p>



<p>转到<code>Tensorflow/workspace/pre_trained_models</code>并打开包含您想要配置的模型的目录</p>



<pre class="hljs">Tensorflow/
└─ ...
└─ workspace/
   └─ data/
   └─ pre_trained_models/
   └─ models/
      ├─ &lt;folder <span class="hljs-keyword">with</span> the <span class="hljs-number">1</span>st model of your choice&gt;
      ├─ &lt;folder <span class="hljs-keyword">with</span> the <span class="hljs-number">2</span>nd model of your choice&gt;
      ├─ …
      ├─ &lt;folder <span class="hljs-keyword">with</span> the N model of your choice&gt;	</pre>



<ul>
<li>在那里寻找<code>pipeline.config</code>文件。将该文件复制到<code>Tensorflow/workspace/models/&lt;folder with the model of your choice&gt;/v1/</code>内的相应文件夹中(您需要创建<code>v1</code>文件夹。我稍后会解释它的用途)。</li>
</ul>



<ul>
<li>复制后，使用文本编辑器或您选择的IDE从<code>Tensorflow/workspace/models/&lt;folder with the model of your choice&gt;/v1/</code>打开<code>pipeline.config</code>文件。打开后，您应该会看到类似这样的内容:</li>
</ul>



<ul>
<li>现在您已经准备好开始进行模型配置了！下一节将解释如何正确地做到这一点。</li>
</ul>


<div class="wp-block-image">
<figure class="aligncenter size-large"><img decoding="async" src="../Images/70010339fde0a076e6911590b2a4b31a.png" alt="opened pipeline" class="wp-image-28898" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20221206004728im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/opened-pipeline.png?ssl=1"/><figcaption class="wp-element-caption"><em>Example of an opened pipeline.config file for EfficientDet D1</em></figcaption></figure></div>


<p>除了适当的文件夹和命名结构之外，对组织使用<a href="https://web.archive.org/web/20221206004728/https://docs.neptune.ai/how-to-guides/experiment-tracking/organize-ml-experiments" target="_blank" rel="noreferrer noopener">实验跟踪工具</a>也有助于保持整洁。</p>



<section id="blog-intext-cta-block_9f4286ee46873be585e424871cb9fbe3" class="block-blog-intext-cta  c-box c-box--default c-box--dark c-box--no-hover c-box--standard ">

            
    
            <p> </p>
    
    </section>



<p id="separator-block_ba5e4c76a015358a674b54b7ced9632f" class="block-separator block-separator--5">配置过程:基础</p>



<h3>我决定将模型配置过程分为两个部分。</h3>



<p>首先，我们来看看基础知识。我们将触及一组需要配置的最小参数，以便开始训练并获得结果……一个<strong>基线结果。</strong></p>



<p>使用这种方法，开始工作非常容易，但是会牺牲最终模型的性能。这将是完全可行的，但不会尽如人意。</p>



<p><strong>第二步，我们将重点调整</strong>各种可用的模型参数。我将为您提供一个框架，您可以使用它来调整您想要的每个模型参数。</p>



<p>你将有很大的权力来控制模型配置，并且能够使用不同的设置来进行测试，并获得最佳的模型性能。</p>



<p>听起来很刺激？是啊，它是！让我们开始吧。</p>



<p>查看您之前从<code>Tensorflow/workspace/models/&lt;folder with the model of your choice&gt;/v1/</code>打开的<code>pipeline.config</code>文件。无论您决定使用哪种型号，您的基本配置都应符合以下型号参数:</p>



<p><code>num_classes</code> (int)。您必须提供您的模型将要检测的类的准确数量。默认情况下，它等于90，因为预训练模型应该用于COCO数据集中的90个对象。</p>



<ul>
<li><em>数量_类别参数。效率检测D1 </em>的例子</li>
</ul>



<figure class="wp-block-image is-resized"><img decoding="async" loading="lazy" src="../Images/9aa606cf6a4e004a112c31a58ee8769c.png" alt="code" data-original-src="https://web.archive.org/web/20221206004728im_/https://lh5.googleusercontent.com/EfSTjgEafgbkXkmFT6_eUdXGM2uD0Sx7EIFuVvBsr9lj8CJFw2wDYuXnM62acxZZAjDVmPlwU_jJnSTksXQOcsymSc06BCOosjUjMbycK5GFGNVDqLXquW7A7W6DaBcfFUroX0ln"/></figure>



<p class="has-text-align-center"><code>batch_size</code> (int，必须能被2整除)。这个值应该根据您有多少可用内存来设置。请记住，批量越大，您的机器/GPU需要的内存就越多。如果你不知道最初该用哪个数字，我建议从<code>batch_size</code> = 8开始</p>



<ul>
<li><strong>注意:</strong> <code>batch_size</code>参数需要在<code>pipeline.config</code>文件内的两个地方设置:在<code>train_config</code>和<code>eval_config</code>(见下图)</li>
</ul>



<p><em>train _ config中的batch_size参数效率检测D1 </em>的例子</p>



<figure class="wp-block-image"><img decoding="async" src="../Images/be4c481fb4c87ae948d72431680ff842.png" alt="code" data-original-src="https://web.archive.org/web/20221206004728im_/https://lh3.googleusercontent.com/lMcDRJdBqHAXNhgltW-VjLsto8NeKX3mZNBdkY2cXiQ9g0ae-dgYrzY27rL-kH6QMuOeabCRCsl9kS1ab3A37n5-dcFO4_35atGKI0gxQbVUbdEQG2SBDuEs2dv3CIYO4I2ulGVn"/></figure>



<p class="has-text-align-center"><em>eval _ config中的batch_size参数。效率检测D1 </em>的例子</p>



<figure class="wp-block-image"><img decoding="async" src="../Images/f34f9d3fa2446b686f6d70686465d889.png" alt="code" data-original-src="https://web.archive.org/web/20221206004728im_/https://lh6.googleusercontent.com/d8IN7qBkkLSHzPOUqRGuyMdjP2KhSr_T8Tvka0XtWtXrhjzhXz5eA1iNudEQ7h2mL_P-nYlwJUSKK9TU7MJ5wKMBZhqm6pFjO0zH6conHT4wrW_c797bkwgciAyvXF8Ug-OdzETP"/></figure>



<p class="has-text-align-center">对于<code>eval_config</code>你必须用1。对于<code>train_confid</code>,使用我上面描述的逻辑。</p>



<p>微调检查点。这里是您提供预训练模型检查点的路径的地方。</p>



<ul>
<li>善意提醒，你需要的关卡位于<code>Tensorflow/workspace/pre_trained_models/&lt;folder with the model of your choice&gt;/checkpoint/ckpt-0</code>。</li>
</ul>



<p>只需将<code>&lt;folder with the model of your choice&gt;</code>替换为预训练模型所在文件夹的名称。</p>



<p><code>fine_tune_checkpoint_type</code> (str)。该字段应设置为<code>detection</code>，因为我们想要训练一个检测模型。</p>



<ul>
<li><code>use_bfloat16</code>(布尔)。如果您不打算在TPU上训练模型，该字段应设置为<code>false</code>。否则设置为<code>true</code>。</li>



<li><code>label_map_path</code> (str)。在这里，您可以提供一个到先前创建的<code>label_map.pbtxt</code>的路径。</li>



<li>另一个善意的提醒:我们把<code>label_map.pbtxt</code>放到了<code>Tensorflow/workspace/data</code>目录下。</li>
</ul>



<p><strong>注意:</strong> <code>label_map_path</code>参数需要在<code>pipeline.config</code>文件中的两个地方设置:在<code>train_input_reader</code>和<code>eval_input</code>阅读器中(见下图)</p>



<p><em>train _ input _ reader内的label_map_path参数。效率检测D1 </em>的例子</p>



<figure class="wp-block-image"><img decoding="async" src="../Images/89b8491da8fd17b5dfdc994fc9aff1cf.png" alt="code" data-original-src="https://web.archive.org/web/20221206004728im_/https://lh3.googleusercontent.com/bRJcpYPtPuWW7UMeRpJlc3l9iPM9UB2WjQ0n9CEyLYErJCz4-FxMpJEzqdDl1ZmL-E2ehaKHLpbVMtDhEqZmufHdZDhW_ir4OaZYb4YmxjFHiFhXMiK7VudWzrMNInkp_O-W_SOV"/></figure>



<p class="has-text-align-center"><em>eval _ input _ reader内的label_map_path参数。效率检测D1 </em>的例子</p>



<figure class="wp-block-image"><img decoding="async" src="../Images/b6b03366b929055edbbd865ac634324d.png" alt="code" data-original-src="https://web.archive.org/web/20221206004728im_/https://lh6.googleusercontent.com/66poJ7IPG386ZJuNWHsSxbbfE073bkNgZ0KZWdQen6qDWr6gw7v992xKCeAiF7rPJrYM5xheHKvKR6U_ROcjHbkO8FMR7G3u2shUq0dmCZfF9y93l1slxhCa919NFMEZ61N8aQ97"/></figure>



<p class="has-text-align-center"><code>input_path</code> (str)。在这里，您提供了一个到您之前创建的<code>train.record</code>和<code>validation.record</code>的路径。您可能已经猜到，到<code>validation.record</code>的路径应该设置在<code>eval_input_reader</code>内，而到<code>train.record</code>的路径应该设置在<code>train_input_reader</code>内。</p>



<ul>
<li>我最后善意的提醒:我们还将所有的<code>.record files</code>放在了<code>Tensorflow/workspace/data</code>目录中。</li>
</ul>



<p><strong>我们刚刚完成基本配置</strong>，这是开始训练您的自定义对象检测器所必需的。很难吗？绝对不会。只要多行修改，你就可以开始了。</p>



<p>您可能已经注意到，与我们在基本配置过程中使用的几行相比，<code>pipeline.config</code>文件要长得多。配置空间大吗？绝对是！让我们看看还能做些什么来使我们的模型更健壮。</p>



<p> </p>



<p id="separator-block_ba5e4c76a015358a674b54b7ced9632f" class="block-separator block-separator--5"><strong>配置过程:高级</strong></p>



<h3>如何调整配置文件中的其他参数？</h3>



<p>我应该尝试哪些参数值？</p>



<p>在哪里以及如何阅读关于参数及其含义的更多信息？</p>



<p>这些是我在开始使用TensorFlow对象检测API时遇到的问题。</p>





<p>如果你也觉得不清楚，不要担心！幸运的是，有一种通用的方法可以用于参数调整，我发现它非常方便易用。</p>



<p>让我用一个真实的例子向你展示它是怎么回事！</p>



<p>假设您在<code>pipeline.config</code>文件中看到一个默认的分类损失函数(对于D1效率检测器来说是<code>weighted_sigmoid_focal</code>)。定义为<code>classification_loss</code>参数)是你认为不是最优的，你想寻找其他可用的选项。</p>



<p><em>pipeline . config中定义损失函数的行。效率检测D1 </em>的例子</p>



<figure class="wp-block-image"><img decoding="async" src="../Images/8a393f6e942791031967f1861319d889.png" alt="" data-original-src="https://web.archive.org/web/20221206004728im_/https://lh3.googleusercontent.com/QZHvmz0W9RhPDxSmkRfysO2n9NCXQDusot3B3irzfEQ0pzL88C1TJst7TdwPMUP5recpuMZMOafq3H48KI3EXc2SiKqYIyIqLK9dTmTawXaDOcYLvxFzXlRpQK6osleEn4eHv-Zu"/></figure>



<p class="has-text-align-center">以下是你寻找其他可用选项的方法:</p>



<p>根据以下请求模式进行搜索:</p>






<div class="wp-block-image">
<figure class="aligncenter size-large"><img decoding="async" src="../Images/bce11c37356b9e3a36ed9468c67d61dd.png" alt="" class="wp-image-28858" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20221206004728im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/tensorflow-api.png?ssl=1"/><figcaption class="wp-element-caption"><em>Place of the search window on the official TensorFlow API GitHub page</em></figcaption></figure></div>


<ul>
<li>至于我们的例子，我们的<strong> <code>parameter_name</code> </strong>就是<strong> <code>classification_loss</code> </strong>。你需要从<code>pipeline.config</code>文件中粘贴一个精确的参数名。在我们的示例中，您的搜索请求如下:</li>
</ul>



<pre class="hljs">parameter_name path:research/object_detection/protos
</pre>



<p>浏览搜索结果，寻找最能描述我们请求的参数(<strong> <code>classification_loss</code> </strong>)的一个。</p>


<div class="wp-block-image">
<figure class="aligncenter size-large"><img decoding="async" src="../Images/485a361163490003175d51529b73c808.png" alt="tensorflow api search request" class="wp-image-28861" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20221206004728im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/tensorflow-api-search-request.png?ssl=1"/><figcaption class="wp-element-caption"><em>Example for a search request if we would like to change classification loss</em></figcaption></figure></div>


<ul>
<li>单击最能描述您所请求参数的文件的链接(如上图所示，我们的目标文件可能是<a href="https://web.archive.org/web/20221206004728/https://github.com/tensorflow/models/blob/8518d053936aaf30afb9ed0a4ea01baddca5bd17/research/object_detection/protos/losses.proto" target="_blank" rel="noreferrer noopener nofollow">research/object _ detection/protos/loss . proto</a>)，然后等待加载包含该文件的页面。</li>
</ul>


<div class="wp-block-image">
<figure class="aligncenter size-large"><img decoding="async" src="../Images/64bf66366c8fcc7c2d98df07c96ab3fc.png" alt="api search results" class="wp-image-28863" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20221206004728im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/api-search-results.png?ssl=1"/><figcaption class="wp-element-caption"><em>Example of search results for a given query</em></figcaption></figure></div>


<ul>
<li>加载时，只需使用<a href="https://web.archive.org/web/20221206004728/https://www.howtogeek.com/671304/how-to-quickly-search-for-text-on-the-current-web-page/#:~:text=Press%20Ctrl%2BF%20(on%20Windows,right%20corner%20of%20the%20window." target="_blank" rel="noreferrer noopener nofollow">常规浏览器搜索</a>找到我们想要的参数(<strong> <code>classification_loss</code> </strong>)所在的一行代码。当我这样做时，我发现了下面这段代码:</li>
</ul>



<ul>
<li>从上面的代码片段中可以得出以下结论:</li>
</ul>


<div class="wp-block-image">
<figure class="aligncenter size-large"><img decoding="async" src="../Images/c191c3aa475036467ef808f805accc51.png" alt="parameters code" class="wp-image-28865" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20221206004728im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/parameters-code.png?ssl=1"/><figcaption class="wp-element-caption"><em>Piece of code that shows the options for a parameter we interested in</em></figcaption></figure></div>


<p><strong> &gt; </strong> <strong> <code>classification_loss</code> </strong>是一个参数，它可以是在<br/> <strong> &gt; </strong>上面的图像上列出的(<code>oneof</code>)6个预定义选项中的一个。</p>



<p>当您找到您的参数值时，只需将它复制到您的<code>pipeline.config</code>文件中的相应行。例如，我决定使用<code>weighted_sigmoid</code>损失进行分类，而不是默认的<code>weighted_sigmoid_focal</code>。为此，我在我的<code>pipeline.config</code>文件中做了一个更改，现在定义分类损失的行如下所示:</p>



<ul>
<li>这就是了。您可以使用这种方法来调整您选择的每个参数。现在，您拥有了一种超能力来定制您的模型，使它完全按照您想要的方式运行。是不是很牛逼？绝对是。恭喜你！</li>
</ul>


<div class="wp-block-image">
<figure class="aligncenter size-large"><img decoding="async" src="../Images/3c8ce4dbab69157d850cf6fab3124270.png" alt="classification loss code" class="wp-image-28867" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20221206004728im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/classification-loss-code.png?ssl=1"/><figcaption class="wp-element-caption"><em>Here is how lines for classification_loss look like after a change is made.</em></figcaption></figure></div>


<p>模特培训</p>









<h2 id="h-model-training">为了走到这一步，我们做了很多工作。现在我们已经准备好开始训练了。下面是如何做到这一点:</h2>



<p>您需要将提供的python脚本从<code>Tensorflow/models/research/object_detection/model_main_tf2.py</code>复制到<code>Tensorflow/workspace/model_main_tf2.py</code>进行训练</p>



<ul>
<li>打开一个新的<em>终端</em>窗口，将<code>Tensorflow/workspace/</code>作为你当前的工作目录。</li>
</ul>



<ul>
<li>使用以下命令启动培训作业:</li>
</ul>



<ul>
<li>其中:</li>
</ul>



<pre class="hljs">python model_main_tf2.py
  --pipeline_config_path=&lt;path to your config file&gt;
  --model_dir=&lt;path to a directory <span class="hljs-keyword">with</span> your model&gt;
  --checkpoint_every_n=&lt;int <span class="hljs-keyword">for</span> the number of steps per checkpoint&gt;
  --num_workers=&lt;int <span class="hljs-keyword">for</span> the number of workers to use&gt;
  --alsologtostderr
</pre>



<p><strong> &gt; </strong> <strong> <code>&lt;path to your config file&gt;</code> </strong>是当前培训作业要使用的配置文件的路径。应该是来自的配置文件。/models/ &lt;文件夹与您选择的模型&gt;/v1/<br/><strong>&gt;</strong><strong><code>&lt;path to a directory with your model&gt;</code></strong>是一个目录的路径，您的所有未来模型属性将放置在该目录中。也应该是下面的:。/models/ &lt;包含您选择的模型的文件夹&gt;/v1/<br/><strong>&gt;</strong><strong><code>&lt;int for the number of steps per checkpoint&gt;</code></strong>是一个整数，它定义了创建模型检查点需要按顺序完成多少个步骤。请记住，当进行单个步骤时，您的模型处理的图像数量等于您为训练定义的batch_size。<br/><strong>&gt;</strong><strong><code>&lt;int for the number of workers to use&gt;</code></strong>如果您有一个多核CPU，该参数定义了可用于训练作业的核心数量。</p>



<p>在您执行上述命令之后，您的培训工作将开始。值得一提的是，如果你要使用GPU进行训练，你所有的GPU都会参与进来。如果您希望仅涉及选定的GPU，请在启动培训作业脚本之前执行以下命令<strong>:</strong></p>



<p>其中<gpus>根据订单编号定义要使用的GPU。比如我有两个GPU。第一个订单编号为0，第二个订单编号为1。如果我想在我的第0个GPU上训练一个模型，我执行以下命令:</gpus></p>



<pre class="hljs">export CUDA_VISIBLE_DEVICES= &lt;GPUs&gt;</pre>



<p>如果我想在我的两个GPU上训练，我使用以下命令:</p>



<pre class="hljs">export CUDA_VISIBLE_DEVICES=<span class="hljs-number">0</span></pre>



<p>如果我决定只使用CPU来训练我的模型，我的命令应该是这样的:</p>



<pre class="hljs">export CUDA_VISIBLE_DEVICES=<span class="hljs-number">0</span>,<span class="hljs-number">1</span>
</pre>



<p>现在，你该躺下来放松一下了。剩下的工作就交给电脑了！</p>



<pre class="hljs">export CUDA_VISIBLE_DEVICES=<span class="hljs-number">-1</span></pre>



<p>最后的想法</p>





<h2 id="h-final-thoughts">这是一次漫长的旅行，不是吗？现在你有知识和实践技能来进口，定制和培训任何物体探测器你想要的。</h2>



<p>TensorFlow对象检测API是一个很好的工具，我很高兴您现在已经完全可以使用它了。让我们简要回顾一下我们所做的工作:</p>



<p>我们从需要启动的<strong>初始安装和设置</strong>开始:我们安装了所有的依赖项，组织了项目目录，启用了GPU支持。</p>



<ol>
<li>然后我们继续进行<strong>数据准备</strong>，了解TFRecords并将我们的数据转换成这种格式。我们还利用标签映射将类与其名称联系起来。</li>



<li>然后我们进入<strong>模型选择</strong>并决定我们想要使用什么模型架构。现在我们知道每个模型都可以通过我们熟悉的<strong>配置文件</strong>进行定制。</li>



<li>最后，我们直接进入培训工作，根据我们准备的配置，<strong>启动了模型培训</strong>。</li>



<li>如果你一直做到最后，那就干得好！我希望你觉得这篇文章有趣并且有用。</li>
</ol>



<p>在即将到来的<a href="/web/20221206004728/https://neptune.ai/blog/tensorflow-object-detection-api-best-practices-to-training-evaluation-deployment" target="_blank" rel="noreferrer noopener">第二篇</a>中，我会讲到更酷的东西！特别是，我们将回答以下问题:</p>



<p>如何为您的模型启动评估作业，并检查其随时间推移的性能？</p>



<ul>
<li>跟踪结果和比较不同模型配置的实验的最便捷方式是什么？</li>



<li>如何进一步提高模型质量及其性能？</li>



<li>如何克服可能出现的问题？</li>



<li>如何导出一个训练好的模型以便用于推理？</li>



<li>How to export a trained model in order to use it for inference?</li>
</ul>
        </div>
        
    </div>    
</body>
</html>