# 功能存储:数据科学工厂的组件[指南]

> 原文：<https://web.archive.org/web/https://neptune.ai/blog/feature-stores-components-of-a-data-science-factory-guide>

低效而昂贵的[特性工程](https://web.archive.org/web/20221206074029/https://towardsdatascience.com/feature-engineering-for-machine-learning-3a5e293a5114)实践经常困扰着处理大量数据的公司。这使得他们无法组织复杂的机器学习操作。为 ML 目的获取数据花费了大量时间，但是不清楚模型的摄取和服务之间是否有任何不一致。

由于这种缓慢的过程和无法再现的结果，项目利益相关者可能会对积极的 ML 结果失去信任。怎么才能避免这种情况呢？

功能商店是答案的一部分。这是数据科学基础设施的重要组成部分，旨在为最终用户建立稳定的渠道。

## 什么是功能商店？

要素存储是一种接收大量数据、计算要素并存储它们的服务。有了功能商店，[机器学习管道](https://web.archive.org/web/20221206074029/https://valohai.com/machine-learning-pipeline/)和在线应用程序可以轻松访问数据。

作为双数据库实施，要素存储旨在提供实时数据和批处理数据:

*   在线要素商店以低延迟为在线应用程序提供数据。例子有 MySQL Cluster，Redis，Cassandra DB 等。
*   离线特征存储是向外扩展的 SQL 数据库，为开发人工智能模型提供数据，并使特征治理在可解释性和透明度方面成为可能。例子包括 Hive、BigQuery、Parquet。

### 功能存储与数据湖和数据仓库

在抽象层次上，特征存储提供了数据湖功能的子集。特征存储专门用于存储机器学习应用的特征，而数据湖是特征之外的数据的集中存储库，也用于分析目的。另一方面，数据仓库为关系数据库提供了一个模式，业务分析师可以使用该模式通过编写 SQL 查询来生成报告、仪表板等。

### 与特征工程相关的问题

*   ***特性定义的动态性:*** 一个特定的特性可能在组织内的多个团队中有不同的定义。如果没有适当的文档，维护特性背后的逻辑和它所传达的信息会变得越来越困难。特征存储通过维护与特征相关联的事实定义来帮助解决这个问题。这使得数据的最终用户更容易使用，并保持从该数据得出的结果的一致性。
*   ***特征冗余:*** 当数据必须以原始形式获取时，数据科学家花费大量时间重新提取可能已经被团队中的其他人或当前使用数据的管道提取的特征。由于要素存储提供了单一的事实来源，数据科学家可以在要素工程上花费更少的时间，而在实验和构建上花费更多的时间。
*   ***实验和生产环境之间的差距:*** 产品通常使用少量的编程语言和框架，这些语言和框架可能与用于实验机器学习模型的工具不同。这种差距会导致可能被忽略的不一致，并最终恶化客户端的模型/产品。换句话说，开发中模型的预期行为/性能在产品中部署时应该或多或少是可再现的。对于功能存储，这种转换是不必要的，因为它们保持了实验和生产之间的一致性。

### ML 管线中特征存储的优势

来自特性库的输出是**与实现无关的**。无论我们使用哪种算法或框架，应用程序/模型都将以一致的格式获取数据。使用特征库的另一个主要好处是**节省了原本要花费在计算特征上的时间**。

### 功能存储的组件

*   ***功能注册:*** 功能注册提供了一个中央界面，数据消费者(例如数据科学家)可以使用该界面来维护功能列表及其定义和元数据。这个中央存储库可以根据您的需要进行更新。
*   ***运营监控:*** 机器学习模型在初始阶段可能表现良好，但你仍然必须监控它们的正确性和随着时间推移的可靠结果。在机器学习模型中，自变量和因变量之间总有可能存在退化关系。这主要是由于输入数据的复杂性，因此随着时间的推移，预测变得更加不稳定和不准确。这种现象称为模型漂移，可以分为两种类型:
    *   *概念漂移:***目标**变量的统计性质随时间变化。
    *   *数据漂移:***预测器**变量的统计特性随时间变化。

要素存储维护数据质量和正确性。它为内部和外部应用程序/工具提供了一个接口，以确保生产中的正确模型性能。

*   ***转换:*** 在机器学习应用中，数据转换管道吸收原始数据，并将其转换为可用的特征。功能存储负责管理和编排它们。有三种主要的转换类型:
    *   *流*为有速度的数据(例如实时日志)，
    *   *批次*为平稳数据，
    *   *按需*对于无法预先计算的数据。
*   ***存储:*** 非即时需求的特性是离线的，通常存储在雪花、蜂巢、红移等仓库中。另一方面，在线功能是实时要求的，并存储在 MongoDB、CassandraDB 或 Elasticsearch 等数据库中，具有低延迟能力。
*   ***上菜:*** 特征提取和处理背后的逻辑是抽象的，这使得特征商店非常吸引人。当数据科学家出于实验目的访问数据快照(时间点)时，功能存储确保这些功能不断实时更新，并随时可供需要它们的应用程序使用。

## 功能存储和 MLOps

### 什么是 MLOps？

MLOps 是关于将 DevOps 原则应用于构建、测试和部署机器学习管道。通过 MLOps 实践，团队可以更频繁地部署更好的模型。MLOps 面临的挑战包括:

*   数据版本化，
*   管理专用硬件(GPU 等。),
*   管理模型的数据治理和合规性。

### MLOps 与 DevOps

传统上，开发人员使用 Git 对代码进行版本控制，这是自动化和持续集成(CI)所必需的。这使得自动再现环境变得容易。

每次提交 Git 都会触发包的自动创建，这些包可以使用版本控制中的信息进行部署。Jenkins 与版本控制软件一起用于构建、测试和部署代码，因此它以一种受控和可预测的方式运行。Jenkins 涉及的步骤有:

1.  虚拟机(VMs 容器的供应。
2.  在这些机器上读取代码。
3.  编译代码。
4.  运行测试。
5.  打包二进制文件。
6.  部署二进制文件。

MLOps 最重要的部分是版本化数据。你不能用 Git 做到这一点，因为它不能扩展到大量的数据。一个简单的机器学习管道包括以下内容:

*   已验证的传入数据。
*   特征计算。
*   生成培训和测试数据。
*   模型的训练。
*   模型的验证。
*   模型部署。
*   在生产中监控模型。

当您将超参数调整、模型可解释性和分布式训练添加到图片中时，这可能会变得更加复杂。

编排框架有助于自动工作流执行、模型再训练、组件之间的数据传递以及基于事件的工作流触发。这些框架包括:

*   tensor flow Extended(TFX)–支持气流、波束、库伯流管道
*   hopworks–支持气流
*   ml flow–支持 Spark
*   库伯流–支持库伯流管道

TFX、MLFlow 和 Hopsworks 支持使用 Beam 和 Spark 的分布式处理，支持在使用大量数据的集群上横向扩展执行。

### 机器学习管道

[DevOps CI/CD](https://web.archive.org/web/20221206074029/https://www.infoworld.com/article/3271126/what-is-cicd-continuous-integration-and-continuous-delivery-explained.html) 大多由源代码更新触发。MLOps 和 DataOps CI/CD 管道不仅可以由源代码更新触发，还可以由数据更新和数据处理触发:

*   DataOps 主要自动化数据管道的测试和部署，
*   MLOps 自动化了培训、验证和部署模型的过程。

对于端到端的机器学习管道，你需要非常谨慎的特征工程。这会占用你大部分的带宽。功能存储有两种帮助方式:

*   接收数据，验证数据，并将其转化为可消费的功能。
*   消耗这些数据的机器学习算法得到训练、验证并被推向生产。

机器学习管道的问题是它们有状态的本质。一个好的数据管道应该是无状态和幂等的。换句话说，在部署一个新模型(在验证阶段)之前，我们需要大量的信息，包括它的性能如何，我们做了什么假设，模型的影响，等等。通常，开发人员最终会一遍又一遍地重新编写代码，以正确定义输入和输出。

Hopsworks 提供了一种无干扰元数据模型，其中管道通过 Hopsworks API 读写 HDFS 并与要素存储进行交互。通过这种方式，我们可以存储元数据、工件、模型出处等，而无需像 TensorFlow Extended (TFX)或 MLFlow 所要求的那样重新编写代码。

一些行业最佳实践以及帮助我们实现这些实践的相关工具如下

*   单元测试和与 Jenkins 的持续集成。
*   使用 TFX 或 Deequ 进行数据验证，以便特性具有预期值。
*   使用 Deequ 测试唯一性、缺失性和独特性。
*   使用 TFX 或 Deequ 检查数据分布验证。
*   使用 Deequ 的特征和与目标变量之间的成对关系。
*   测量每个特性成本的自定义测试。
*   个人身份信息(PII)泄漏测试。

## 功能存储架构

### 优步的米开朗基罗机器学习平台

2017 年，优步推出了米开朗基罗作为人工智能即服务平台，以简化人工智能的扩展。随着不断增长的客户群和大量丰富数据的涌入，优步在其多个数据中心部署了米开朗基罗来运行他们的在线应用程序。这个平台是出于一种需要而诞生的。在米开朗基罗之前，数据科学家和工程师必须创建单独的预测模型和定制系统，这在扩大规模方面是不可持续的。

米开朗基罗建立在优步的基础设施之上，内部构建的组件是 HDFS、Spark、XGBoost 或 TensorFlow 等成熟开源框架的自举。它为所有事务性数据提供了一个数据湖。Kafka 经纪人被部署来聚合来自优步所有服务的数据，并通过 Samza 计算引擎与 Cassandra 集群进行流式传输。

该平台使用 Hive/HDFS 来存储优步的交易和日志数据。在线模型所需的特征被预先计算并存储在 CassandraDB 中，在预测时可以以低延迟读取这些特征。

为了进行特性选择、转换，并确保输入数据被检查格式是否正确以及是否遗漏，优步的开发人员构建了他们自己的领域特定语言(DSL)作为 Scala 的子集。有了它，最终用户可以添加他们自己的用户定义的功能。为了保证再现性，在训练和预测期间应用相同的 DSL 表达式。

米开朗基罗支持多种机器学习算法和深度学习网络的离线、大规模分布式训练，这使得它非常具有可扩展性。模型类型、超参数、数据源、DSL 表达式和计算资源要求作为模型配置提及。它还提供超参数搜索。

已配置的训练作业在 YARN 或 Mesos 集群上运行，之后会计算性能指标并编译成报告。运行分区模型时，训练数据会根据模型配置自动分区，并在相同的模型上进行训练。需要时使用父模型。关于最终模型的信息被存储在模型库中用于部署，并且报告被保存用于将来的分析。

培训工作可以通过米开朗基罗的 UI、API，甚至通过 Jupyter 笔记本来管理。

训练完成后，包含以下信息的版本化对象将存储在 CassandraDB 中:

1.  模型的作者，
2.  培训工作的开始和结束时间，
3.  车型配置，
4.  参考培训和测试数据，
5.  特征级统计，
6.  模拟性能指标，
7.  模型的学习参数，
8.  汇总统计数据。

### 谷歌的盛宴:开源功能商店

Feast 是一个用于机器学习的开源功能库，旨在简化创建、管理、共享和提供功能的过程。2019 年，Gojek 与谷歌云合作推出。

它使用 BigQuery + GCS + S3 实现离线特性，使用 BigTable + Redis 和 Apache Beam 实现在线特性。

组件:

1.  *盛宴核心:*这是所有特性及其各自定义共存的地方。
2.  *Feast Job Service:* 该组件管理将数据从数据源加载到存储中的数据处理作业，以及导出用于训练的数据的作业。
3.  *盛宴在线服务:*在线功能要求对它们的低延迟访问，这由该组件实现。
4.  *盛宴 Python SDK:* 这是用来管理特征定义，启动作业，检索训练数据集和在线特征。
5.  *在线商店:*它存储每个实体的最新功能。它可以由流源的批处理摄取或流摄取作业填充。
6.  *离线存储:*存储用于训练 AI 模型的批量数据。

它是如何工作的？

1.  日志流数据是从应用程序获取的。
2.  Kafka 和 Spark 等流处理系统用于将这些数据转换为流特征。
3.  然后，原始要素和流要素都被记录到数据湖中。
4.  批处理存储中的 ETL/ELT 转换数据。
5.  然后在特征核心上建立特征及其定义。
6.  Feast Job 服务轮询新的和更新的功能。
7.  批处理摄取作业是短暂的，它们将数据提取到离线和在线存储中。
8.  流接收作业是长期存在的，它们从流源获取并提供给在线应用程序。
9.  启动机器学习管道，使用数据，所有这些都由 SDK 控制。
10.  根据模型配置，feast 提供时间点培训数据和功能。
11.  然后，服务经训练的模型，并且后端请求来自模型服务系统的预测。
12.  模型服务系统从盛宴在线服务请求在线特征。
13.  模型服务系统对在线特征进行预测并返回结果。

### 霍普斯沃克的特色商店

数据工程师主要负责添加/更新功能，这些功能可以使用笔记本、Python、Java 或 Scala 编写的程序，甚至是 Hopsworks 的 UI，通过 SQL 查询甚至复杂的图形嵌入来计算。程序以熊猫或火花数据帧的形式接收数据。

在摄取之前，使用数据验证 API 对要素数据进行验证。Hopsworks 提供了一个 UI 平台，用于建立数据验证规则，通过这些规则还可以查看特性统计数据。Hopsworks 还支持创建多个特性存储，因为一个特性存储不一定能被企业的所有部分访问。

数据科学家使用特征存储将数据分为训练集和测试集，以构建机器学习模型。在线应用程序使用它来创建一个特征向量，稍后用于推理。除此之外，用户还可以查询时间点数据。

特征是可测量的属性，其中每个特征属于具有用于计算的相关键的特征组。数据科学家可以通过提供/选择一组特征、特征输出的目标文件格式(CSV、TFRecords、Numpy 等)来生成训练和测试数据。)，以及目标存储系统(GCS、AWS S3 等。).

有两种方法可以计算特征组:

*   按需:有对外部数据库的内置支持，允许您在外部数据源上定义特性。
*   缓存:Hopsworks 功能存储可以扩展到 1pb 的功能数据。

Hopsworks 提供了很棒的关于如何使用他们的 API 和开始使用其特性库的文档。

### 泰克顿的特征商店

虽然大多数组织已经开始构建供内部使用的功能商店，但 Tecton 一直在构建他们的平台，以服务的形式提供给各种企业。他们的创始成员最初在优步，在那里他们建造了米开朗基罗。受优步产品的启发，泰克顿也建立并开始提供服务。他们还为谷歌的开源功能商店 Feast 做出了贡献。

## 摘要

*   特征存储加快并稳定了提取、转换数据、工程特征并存储它们的过程，以便于离线和在线访问。
*   功能商店如果不是无处不在的话，应该是每个组织的下一个必须采取的步骤，这些组织旨在建立最好的人工智能产品，而不必在运营目的上损失带宽。
*   传统的 CI/CD 流水线不适合处理数据和机器学习模型，这就引入了 MLOps 和 DataOps 的需求。
*   特色商店的一些例子是优步的米开朗基罗，谷歌的盛宴，霍普斯沃斯的特色商店和泰克顿的特色商店。

### 参考资料: