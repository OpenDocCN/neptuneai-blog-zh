<html>
<head>
<title>How to Keep Track of Experiments in PyTorch </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何在PyTorch中跟踪实验</h1>
<blockquote>原文：<a href="https://web.archive.org/web/https://neptune.ai/blog/how-to-keep-track-of-experiments-in-pytorch-using-neptune#0001-01-01">https://web.archive.org/web/https://neptune.ai/blog/how-to-keep-track-of-experiments-in-pytorch-using-neptune#0001-01-01</a></blockquote><div><div class="l-content content-wrapper js-content">
            
<p>机器学习开发看起来很像传统的软件开发，因为它们都需要我们编写大量代码。但其实不是！让我们通过一些要点来更好地理解这一点。</p>



<ul><li>机器学习代码不会抛出错误(当然我说的是语义)，原因是，即使你在一个<a href="/web/20221206010849/https://neptune.ai/blog/graph-neural-network-and-some-of-gnn-applications" target="_blank" rel="noreferrer noopener">神经网络</a>中配置了一个错误的方程，它仍然会运行，但会打乱你的预期。用<a href="https://web.archive.org/web/20221206010849/https://karpathy.github.io/2019/04/25/recipe/" target="_blank" rel="noreferrer noopener nofollow">安德烈·卡帕西</a>、<em>的话说，“神经网络无声无息地失灵”。</em></li><li>机器学习代码/项目严重依赖结果的可重复性。这意味着如果一个<a href="/web/20221206010849/https://neptune.ai/blog/hyperparameter-tuning-in-python-a-complete-guide-2020" target="_blank" rel="noreferrer noopener">超参数</a>被推动或者训练数据发生变化，那么它会在许多方面影响模型的性能。这意味着你必须记下超参数和训练数据的每一个变化，以便能够重现你的工作。<br/>当网络很小的时候，这可以在一个文本文件中完成，但是如果是一个有几十或几百个超参数的大项目呢？文本文件现在不那么容易了吧！</li><li>机器学习项目复杂性的增加意味着复杂分支的增加，必须对其进行跟踪和存储以供将来分析。</li><li>机器学习也需要大量的计算，这是有代价的。你肯定不希望你的云成本暴涨。</li></ul>



<p>有组织地跟踪实验有助于解决所有这些核心问题。海王星是一个完整的<a href="/web/20221206010849/https://neptune.ai/blog/best-ml-experiment-tracking-tools" target="_blank" rel="noreferrer noopener">工具，帮助个人和团队顺利跟踪他们的实验。</a>它提供了许多功能和演示选项，有助于更轻松地跟踪和协作。</p>



<figure class="wp-block-embed is-type-video is-provider-youtube wp-block-embed-youtube wp-embed-aspect-16-9 wp-has-aspect-ratio"><p class="wp-block-embed__wrapper"><iframe title="General Introduction to Neptune – Metadata Store for MLOps" src="https://web.archive.org/web/20221206010849if_/https://www.youtube.com/embed/he2KqU76ays?feature=oembed" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="">视频</iframe></p></figure>



<p id="separator-block_60250b4bb462c" class="block-separator block-separator--5"> </p>



<h2 id="h-experiment-tracking-with-neptune">用海王星进行实验跟踪</h2>



<p>传统的跟踪过程包括将日志对象保存为文本或CSV文件，这非常方便，但是对于与输出日志的混乱结构相关的未来分析没有用处。下图以图片的形式讲述了这个故事:</p>







<p>虽然可读，但你会很快失去兴趣。一段时间后，你也可能会丢失文件——没有人会预料到突然的磁盘故障或过度清理！</p>



<p>所以，总而言之，txt的方式方便但不推荐。为了解决这个问题，Neptune跟踪每个超参数，包括模型和训练程序的超参数，以便您可以有效地与您的团队交流，并在未来分析训练程序以进一步优化它们。</p>



<p>下面是一个类似的实验，但使用Neptune应用程序进行跟踪:</p>



<figure class="wp-block-video aligncenter"><video controls="" src="https://web.archive.org/web/20221206010849im_/https://neptune.ai/wp-content/uploads/Example-dashboard-metadata-structure.mp4"/><figcaption><em><a href="https://web.archive.org/web/20221206010849/https://app.neptune.ai/o/common/org/example-project-tensorflow-keras/e/TFKERAS-14/all" target="_blank" rel="noreferrer noopener">Example project metadata in Neptune</a></em></figcaption></figure>



<h3>在Pytorch建立海王星实验</h3>



<p>设置过程很简单。首先注册一个帐户<a href="https://web.archive.org/web/20221206010849/https://neptune.ai/"> </a> <a href="/web/20221206010849/https://neptune.ai/register" target="_blank" rel="noreferrer noopener">这里</a>，这将创建一个唯一的ID和仪表板，在那里你可以看到你所有的实验。您可以随时添加您的团队成员，并在实验中进行合作。按照<a href="https://web.archive.org/web/20221206010849/https://docs.neptune.ai/getting-started/installation" target="_blank" rel="noreferrer noopener">这些步骤</a>获得您的唯一id(设置时使用)。</p>



<p>为了在python的培训过程中使用这个仪表板，Neptune开发人员开发了一个易于使用的包，您可以通过pip安装它:</p>



<pre class="hljs">pip install neptune-client
</pre>



<p>完成安装后，您需要像这样初始化Neptune:</p>



<pre class="hljs">
<span class="hljs-keyword">import</span> neptune.new <span class="hljs-keyword">as</span> neptune
<span class="hljs-keyword">from</span> neptune.new.types <span class="hljs-keyword">import</span> File

NEPTUNE_API_TOKEN = <span class="hljs-string">"&lt;api-token-here&gt;"</span>
run = neptune.init(project=<span class="hljs-string">'&lt;username&gt;/Experiment-Tracking-PyTorch'</span>,
                   api_token=NEPTUNE_API_TOKEN)
</pre>



<p>现在，让我们看看如何从PyTorch脚本中利用Neptune的仪表板。</p>







<h4>基本指标集成</h4>



<p>让我们从跟踪通常的度量开始，比如训练/测试损失、时期损失和梯度。为此，您只需将run['metrics/train_loss']。log(loss ),其中“metrics”是可以存储所需参数的目录,“loss”是被跟踪的度量。在你的PyTorch训练循环中会是这样的:</p>



<pre class="hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">train</span><span class="hljs-params">(model, device, train_loader, optimizer, epoch)</span>:</span>
   model.train()
   <span class="hljs-keyword">for</span> batch_idx, (data, target) <span class="hljs-keyword">in</span> enumerate(train_loader):
       data, target = data.to(device), target.to(device)

       optimizer.zero_grad()

       output = model(data)

       loss = F.nll_loss(output, target)
       loss.backward()

       optimizer.step()

       
       run[<span class="hljs-string">'metrics/train_loss'</span>].log(loss)


       <span class="hljs-keyword">if</span> batch_idx % <span class="hljs-number">100</span> == <span class="hljs-number">0</span>:
           print(<span class="hljs-string">'Train Epoch: {} [{}/{} ({:.0f}%)]tLoss: {:.6f}'</span>.format(
               epoch, batch_idx * len(data), len(train_loader.dataset),
               <span class="hljs-number">100.</span> * batch_idx / len(train_loader), loss.item()))</pre>



<p>运行上面的代码后，检查您的Neptune仪表板，您将看到跟踪和绘制的损失度量供您分析。</p>







<p>为了跟踪超参数(你应该，总是这样做！)你需要做的就是简单的给海王星的run对象添加这样的参数。</p>



<pre class="hljs">
PARAMS = {<span class="hljs-string">'batch_size_train'</span>: <span class="hljs-number">64</span>,
         <span class="hljs-string">'batch_size_test'</span>: <span class="hljs-number">1000</span>,
         <span class="hljs-string">'momentum'</span>: <span class="hljs-number">0.5</span>,
         <span class="hljs-string">'learning_rate'</span>: <span class="hljs-number">0.01</span>,
         <span class="hljs-string">'log_interval'</span> : <span class="hljs-number">10</span>,
         <span class="hljs-string">'optimizer'</span>: <span class="hljs-string">'Adam'</span>}


run[<span class="hljs-string">'parameters'</span>] = PARAMS 
</pre>



<p>使用这些更改再次运行实验后，您将在仪表板中看到所有参数，如下所示:</p>







<p>添加参数和标记的一个最大目的是将所有东西都插入一个仪表板，这样就可以在未来轻松地进行优化或特性更改分析，而不会消耗大量代码。</p>



<h4>高级选项</h4>



<p>Neptune为您提供了许多定制选项，您可以简单地记录更多特定于实验的内容，如图像预测、模型权重、性能图表等等。</p>



<p>所有这些功能都可以很容易地集成到您当前的PyTorch脚本中，在下一节中，我将向您展示如何充分利用Neptune。</p>



<p>运行实验时，您可以记录其他有用的信息:</p>



<ul><li>代码:快照脚本、jupyter笔记本、配置文件等等</li><li><strong>超参数</strong>:日志学习率，历元数，以及其他</li><li><strong>属性</strong>:日志数据位置、数据版本或其他</li><li><strong>标签</strong>:添加“resnet50”或“无增强”等标签来组织您的跑步。</li><li>名称:每个实验都应该有一个有意义的名称，所以我们不要每次都用“默认”</li></ul>



<p>只需将这些作为参数传递给init()函数，这很简单:</p>



<pre class="hljs">NEPTUNE_API_TOKEN = <span class="hljs-string">"&lt;api-token-here&gt;"</span>
run = neptune.init(project=<span class="hljs-string">'&lt;username&gt;/Experiment-Tracking-PyTorch'</span>,
                   api_token=NEPTUNE_API_TOKEN,
                  tags=[<span class="hljs-string">'classification'</span>, <span class="hljs-string">'pytorch'</span>, <span class="hljs-string">'neptune'</span>],
                   source_files=[<span class="hljs-string">"**/*.ipynb"</span>, <span class="hljs-string">"*.yaml"</span>]  
)
</pre>



<p>上面的代码摘录将上传您的属于正则表达式的代码文件，添加您可以在仪表板中识别的标签。现在，让我们看看如何记录其他实验特定的内容，如图像和模型重量文件:</p>



<h4>记录图像</h4>



<pre class="hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">train</span><span class="hljs-params">(model, device, train_loader, optimizer, epoch)</span>:</span>
   model.train()
   <span class="hljs-keyword">for</span> batch_idx, (data, target) <span class="hljs-keyword">in</span> enumerate(train_loader):
       data, target = data.to(device), target.to(device)

       optimizer.zero_grad()

       output = model(data)

       loss = F.nll_loss(output, target)
       loss.backward()

       optimizer.step()

       
       run[<span class="hljs-string">'metrics/train_loss'</span>].log(loss)

       
       <span class="hljs-keyword">if</span> batch_idx % <span class="hljs-number">50</span> == <span class="hljs-number">1</span>:
           <span class="hljs-keyword">for</span> image, prediction <span class="hljs-keyword">in</span> zip(data, output):

               img = image.mul(<span class="hljs-number">255</span>).add_(<span class="hljs-number">0.5</span>).clamp_(<span class="hljs-number">0</span>, <span class="hljs-number">255</span>).to(<span class="hljs-string">'cpu'</span>, torch.uint8).numpy()
               img = Image.fromarray(img.reshape(<span class="hljs-number">28</span>,<span class="hljs-number">28</span>))
                     run[<span class="hljs-string">"predictions/{}"</span>.format(batch_idx)].upload(File.as_image(img))

       <span class="hljs-keyword">if</span> batch_idx % <span class="hljs-number">100</span> == <span class="hljs-number">0</span>:
           print(<span class="hljs-string">'Train Epoch: {} [{}/{} ({:.0f}%)]tLoss: {:.6f}'</span>.format(
               epoch, batch_idx * len(data), len(train_loader.dataset),
               <span class="hljs-number">100.</span> * batch_idx / len(train_loader), loss.item()))</pre>



<p>在运行带有日志记录更改的代码后，您将在Neptune仪表板的“预测”目录中看到记录的图像。</p>



<p>通过左侧菜单中的“添加新仪表板”，您可以使用许多可用的小部件创建自己的定制仪表板。例如，您可以在一个屏幕上添加图像预测并进行分析！</p>







<p>在这里，我添加了其中的两个，你可以通过选择你更感兴趣的来扩展它。</p>







<h4>你可以在实验中记录额外的东西</h4>



<p>训练中可以记录很多有趣的信息。您可能对监控以下内容感兴趣:</p>



<ul><li>每个时期后的模型预测(考虑预测遮罩或覆盖的边界框)</li><li>诊断图表，如ROC AUC曲线或混淆矩阵</li><li>模型检查点或其他对象</li></ul>



<p>例如，我们可以使用torch.save()方法将模型权重和配置保存到本地磁盘以及Neptune的仪表板中:</p>



<pre class="hljs">torch.save(model.state_dict(), <span class="hljs-string">'model_dict.ckpt'</span>)


run[<span class="hljs-string">"model_checkpoints"</span>].upload(<span class="hljs-string">"model_dict.ckpt"</span>)</pre>



<p>至于像ROC曲线和混淆矩阵这样的训练后分析，您可以使用您最喜欢的绘图库绘制它，并用neptune.log_image()记录它</p>



<pre class="hljs"><span class="hljs-keyword">from</span> scikitplot.metrics <span class="hljs-keyword">import</span> plot_confusion_matrix
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
...
fig, ax = plt.subplots(figsize=(<span class="hljs-number">16</span>, <span class="hljs-number">12</span>))
plot_confusion_matrix(y_true, y_pred, ax=ax)
run[<span class="hljs-string">"metrics/confusion_matrix"</span>].upload(File.as_image(fig))
</pre>



<p>如果您希望看到这个令人敬畏的API的每一个功能，请前往包含代码示例的Neptune文档。</p>



<h2 id="h-youve-reached-the-end">你已经到达终点了！</h2>



<p>我们看到了<strong>为什么</strong> <em> <a href="/web/20221206010849/https://neptune.ai/experiment-tracking" target="_blank" rel="noreferrer noopener">实验跟踪</a> </em>由于它们无声的脆弱性和未来的分析前景，在机器学习系统中是一种必需品。我们也看到了<strong>Neptune ai如何证明是完成这项任务的合适工具。使用Neptune的API:</strong></p>



<ul><li>你可以监控和跟踪你的深度学习实验</li><li>你可以很容易地与其他人分享你的研究</li><li>您和您的团队可以访问实验元数据并更有效地协作。</li></ul>



<p>你可以在这个笔记本中找到代码<a href="https://web.archive.org/web/20221206010849/https://colab.research.google.com/drive/10CN6HsPcPU9shiPs6y3cdehFr-FWAaCD?usp=sharing" target="_blank" rel="noreferrer noopener nofollow">这里</a>和海王星实验<a href="https://web.archive.org/web/20221206010849/https://app.neptune.ai/theaayushbajaj/Experiment-Tracking-PyTorch/experiments?split=tbl&amp;dash=charts&amp;viewId=standard-view" target="_blank" rel="noreferrer noopener">这里</a>。</p>



<p>目前就这些，敬请关注更多！再见！</p>
        </div>
        
    </div>    
</body>
</html>