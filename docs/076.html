<html>
<head>
<title>Kedro Pipelines With Optuna: Running Hyperparameter Sweeps </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>使用Optuna的Kedro管道:运行超参数扫描</h1>
<blockquote>原文：<a href="https://web.archive.org/web/https://neptune.ai/blog/kedro-pipelines-with-optuna-hyperparameter-sweeps#0001-01-01">https://web.archive.org/web/https://neptune.ai/blog/kedro-pipelines-with-optuna-hyperparameter-sweeps#0001-01-01</a></blockquote><div><div class="article__content col-lg-10">
<p>软件工程的工作流管理生态系统已经相当成熟——Git用于版本控制，Postman用于API测试，还有很多工具让你的生活更轻松。在ML中，我们始终如一地对代码和数据进行实验，这与“实验”并不常见的软件开发相反。此外，ML实验可能很快变得混乱，并且经常无声无息地失败。</p>



<p>因此，需要一些工具来帮助您可靠地迭代实验，并实现最大的可见性和日志记录来跟踪变化。ML管道中的配置可以在不同的级别上工作:</p>


<div class="case-study-numbered-list">
    <h2/>
    <ul>
                    <li><span> 1 </span>数据集层面:数据选择、数据集大小、消除任何偏见<br/></li>
                    <li><span> 2 </span>特征级:检查特征范围、异常值、可疑值，选择/转换/创建特征<br/></li>
                    <li><span> 3 </span>模型级:模型架构、超参数</li>
            </ul>
</div>



<p>更重要的是，记录所有关键结果——单个数字指标、图表、损失曲线等。</p>



<p>本文展示了我们如何使用Kedro和Optuna健壮地满足上述需求。</p>



<h2>介绍Kedro</h2>



<p>数据科学代码可能很复杂，而且变化很快。复杂性源于数据处理、EDA、功能工程/功能选择、调整和日志记录等相互关联的组件。代码或数据集的变化在实验之间不断发生。Kedro帮助模块化数据科学管道，确保以可靠的方式处理代码。</p>



<p>此外，Kedro还帮助处理各种来源(本地、AWS、GCP)和格式(CSV、HDFS、Spark)的数据。它还提供Kubeflow、Prefect和AWS批处理平台部署选项。更多关于Kedro的信息可以在这里找到。</p>






<h2>介绍Optuna</h2>



<p>大多数ML模型都有多个超参数，需要进行调整以获得最佳的泛化能力。在数以千计的这些组合中进行强力搜索是很乏味的。</p>



<p>因此，需要灵活地导航超参数搜索空间。Optuna正是这样做的。Optuna使用复杂的算法，如Tree Parzen Estimators (TPE)和协方差矩阵自适应进化策略(CMA-ES)，大大减少了获得最佳超参数所需的试验次数。更多关于Optuna的信息可以在这里找到。</p>






<h2>使用Kedro和Optuna一起运行超参数扫描</h2>



<p>Kedro和Optuna在自动化ML工作流方面互为补充。Kedro处理高级管道、特征转换和预处理，而Optuna专注于核心模型优化。</p>



<p>我们现在将通过教程来看看Kedro和Optuna是如何结合在一起的。</p>



<h3>设置项目</h3>



<p>要安装kedro，请遵循此处的说明<a href="https://web.archive.org/web/20220926093908/https://kedro.readthedocs.io/en/stable/02_get_started/01_prerequisites.html" target="_blank" rel="noreferrer noopener nofollow">。</a></p>



<p>建议为该项目使用conda环境，并在安装任何依赖项之前激活它:</p>



<pre class="hljs">conda create --name kedro-environment python=<span class="hljs-number">3.7</span> -y
conda activate kedro-environment</pre>



<p>现在，让我们通过在CLI中运行<strong> kedro new </strong>来创建一个新的kedro项目模板。当它询问项目名称时，您可以输入自己选择的名称。现在，我们使用<strong>教程</strong>作为名称。随后，我们将这个名称用于我们的存储库和python包。完成所有工作后，新的项目模板结构应该如下所示:</p>



<div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img data-attachment-id="64367" data-permalink="https://web.archive.org/web/20220926093908/https://neptune.ai/kedro-pipelines-with-optuna-running-hyperparameter-sweeps_1" data-orig-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_1.png?fit=1050%2C1624&amp;ssl=1" data-orig-size="1050,1624" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Kedro Pipelines with Optuna: Running Hyperparameter Sweeps_1" data-image-description="" data-image-caption="" data-medium-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_1.png?fit=194%2C300&amp;ssl=1" data-large-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_1.png?fit=662%2C1024&amp;ssl=1" src="../Images/a3904ef479e85da5b1630f7d791522d9.png" alt="Using Kedro and Optuna together" class="wp-image-64367 jetpack-lazy-image" data-recalc-dims="1" data-lazy-src="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_1.png?resize=580%2C898&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://web.archive.org/web/20220926093908im_/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_1.png?resize=580%2C898&amp;ssl=1"/><noscript><img data-lazy-fallback="1" data-attachment-id="64367" data-permalink="https://web.archive.org/web/20220926093908/https://neptune.ai/kedro-pipelines-with-optuna-running-hyperparameter-sweeps_1" data-orig-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_1.png?fit=1050%2C1624&amp;ssl=1" data-orig-size="1050,1624" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Kedro Pipelines with Optuna: Running Hyperparameter Sweeps_1" data-image-description="" data-image-caption="" data-medium-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_1.png?fit=194%2C300&amp;ssl=1" data-large-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_1.png?fit=662%2C1024&amp;ssl=1" src="../Images/a3904ef479e85da5b1630f7d791522d9.png" alt="Using Kedro and Optuna together" class="wp-image-64367" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20220926093908im_/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_1.png?resize=580%2C898&amp;ssl=1"/></noscript><figcaption><em>Source: Author</em></figcaption></figure></div>



<h4>目录结构</h4>


<div class="custom-point-list">
<ul><li><strong> conf </strong>包含用于设置日志记录和管道参数的配置文件</li><li><strong>数据</strong>包含不同级别数据集(原始、中间、已处理、元数据等)的子目录。正如我们所知，数据集不会在源位置被清理。在这里阅读更多关于每个子目录的意图<a href="https://web.archive.org/web/20220926093908/https://kedro.readthedocs.io/en/latest/12_faq/01_faq.html#what-is-data-engineering-convention" target="_blank" rel="noreferrer noopener nofollow">的信息</a></li><li>src包含我们的应用程序代码</li></ul>
</div>


<p>我们将进一步详细探讨其中的每一个。</p>



<p>接下来，我们安装所有的需求。Kedro的模板已经生成了一个requirements.txt文件。我们在文件中添加了一些特定于我们项目的需求。requirements.txt文件应该如下所示:</p>



<pre class="hljs">black==<span class="hljs-number">21.5</span>b1
flake8&gt;=<span class="hljs-number">3.7</span><span class="hljs-number">.9</span>, &lt;<span class="hljs-number">4.0</span>
ipython~=<span class="hljs-number">7.10</span>
ipython~=<span class="hljs-number">7.16</span><span class="hljs-number">.3</span>; python_version == <span class="hljs-string">'3.6'</span>
ipython&gt;=<span class="hljs-number">7.31</span><span class="hljs-number">.1</span>, &lt;<span class="hljs-number">8.0</span>; python_version &gt; <span class="hljs-string">'3.6'</span>
isort~=<span class="hljs-number">5.0</span>
jupyter~=<span class="hljs-number">1.0</span>
jupyter_client&gt;=<span class="hljs-number">5.1</span>, &lt;<span class="hljs-number">7.0</span>
jupyterlab~=<span class="hljs-number">3.0</span>
kedro==<span class="hljs-number">0.17</span><span class="hljs-number">.7</span>
kedro-telemetry~=<span class="hljs-number">0.1</span><span class="hljs-number">.0</span>
nbstripout~=<span class="hljs-number">0.4</span>
pytest-cov~=<span class="hljs-number">3.0</span>
pytest-mock&gt;=<span class="hljs-number">1.7</span><span class="hljs-number">.1</span>, &lt;<span class="hljs-number">2.0</span>
pytest~=<span class="hljs-number">6.2</span>
wheel&gt;=<span class="hljs-number">0.35</span>, &lt;<span class="hljs-number">0.37</span>
scikit-learn
numpy
pandas
tqdm
optuna</pre>



<p>要安装需求，请遵循以下代码:</p>



<pre class="hljs">(kedro-environment) dhruvilkarani@Dhruvils-MacBook-Air kedro-blog % cd tutorial/src
(kedro-environment) dhruvilkarani@Dhruvils-MacBook-Air src % pip install -r requirements.txt</pre>



<p>在此下载酒质数据<a href="https://web.archive.org/web/20220926093908/https://www.kaggle.com/yasserh/wine-quality-dataset" target="_blank" rel="noreferrer noopener nofollow">并保存在<strong>教程/data/01_raw </strong>目录下；</a></p>



<pre class="hljs">(kedro-environment) dhruvilkarani@Dhruvils-MacBook-Air kedro-blog % cd tutorial</pre>



<h3>编写数据处理管道</h3>



<p>Kedro有两条主要管道——数据处理和数据科学。数据处理管道处理数据操作、清理、连接多个数据集、特征创建，以及模型训练和评估之前的几乎所有事情。要创建数据处理模板，请遵循以下命令:</p>



<pre class="hljs">(kedro-environment) dhruvilkarani@Dhruvils-MacBook-Air tutorial % kedro pipeline create data_processing</pre>



<p>现在，kedro管道非常类似于气流有向无环图(Dag)。Kedro创建了一个节点图(node=process)。每个节点都有输入和输出。Kedro允许我们跟踪这些输入和输出，使用它们就像正确命名它们一样好。让我告诉你它是如何工作的。考虑这个管道。</p>



<div class="wp-block-image"><figure class="aligncenter size-full is-resized"><img data-attachment-id="64365" data-permalink="https://web.archive.org/web/20220926093908/https://neptune.ai/kedro-pipelines-with-optuna-running-hyperparameter-sweeps_3" data-orig-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_3.png?fit=806%2C878&amp;ssl=1" data-orig-size="806,878" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Kedro Pipelines with Optuna: Running Hyperparameter Sweeps_3" data-image-description="" data-image-caption="" data-medium-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_3.png?fit=275%2C300&amp;ssl=1" data-large-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_3.png?fit=806%2C878&amp;ssl=1" src="../Images/90c0ca7bb9b5cb60d6113507df58c9d3.png" alt="Writing the data processing pipeline" class="wp-image-64365 jetpack-lazy-image" data-recalc-dims="1" data-lazy-src="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_3.png?resize=575%2C626&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://web.archive.org/web/20220926093908im_/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_3.png?resize=575%2C626&amp;ssl=1"/><noscript><img data-lazy-fallback="1" data-attachment-id="64365" data-permalink="https://web.archive.org/web/20220926093908/https://neptune.ai/kedro-pipelines-with-optuna-running-hyperparameter-sweeps_3" data-orig-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_3.png?fit=806%2C878&amp;ssl=1" data-orig-size="806,878" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Kedro Pipelines with Optuna: Running Hyperparameter Sweeps_3" data-image-description="" data-image-caption="" data-medium-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_3.png?fit=275%2C300&amp;ssl=1" data-large-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_3.png?fit=806%2C878&amp;ssl=1" src="../Images/90c0ca7bb9b5cb60d6113507df58c9d3.png" alt="Writing the data processing pipeline" class="wp-image-64365" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20220926093908im_/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_3.png?resize=575%2C626&amp;ssl=1"/></noscript><figcaption><em>Source: Author</em></figcaption></figure></div>



<p>它获取原始数据并进行训练测试分割。这里唯一的节点是<strong>列车试裂</strong>:</p>



<pre class="hljs"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
 
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_train_test_data</span><span class="hljs-params">(df, frac, random_seed)</span>:</span>
   df_train, df_test = train_test_split(
                           df, test_size=frac,
                           random_state=random_seed,
                           stratify=df[<span class="hljs-string">"quality"</span>]
                       )
   df_train_mean = df_train.mean()
   df_train = df_train.fillna(df_train_mean)
   df_test = df_test.fillna(df_train_mean)
   <span class="hljs-keyword">return</span> df_train, df_test</pre>



<p>现在通常你会添加一个<strong> pd.read_csv </strong>和几个<strong> df.to_csv </strong>来读写文件。如果你想改变测试数据的大小，你可以改变代码中的<strong> frac </strong>参数。这非常乏味。相反，让我们这样做:</p>



<p>在<strong>src/tutorial/pipelines/data _ processing/nodes . py</strong>中添加上面的train-test分割代码。您应该在这个文件中编写一个节点必须执行的函数。现在，打开<strong> tutorial/conf/base </strong>下的文件<strong> catalog.yml </strong>。在文件中添加以下内容:</p>



<pre class="hljs">raw:
 type: pandas.CSVDataSet
 filepath: data/<span class="hljs-number">01</span>_raw/WineQT.csv
 
 
train:
 type: pandas.CSVDataSet
 filepath: data/<span class="hljs-number">05</span>_model_input/train.csv
 
 
test:
 type: pandas.CSVDataSet
 filepath: data/<span class="hljs-number">05</span>_model_input/test.csv</pre>



<p>我们告诉kedro跟踪三个熊猫CSV文件——<strong>raw</strong>、<strong> train </strong>和<strong> test </strong>。我们之前已经放置了<strong>原始</strong>数据集。Kedro会注意到train和test CSV文件不在它们各自的位置(文件路径参数),它会为您编写这些文件。</p>



<p>接下来，在<strong>src/tutorial/pipelines/data _ processing/pipeline . py</strong>下添加以下代码:</p>



<pre class="hljs"><span class="hljs-string">"""
This is a boilerplate pipeline 'data_processing'
generated using Kedro 0.17.7
"""</span>
 
<span class="hljs-keyword">from</span> kedro.pipeline <span class="hljs-keyword">import</span> Pipeline, node, pipeline
<span class="hljs-keyword">from</span> tutorial.pipelines.data_processing.nodes <span class="hljs-keyword">import</span> create_train_test_data
 
 
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_pipeline</span><span class="hljs-params">(**kwargs)</span> -&gt; Pipeline:</span>
   <span class="hljs-keyword">return</span> pipeline([
       node(
           func=create_train_test_data,
           inputs=[<span class="hljs-string">"raw"</span>, <span class="hljs-string">"params:frac"</span>, <span class="hljs-string">"params:random_seed"</span>],
           outputs=[<span class="hljs-string">"train"</span>, <span class="hljs-string">"test"</span>],
           name=<span class="hljs-string">"train_test_split"</span>
       ),
   ])</pre>



<p>这创建了一个数据处理管道，其中有一个名为<strong> train_test_split </strong>的节点。<strong> </strong>它将执行函数<strong> create_train_test_data </strong>，输入为<strong> raw </strong>(在conf.yml中定义)，附加参数为<strong> frac </strong>和<strong> random_seed </strong>。输出将是train和test(其中kedro通过conf.yml保持跟踪)。注意<strong> params:frac </strong>中的参数来自<strong>conf/base/parameters . yml</strong>中的配置文件。在其中添加以下几行:</p>



<pre class="hljs">frac: <span class="hljs-number">0.15</span>
random_seed: <span class="hljs-number">42</span>
features: [<span class="hljs-string">'fixed acidity'</span>, <span class="hljs-string">'volatile acidity'</span>, <span class="hljs-string">'citric acid'</span>, <span class="hljs-string">'residual sugar'</span>,
      <span class="hljs-string">'chlorides'</span>, <span class="hljs-string">'free sulfur dioxide'</span>, <span class="hljs-string">'total sulfur dioxide'</span>, <span class="hljs-string">'density'</span>,
      <span class="hljs-string">'pH'</span>, <span class="hljs-string">'sulphates'</span>, <span class="hljs-string">'alcohol'</span>]
y_label: <span class="hljs-string">'quality'</span></pre>



<p>所以下一次你想尝试不同的部分和种子时，你只需要改变配置文件而不是代码。</p>



<p>在最后一步中，通过在<strong>src/tutorial/pipeline _ registry . py</strong>中添加以下内容来注册新的数据处理管道:</p>



<pre class="hljs"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Dict
 
<span class="hljs-keyword">from</span> kedro.pipeline <span class="hljs-keyword">import</span> Pipeline, pipeline
<span class="hljs-keyword">from</span> tutorial.pipelines <span class="hljs-keyword">import</span> data_processing <span class="hljs-keyword">as</span> dp
 
 
 
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">register_pipelines</span><span class="hljs-params">()</span> -&gt; Dict[str, Pipeline]:</span>
   <span class="hljs-string">"""Register the project's pipelines.
 
   Returns:
       A mapping from a pipeline name to a ``Pipeline`` object.
   """</span>
   data_processing_pipeline = dp.create_pipeline()
   <span class="hljs-keyword">return</span> {
       <span class="hljs-string">"__default__"</span>: data_processing_pipeline,
       <span class="hljs-string">"dp"</span>: data_processing_pipeline,
   }</pre>



<p>您现在一切就绪！</p>



<p>只需从CLI运行<strong> kedro run </strong>并观察日志。它应该是这样的:</p>



<pre class="hljs">kedro run
<span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-05</span> <span class="hljs-number">12</span>:<span class="hljs-number">29</span>:<span class="hljs-number">15</span>,<span class="hljs-number">993</span> - kedro.framework.cli.hooks.manager - INFO - Registered CLI hooks <span class="hljs-keyword">from</span> <span class="hljs-number">1</span> installed plugin(s): kedro-telemetry<span class="hljs-number">-0.1</span><span class="hljs-number">.3</span>
Kedro-Telemetry <span class="hljs-keyword">is</span> installed, but you have opted out of sharing usage analytics so none will be collected.
<span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-05</span> <span class="hljs-number">12</span>:<span class="hljs-number">29</span>:<span class="hljs-number">17</span>,<span class="hljs-number">446</span> - kedro.framework.session.store - INFO - `read()` <span class="hljs-keyword">not</span> implemented <span class="hljs-keyword">for</span> `SQLiteStore`. Assuming empty store.
fatal: <span class="hljs-keyword">not</span> a git repository (<span class="hljs-keyword">or</span> any of the parent directories): .git
<span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-05</span> <span class="hljs-number">12</span>:<span class="hljs-number">29</span>:<span class="hljs-number">17</span>,<span class="hljs-number">469</span> - kedro.framework.session.session - WARNING - Unable to git describe /Users/dhruvilkarani/Desktop/neptune/kedro-blog/tutorial
<span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-05</span> <span class="hljs-number">12</span>:<span class="hljs-number">29</span>:<span class="hljs-number">17</span>,<span class="hljs-number">477</span> - kedro.framework.session.session - INFO - ** Kedro project tutorial
/Users/dhruvilkarani/opt/anaconda3/envs/kedro-environment/lib/python3<span class="hljs-number">.7</span>/site-packages/kedro/io/data_catalog.py:<span class="hljs-number">194</span>: DeprecationWarning: The transformer API will be deprecated <span class="hljs-keyword">in</span> Kedro <span class="hljs-number">0.18</span><span class="hljs-number">.0</span>.Please use Dataset Hooks to customise the load <span class="hljs-keyword">and</span> save methods.For more information, please visithttps://kedro.readthedocs.io/en/stable/<span class="hljs-number">07</span>_extend_kedro/<span class="hljs-number">02</span>_hooks.html
  DeprecationWarning,
<span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-05</span> <span class="hljs-number">12</span>:<span class="hljs-number">29</span>:<span class="hljs-number">18</span>,<span class="hljs-number">200</span> - kedro.io.data_catalog - INFO - Loading data <span class="hljs-keyword">from</span> `raw` (CSVDataSet)...
<span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-05</span> <span class="hljs-number">12</span>:<span class="hljs-number">29</span>:<span class="hljs-number">18</span>,<span class="hljs-number">207</span> - kedro.io.data_catalog - INFO - Loading data <span class="hljs-keyword">from</span> `params:frac` (MemoryDataSet)...
<span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-05</span> <span class="hljs-number">12</span>:<span class="hljs-number">29</span>:<span class="hljs-number">18</span>,<span class="hljs-number">207</span> - kedro.io.data_catalog - INFO - Loading data <span class="hljs-keyword">from</span> `params:random_seed` (MemoryDataSet)...
<span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-05</span> <span class="hljs-number">12</span>:<span class="hljs-number">29</span>:<span class="hljs-number">18</span>,<span class="hljs-number">207</span> - kedro.pipeline.node - INFO - Running node: train_test_split: create_train_test_data([raw,params:frac,params:random_seed]) -&gt; [train,test]
<span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-05</span> <span class="hljs-number">12</span>:<span class="hljs-number">29</span>:<span class="hljs-number">18</span>,<span class="hljs-number">216</span> - kedro.io.data_catalog - INFO - Saving data to `train` (CSVDataSet)...
<span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-05</span> <span class="hljs-number">12</span>:<span class="hljs-number">29</span>:<span class="hljs-number">18</span>,<span class="hljs-number">226</span> - kedro.io.data_catalog - INFO - Saving data to `test` (CSVDataSet)...
<span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-05</span> <span class="hljs-number">12</span>:<span class="hljs-number">29</span>:<span class="hljs-number">18</span>,<span class="hljs-number">229</span> - kedro.runner.sequential_runner - INFO - Completed <span class="hljs-number">1</span> out of <span class="hljs-number">1</span> tasks
<span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-05</span> <span class="hljs-number">12</span>:<span class="hljs-number">29</span>:<span class="hljs-number">18</span>,<span class="hljs-number">229</span> - kedro.runner.sequential_runner - INFO - Pipeline execution completed successfully.</pre>



<p>如果你注意到了，<strong> train.csv </strong>和<strong> test.csv </strong>文件被创建并存储在<strong>tutorial/data/05 _ model _ input</strong>中。</p>



<h3>编写数据科学管道</h3>



<p>现在数据准备好了，我们准备训练一个模型。我们将创建一个数据科学管道，就像我们创建一个数据处理管道一样。教程的其余部分与我们到目前为止所做的非常相似。在本节中，我们选择一个<strong> RandomForestClassifier </strong>并调整它的两个重要的超参数—<strong>n _ estimators</strong>和<strong> max_depth </strong>。您可以选择任何具有各自超参数的sklearn模型:</p>



<pre class="hljs">(kedro-environment) dhruvilkarani@Dhruvils-MacBook-Air tutorial % kedro pipeline create data_science</pre>



<p>接下来，我们将在<strong>src/tutorial/pipelines/data _ science/nodes . py</strong>中添加以下代码:</p>



<pre class="hljs"><span class="hljs-string">"""
This is a boilerplate pipeline 'data_science'
generated using Kedro 0.17.7
"""</span>
<span class="hljs-keyword">from</span> distutils.log <span class="hljs-keyword">import</span> Log
<span class="hljs-keyword">from</span> sklearn.ensemble <span class="hljs-keyword">import</span> RandomForestClassifier
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> cross_val_score
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score
<span class="hljs-keyword">from</span> kedro.io <span class="hljs-keyword">import</span> MemoryDataSet
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> optuna
 
 
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">train_model</span><span class="hljs-params">(df_train, y_label, features)</span>:</span>
   X_train = df_train[features].values
   y_train = df_train[y_label].values
 
   <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">objective</span><span class="hljs-params">(trial)</span>:</span>
       n_estimators = trial.suggest_int(<span class="hljs-string">'n_estimators'</span>, <span class="hljs-number">2</span>, <span class="hljs-number">50</span>)
       max_depth = int(trial.suggest_loguniform(<span class="hljs-string">'max_depth'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">20</span>))
       model = RandomForestClassifier(n_estimators=n_estimators, max_depth=max_depth)
       <span class="hljs-keyword">return</span> cross_val_score(model, X_train, y_train,
           n_jobs=<span class="hljs-number">-1</span>, cv=<span class="hljs-number">5</span>).mean()
 
   study = optuna.create_study(direction=<span class="hljs-string">'maximize'</span>)
   study.optimize(objective, n_trials=<span class="hljs-number">100</span>)
   model = RandomForestClassifier(**study.best_params)
   model.fit(X_train, y_train)
 
   y_pred = model.predict(X_train)
   <span class="hljs-keyword">return</span> model, {<span class="hljs-string">"acc"</span>:accuracy_score(y_train, y_pred)}, {<span class="hljs-string">"features"</span>:features, <span class="hljs-string">"model_type"</span>: <span class="hljs-string">"RandomForest"</span>}
 
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">evaluate_model</span><span class="hljs-params">(model, df_test, y_label, features)</span>:</span>
   X_test = df_test[features].values
   y_test = df_test[y_label].values
   y_pred = model.predict(X_test)
   <span class="hljs-keyword">return</span> {<span class="hljs-string">"acc"</span>: accuracy_score(y_test, y_pred)}</pre>



<p>函数<strong> train_model </strong>和<strong> evaluate_model </strong>将是数据科学管道中的两个节点。<strong> Train_model </strong>训练随机森林分类器，在其中我们使用optuna帮助我们找到最佳超参数。这是使用<strong>物镜</strong>功能完成的。</p>



<p>对于每次试验，我们从<strong>目标</strong>函数中获得平均5倍的交叉验证准确性。我们将试验次数限制在100次。最后，使用最佳参数在完整的训练数据集上进行训练。</p>



<p>返回模型、指标字典和元数据字典。在<strong> evaluate_model </strong>函数中，我们使用训练好的模型并返回度量字典。为了在管道中获得所有这些，将以下代码添加到<strong>src/tutorial/pipelines/data _ science/pipeline . py</strong>:</p>



<pre class="hljs"><span class="hljs-string">"""
This is a boilerplate pipeline 'data_science'
generated using Kedro 0.17.7
"""</span>
 
<span class="hljs-keyword">from</span> kedro.pipeline <span class="hljs-keyword">import</span> Pipeline, node, pipeline
<span class="hljs-keyword">from</span> tutorial.pipelines.data_science.nodes <span class="hljs-keyword">import</span> train_model, evaluate_model
 
 
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_pipeline</span><span class="hljs-params">(**kwargs)</span> -&gt; Pipeline:</span>
   <span class="hljs-keyword">return</span> pipeline([
       node(
           func=train_model,
           inputs=[<span class="hljs-string">"train"</span>, <span class="hljs-string">"params:y_label"</span>, <span class="hljs-string">"params:features"</span>],
           outputs=[<span class="hljs-string">"model"</span>, <span class="hljs-string">"train_metrics"</span>, <span class="hljs-string">"features"</span>],
           name=<span class="hljs-string">"train_model"</span>
       ),
       node(
           func=evaluate_model,
           inputs=[<span class="hljs-string">"model"</span>, <span class="hljs-string">"test"</span>, <span class="hljs-string">"params:y_label"</span>, <span class="hljs-string">"params:features"</span>],
           outputs=<span class="hljs-string">"test_metrics"</span>,
           name=<span class="hljs-string">"evaluate_model"</span>
       )
   ])</pre>



<p>并通过将<strong>src/tutorial/pipeline _ registry . py</strong>修改为以下内容来注册管道:</p>



<pre class="hljs"><span class="hljs-string">"""Project pipelines."""</span>
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> Dict
 
<span class="hljs-keyword">from</span> kedro.pipeline <span class="hljs-keyword">import</span> Pipeline, pipeline
<span class="hljs-keyword">from</span> tutorial.pipelines <span class="hljs-keyword">import</span> data_processing <span class="hljs-keyword">as</span> dp
<span class="hljs-keyword">from</span> tutorial.pipelines <span class="hljs-keyword">import</span> data_science <span class="hljs-keyword">as</span> ds
 
 
 
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">register_pipelines</span><span class="hljs-params">()</span> -&gt; Dict[str, Pipeline]:</span>
   <span class="hljs-string">"""Register the project's pipelines.
 
   Returns:
       A mapping from a pipeline name to a ``Pipeline`` object.
   """</span>
   data_processing_pipeline = dp.create_pipeline()
   data_science_pipeline = ds.create_pipeline()
   <span class="hljs-keyword">return</span> {
       <span class="hljs-string">"__default__"</span>: data_processing_pipeline+data_science_pipeline,
       <span class="hljs-string">"ds"</span>: data_science_pipeline,
       <span class="hljs-string">"dp"</span>: data_processing_pipeline,
   }</pre>



<p>就是这样！<br/>如果你运行<strong> kedro viz </strong>，你会看到这样的内容:</p>



<div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img data-attachment-id="64362" data-permalink="https://web.archive.org/web/20220926093908/https://neptune.ai/kedro-pipelines-with-optuna-running-hyperparameter-sweeps_6" data-orig-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_6.png?fit=806%2C1332&amp;ssl=1" data-orig-size="806,1332" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Kedro Pipelines with Optuna: Running Hyperparameter Sweeps_6" data-image-description="" data-image-caption="" data-medium-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_6.png?fit=182%2C300&amp;ssl=1" data-large-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_6.png?fit=620%2C1024&amp;ssl=1" src="../Images/785e309fcc4166fee216dd0b572f2ff6.png" alt="Writing the data science pipeline" class="wp-image-64362 jetpack-lazy-image" data-recalc-dims="1" data-lazy-src="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_6.png?resize=561%2C928&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://web.archive.org/web/20220926093908im_/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_6.png?resize=561%2C928&amp;ssl=1"/><noscript><img data-lazy-fallback="1" data-attachment-id="64362" data-permalink="https://web.archive.org/web/20220926093908/https://neptune.ai/kedro-pipelines-with-optuna-running-hyperparameter-sweeps_6" data-orig-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_6.png?fit=806%2C1332&amp;ssl=1" data-orig-size="806,1332" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Kedro Pipelines with Optuna: Running Hyperparameter Sweeps_6" data-image-description="" data-image-caption="" data-medium-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_6.png?fit=182%2C300&amp;ssl=1" data-large-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_6.png?fit=620%2C1024&amp;ssl=1" src="../Images/785e309fcc4166fee216dd0b572f2ff6.png" alt="Writing the data science pipeline" class="wp-image-64362" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20220926093908im_/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_6.png?resize=561%2C928&amp;ssl=1"/></noscript><figcaption><em>Source: Author</em></figcaption></figure></div>



<p>这个DAG(有向无环图)代表了我们的整个工作流程。从原始数据集到训练测试分割，再到训练、记录和评估。这就是当我们运行时它是如何被执行的。</p>



<p>在运行管道之前，我们将把它添加到<strong> conf/base/catalog.yml </strong>:</p>



<pre class="hljs">train_metrics:
 type: tracking.MetricsDataSet
 filepath: data/<span class="hljs-number">09</span>_tracking/train_metrics.json
 
 
test_metrics:
 type: tracking.MetricsDataSet
 filepath: data/<span class="hljs-number">09</span>_tracking/test_metrics.json
 
 
features:
 type: tracking.JSONDataSet
 filepath: data/<span class="hljs-number">09</span>_tracking/features.json
 
model:
 type: pickle.PickleDataSet
 filepath: data/<span class="hljs-number">06</span>_models/model.pkl
 backend: pickle</pre>



<p>这将告诉Kedro跟踪来自<strong> train_model </strong>和<strong> evaluate_model </strong>函数的度量、元数据和模型。要运行管道，输入<strong> kedro run </strong>。</p>



<p>您可以在CLI中看到类似的内容:</p>



<pre class="hljs"><span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">47</span>,<span class="hljs-number">713</span> - kedro.io.data_catalog - INFO - Loading data <span class="hljs-keyword">from</span> `params:y_label` (MemoryDataSet)...
<span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">47</span>,<span class="hljs-number">714</span> - kedro.io.data_catalog - INFO - Loading data <span class="hljs-keyword">from</span> `params:features` (MemoryDataSet)...
<span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">47</span>,<span class="hljs-number">714</span> - kedro.pipeline.node - INFO - Running node: train_model: train_model([train,params:y_label,params:features]) -&gt; [model,train_metrics,features]
[I <span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">47</span>,<span class="hljs-number">724</span>] A new study created <span class="hljs-keyword">in</span> memory <span class="hljs-keyword">with</span> name: no-name<span class="hljs-number">-587</span>db03d-d58a<span class="hljs-number">-49</span>a9<span class="hljs-number">-80</span>b9-c5683b044758
[I <span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">48</span>,<span class="hljs-number">570</span>] Trial <span class="hljs-number">0</span> finished <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6478139043087496</span> <span class="hljs-keyword">and</span> parameters: {<span class="hljs-string">'n_estimators'</span>: <span class="hljs-number">20</span>, <span class="hljs-string">'max_depth'</span>: <span class="hljs-number">15.080923501597061</span>}. Best <span class="hljs-keyword">is</span> trial <span class="hljs-number">0</span> <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6478139043087496</span>.
[I <span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">48</span>,<span class="hljs-number">923</span>] Trial <span class="hljs-number">1</span> finished <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.5664393338620142</span> <span class="hljs-keyword">and</span> parameters: {<span class="hljs-string">'n_estimators'</span>: <span class="hljs-number">46</span>, <span class="hljs-string">'max_depth'</span>: <span class="hljs-number">1.9884986491873076</span>}. Best <span class="hljs-keyword">is</span> trial <span class="hljs-number">0</span> <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6478139043087496</span>.
[I <span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">49</span>,<span class="hljs-number">275</span>] Trial <span class="hljs-number">2</span> finished <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6550145387258789</span> <span class="hljs-keyword">and</span> parameters: {<span class="hljs-string">'n_estimators'</span>: <span class="hljs-number">26</span>, <span class="hljs-string">'max_depth'</span>: <span class="hljs-number">18.841791623627735</span>}. Best <span class="hljs-keyword">is</span> trial <span class="hljs-number">2</span> <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6550145387258789</span>.
[I <span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">49</span>,<span class="hljs-number">589</span>] Trial <span class="hljs-number">3</span> finished <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6055881575469204</span> <span class="hljs-keyword">and</span> parameters: {<span class="hljs-string">'n_estimators'</span>: <span class="hljs-number">31</span>, <span class="hljs-string">'max_depth'</span>: <span class="hljs-number">5.408170166043053</span>}. Best <span class="hljs-keyword">is</span> trial <span class="hljs-number">2</span> <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6550145387258789</span>.
[I <span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">49</span>,<span class="hljs-number">669</span>] Trial <span class="hljs-number">4</span> finished <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6436901929685435</span> <span class="hljs-keyword">and</span> parameters: {<span class="hljs-string">'n_estimators'</span>: <span class="hljs-number">32</span>, <span class="hljs-string">'max_depth'</span>: <span class="hljs-number">11.246378990753412</span>}. Best <span class="hljs-keyword">is</span> trial <span class="hljs-number">2</span> <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6550145387258789</span>.
[I <span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">49</span>,<span class="hljs-number">787</span>] Trial <span class="hljs-number">5</span> finished <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6529738302934179</span> <span class="hljs-keyword">and</span> parameters: {<span class="hljs-string">'n_estimators'</span>: <span class="hljs-number">50</span>, <span class="hljs-string">'max_depth'</span>: <span class="hljs-number">15.218464760076643</span>}. Best <span class="hljs-keyword">is</span> trial <span class="hljs-number">2</span> <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6550145387258789</span>.
[I <span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">49</span>,<span class="hljs-number">828</span>] Trial <span class="hljs-number">6</span> finished <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.628263283108644</span> <span class="hljs-keyword">and</span> parameters: {<span class="hljs-string">'n_estimators'</span>: <span class="hljs-number">13</span>, <span class="hljs-string">'max_depth'</span>: <span class="hljs-number">13.689325469239577</span>}. Best <span class="hljs-keyword">is</span> trial <span class="hljs-number">2</span> <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6550145387258789</span>.
[I <span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">49</span>,<span class="hljs-number">884</span>] Trial <span class="hljs-number">7</span> finished <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6457361882104149</span> <span class="hljs-keyword">and</span> parameters: {<span class="hljs-string">'n_estimators'</span>: <span class="hljs-number">23</span>, <span class="hljs-string">'max_depth'</span>: <span class="hljs-number">9.102926797194122</span>}. Best <span class="hljs-keyword">is</span> trial <span class="hljs-number">2</span> <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6550145387258789</span>.
[I <span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">49</span>,<span class="hljs-number">972</span>] Trial <span class="hljs-number">8</span> finished <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6591488236849061</span> <span class="hljs-keyword">and</span> parameters: {<span class="hljs-string">'n_estimators'</span>: <span class="hljs-number">40</span>, <span class="hljs-string">'max_depth'</span>: <span class="hljs-number">19.407785624206216</span>}. Best <span class="hljs-keyword">is</span> trial <span class="hljs-number">8</span> <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6591488236849061</span>.
[I <span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">50</span>,<span class="hljs-number">047</span>] Trial <span class="hljs-number">9</span> finished <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.600385937086968</span> <span class="hljs-keyword">and</span> parameters: {<span class="hljs-string">'n_estimators'</span>: <span class="hljs-number">36</span>, <span class="hljs-string">'max_depth'</span>: <span class="hljs-number">4.213221746044185</span>}. Best <span class="hljs-keyword">is</span> trial <span class="hljs-number">8</span> <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6591488236849061</span>.
[I <span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">50</span>,<span class="hljs-number">072</span>] Trial <span class="hljs-number">10</span> finished <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.5519851969336506</span> <span class="hljs-keyword">and</span> parameters: {<span class="hljs-string">'n_estimators'</span>: <span class="hljs-number">5</span>, <span class="hljs-string">'max_depth'</span>: <span class="hljs-number">1.296628908687125</span>}. Best <span class="hljs-keyword">is</span> trial <span class="hljs-number">8</span> <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6591488236849061</span>.
[I <span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">50</span>,<span class="hljs-number">155</span>] Trial <span class="hljs-number">11</span> finished <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6230769230769231</span> <span class="hljs-keyword">and</span> parameters: {<span class="hljs-string">'n_estimators'</span>: <span class="hljs-number">41</span>, <span class="hljs-string">'max_depth'</span>: <span class="hljs-number">7.236080573101756</span>}. Best <span class="hljs-keyword">is</span> trial <span class="hljs-number">8</span> <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6591488236849061</span>.
[I <span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">50</span>,<span class="hljs-number">222</span>] Trial <span class="hljs-number">12</span> finished <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6375469204335183</span> <span class="hljs-keyword">and</span> parameters: {<span class="hljs-string">'n_estimators'</span>: <span class="hljs-number">27</span>, <span class="hljs-string">'max_depth'</span>: <span class="hljs-number">17.394915525536124</span>}. Best <span class="hljs-keyword">is</span> trial <span class="hljs-number">8</span> <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6591488236849061</span>.
[I <span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">50</span>,<span class="hljs-number">261</span>] Trial <span class="hljs-number">13</span> finished <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.5726143272535025</span> <span class="hljs-keyword">and</span> parameters: {<span class="hljs-string">'n_estimators'</span>: <span class="hljs-number">16</span>, <span class="hljs-string">'max_depth'</span>: <span class="hljs-number">3.07366645685214</span>}. Best <span class="hljs-keyword">is</span> trial <span class="hljs-number">8</span> <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6591488236849061</span>.
[I <span class="hljs-number">2022</span><span class="hljs-number">-03</span><span class="hljs-number">-06</span> <span class="hljs-number">15</span>:<span class="hljs-number">23</span>:<span class="hljs-number">50</span>,<span class="hljs-number">364</span>] Trial <span class="hljs-number">14</span> finished <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6426592651334919</span> <span class="hljs-keyword">and</span> parameters: {<span class="hljs-string">'n_estimators'</span>: <span class="hljs-number">37</span>, <span class="hljs-string">'max_depth'</span>: <span class="hljs-number">19.982880063130665</span>}. Best <span class="hljs-keyword">is</span> trial <span class="hljs-number">8</span> <span class="hljs-keyword">with</span> value: <span class="hljs-number">0.6591488236849061</span>.
…</pre>



<p>使用这种端到端的管道，我们可以用最少的代码变化迭代实验。尝试做一些改变，并做多次运行</p>



<h3>实验跟踪</h3>



<p>运行多个实验最重要的部分是分析和比较结果。要在Kedro中做到这一点，运行kedro viz。在左边点击一个烧杯形状的图标。这将带你到你已经完成的所有运行的日志。指标和元数据可用于所有实验:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img data-attachment-id="64363" data-permalink="https://web.archive.org/web/20220926093908/https://neptune.ai/kedro-pipelines-with-optuna-running-hyperparameter-sweeps_5" data-orig-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_5.png?fit=1999%2C1157&amp;ssl=1" data-orig-size="1999,1157" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Kedro Pipelines with Optuna: Running Hyperparameter Sweeps_5" data-image-description="" data-image-caption="" data-medium-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_5.png?fit=300%2C174&amp;ssl=1" data-large-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_5.png?fit=1024%2C593&amp;ssl=1" src="../Images/d1b30b09400ca03f5c7932573080502a.png" alt="Experiment tracking" class="wp-image-64363 jetpack-lazy-image" data-recalc-dims="1" data-lazy-src="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_5.png?resize=1024%2C593&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://web.archive.org/web/20220926093908im_/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_5.png?resize=1024%2C593&amp;ssl=1"/><noscript><img data-lazy-fallback="1" data-attachment-id="64363" data-permalink="https://web.archive.org/web/20220926093908/https://neptune.ai/kedro-pipelines-with-optuna-running-hyperparameter-sweeps_5" data-orig-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_5.png?fit=1999%2C1157&amp;ssl=1" data-orig-size="1999,1157" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Kedro Pipelines with Optuna: Running Hyperparameter Sweeps_5" data-image-description="" data-image-caption="" data-medium-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_5.png?fit=300%2C174&amp;ssl=1" data-large-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_5.png?fit=1024%2C593&amp;ssl=1" src="../Images/d1b30b09400ca03f5c7932573080502a.png" alt="Experiment tracking" class="wp-image-64363" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20220926093908im_/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_5.png?resize=1024%2C593&amp;ssl=1"/></noscript><figcaption><em>Source: Author</em></figcaption></figure></div>



<p>可以选择最多比较三个实验。在我们的例子中，它看起来像这样:</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><img data-attachment-id="64366" data-permalink="https://web.archive.org/web/20220926093908/https://neptune.ai/kedro-pipelines-with-optuna-running-hyperparameter-sweeps_2" data-orig-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_2.jpg?fit=1600%2C926&amp;ssl=1" data-orig-size="1600,926" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Kedro Pipelines with Optuna: Running Hyperparameter Sweeps_2" data-image-description="" data-image-caption="" data-medium-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_2.jpg?fit=300%2C174&amp;ssl=1" data-large-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_2.jpg?fit=1024%2C593&amp;ssl=1" src="../Images/9da7fba2dc260d5752f4254e41a98c3a.png" alt="Experiment tracking" class="wp-image-64366 jetpack-lazy-image" data-recalc-dims="1" data-lazy-src="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_2.jpg?resize=1024%2C593&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://web.archive.org/web/20220926093908im_/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_2.jpg?resize=1024%2C593&amp;ssl=1"/><noscript><img data-lazy-fallback="1" data-attachment-id="64366" data-permalink="https://web.archive.org/web/20220926093908/https://neptune.ai/kedro-pipelines-with-optuna-running-hyperparameter-sweeps_2" data-orig-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_2.jpg?fit=1600%2C926&amp;ssl=1" data-orig-size="1600,926" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Kedro Pipelines with Optuna: Running Hyperparameter Sweeps_2" data-image-description="" data-image-caption="" data-medium-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_2.jpg?fit=300%2C174&amp;ssl=1" data-large-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_2.jpg?fit=1024%2C593&amp;ssl=1" src="../Images/9da7fba2dc260d5752f4254e41a98c3a.png" alt="Experiment tracking" class="wp-image-64366" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20220926093908im_/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_2.jpg?resize=1024%2C593&amp;ssl=1"/></noscript><figcaption><em>Source: Author</em></figcaption></figure></div>



<p>我们可以看到，Kedro的实验跟踪仪表盘信息量并不大。它允许我们一次最多只能比较三个实验。虽然超参数搜索运行了超过100个具有多个指标和输入特征的试验，但我们不能使用这样的标准过滤掉试验。从这个意义上来说，这种可视化是非常基本的。我们需要更好的东西来观看我们的实验。</p>



<h3>将海王星的全面跟踪与Kedro和Optuna集成</h3>



<p>Neptune及其与多个开源框架的集成使得通过最小的代码更改来升级您的实验跟踪游戏变得非常简单。</p>



<h4>装置</h4>



<pre class="hljs">pip install neptune-client
pip install kedro-neptune
conda install -c conda-forge neptune-optuna </pre>



<p><a href="https://web.archive.org/web/20220926093908/https://app.neptune.ai/get_my_api_token" target="_blank" rel="noreferrer noopener">在这里获取您的API令牌</a>并运行kedro neptune init。这将把所有必要的Neptune相关文件添加到您的项目中。</p>



<p>对于数据科学管道中的nodes.py，我们将添加&lt; 10行，让Neptune进行跟踪。更新后的文件如下所示:</p>



<pre class="hljs"><span class="hljs-string">"""
This is a boilerplate pipeline 'data_science'
generated using Kedro 0.17.7
"""</span>
<span class="hljs-keyword">from</span> distutils.log <span class="hljs-keyword">import</span> Log
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LogisticRegression
<span class="hljs-keyword">from</span> sklearn.ensemble <span class="hljs-keyword">import</span> RandomForestClassifier
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> cross_val_score
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score
<span class="hljs-keyword">from</span> kedro.io <span class="hljs-keyword">import</span> MemoryDataSet
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> optuna
<span class="hljs-keyword">import</span> neptune.new <span class="hljs-keyword">as</span> neptune
<span class="hljs-keyword">import</span> neptune.new.integrations.optuna <span class="hljs-keyword">as</span> optuna_utils
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> scikitplot.metrics <span class="hljs-keyword">import</span> plot_confusion_matrix
 
 
run = neptune.init(
   api_token=<span class="hljs-string">'&lt;api_token&gt;'</span>,
   project=<span class="hljs-string">'&lt;project_name&gt;'</span>
)
neptune_callback = optuna_utils.NeptuneCallback(run=run, base_namespace=<span class="hljs-string">"my_hpo"</span>)
 
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">train_model</span><span class="hljs-params">(df_train, y_label, features, neptune_run:  neptune.handler.Handler)</span>:</span>
   X_train = df_train[features].values
   y_train = df_train[y_label].values
 
   <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">objective</span><span class="hljs-params">(trial)</span>:</span>
       n_estimators = trial.suggest_int(<span class="hljs-string">'n_estimators'</span>, <span class="hljs-number">2</span>, <span class="hljs-number">50</span>)
       max_depth = int(trial.suggest_loguniform(<span class="hljs-string">'max_depth'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">20</span>))
       model = RandomForestClassifier(n_estimators=n_estimators, max_depth=max_depth)
       <span class="hljs-keyword">return</span> cross_val_score(model, X_train, y_train,
           n_jobs=<span class="hljs-number">-1</span>, cv=<span class="hljs-number">5</span>).mean()
 
   study = optuna.create_study(direction=<span class="hljs-string">'maximize'</span>)
   study.optimize(objective, n_trials=<span class="hljs-number">10</span>, callbacks=[neptune_callback])
   model = RandomForestClassifier(**study.best_params)
   model.fit(X_train, y_train)
 
   y_pred = model.predict(X_train)
   acc = accuracy_score(y_train, y_pred)
   neptune_run[<span class="hljs-string">'nodes/report/train_accuracy'</span>] = acc
   fig, ax = plt.subplots()
   plot_confusion_matrix(y_train, y_pred, ax=ax)
   neptune_run[<span class="hljs-string">'nodes/report/train_confusion_matrix'</span>].upload(fig)
   <span class="hljs-keyword">return</span> model, {<span class="hljs-string">"acc"</span>:acc}, {<span class="hljs-string">"features"</span>:features, <span class="hljs-string">"model_type"</span>: <span class="hljs-string">"RandomForest"</span>}
 
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">evaluate_model</span><span class="hljs-params">(model, df_test, y_label, features, neptune_run)</span>:</span>
   X_test = df_test[features].values
   y_test = df_test[y_label].values
   y_pred = model.predict(X_test)
   acc = accuracy_score(y_test, y_pred)
   neptune_run[<span class="hljs-string">'nodes/report/test_accuracy'</span>] = acc
   fig, ax = plt.subplots()
   plot_confusion_matrix(y_test, y_pred, ax=ax)
   neptune_run[<span class="hljs-string">'nodes/report/test_confusion_matrix'</span>].upload(fig)
   <span class="hljs-keyword">return</span> {<span class="hljs-string">"acc"</span>: accuracy_score(y_test, y_pred)}</pre>



<p>在这种情况下，我们记录准确度和混淆矩阵图。查看Neptune文档，了解关于<a href="https://web.archive.org/web/20220926093908/https://docs.neptune.ai/you-should-know/what-can-you-log-and-display" target="_blank" rel="noreferrer noopener">的更多信息，您还可以记录哪些数据</a>。</p>



<div id="blog-cta-intext-block_624aefb61734d" class="blog-cta-intext">
  <h3 class="blog-cta-intext__title">了解更多信息</h3>
  <div class="blog-cta-intext__content"><p>💡探索kedro与Neptune 的集成——它让您拥有组织良好的Kedro管道的所有好处，并为ML元数据管理构建了强大的用户界面。</p>
</div>
  </div>


<p>确保添加了API令牌和项目名称。最后，将<strong> train_model </strong>和<strong> evaluate_model </strong>函数中额外的<strong> neptune_run </strong>参数添加到我们的流水线中:</p>



<pre class="hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_pipeline</span><span class="hljs-params">(**kwargs)</span> -&gt; Pipeline:</span>
   <span class="hljs-keyword">return</span> pipeline([
       node(
           func=train_model,
           inputs=[<span class="hljs-string">"train"</span>, <span class="hljs-string">"params:y_label"</span>, <span class="hljs-string">"params:features"</span>, <span class="hljs-string">"neptune_run"</span>],
           outputs=[<span class="hljs-string">"model"</span>, <span class="hljs-string">"train_metrics"</span>, <span class="hljs-string">"features"</span>],
           name=<span class="hljs-string">"train_model"</span>
       ),
       node(
           func=evaluate_model,
           inputs=[<span class="hljs-string">"model"</span>, <span class="hljs-string">"test"</span>, <span class="hljs-string">"params:y_label"</span>, <span class="hljs-string">"params:features"</span>, <span class="hljs-string">"neptune_run"</span>],
           outputs=<span class="hljs-string">"test_metrics"</span>,
           name=<span class="hljs-string">"evaluate_model"</span>
       )
   ])</pre>



<p>就是这样！现在我们坐下来，看着我们的生活变得更容易，当我们做一个凯德罗运行。在你的跑步结束后，进入Neptune的项目仪表板，在那里我们会看到两种类型的跑步，一种是Kedro，另一种是Optuna，这样的跑步有五组。</p>



<div class="wp-block-image"><figure class="aligncenter size-large"><a href="https://web.archive.org/web/20220926093908/https://app.neptune.ai/dhruvil/kedro-optuna/experiments?split=tbl&amp;dash=charts&amp;viewId=standard-view" target="_blank" rel="noopener"><img data-attachment-id="64364" data-permalink="https://web.archive.org/web/20220926093908/https://neptune.ai/kedro-pipelines-with-optuna-running-hyperparameter-sweeps_4" data-orig-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_4.png?fit=1441%2C798&amp;ssl=1" data-orig-size="1441,798" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Kedro Pipelines with Optuna: Running Hyperparameter Sweeps_4" data-image-description="" data-image-caption="" data-medium-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_4.png?fit=300%2C166&amp;ssl=1" data-large-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_4.png?fit=1024%2C567&amp;ssl=1" src="../Images/e22f8d9c6ae2c48350f30722dd03f5e1.png" alt="Neptune dashboard: Kedro-Optuna" class="wp-image-64364 jetpack-lazy-image" data-recalc-dims="1" data-lazy-src="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_4.png?resize=1024%2C567&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://web.archive.org/web/20220926093908im_/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_4.png?resize=1024%2C567&amp;ssl=1"/><noscript><img data-lazy-fallback="1" data-attachment-id="64364" data-permalink="https://web.archive.org/web/20220926093908/https://neptune.ai/kedro-pipelines-with-optuna-running-hyperparameter-sweeps_4" data-orig-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_4.png?fit=1441%2C798&amp;ssl=1" data-orig-size="1441,798" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Kedro Pipelines with Optuna: Running Hyperparameter Sweeps_4" data-image-description="" data-image-caption="" data-medium-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_4.png?fit=300%2C166&amp;ssl=1" data-large-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_4.png?fit=1024%2C567&amp;ssl=1" src="../Images/e22f8d9c6ae2c48350f30722dd03f5e1.png" alt="Neptune dashboard: Kedro-Optuna" class="wp-image-64364" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20220926093908im_/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-Pipelines-with-Optuna-Running-Hyperparameter-Sweeps_4.png?resize=1024%2C567&amp;ssl=1"/></noscript></a><figcaption><em>Kedro-Optuna dashboard in Neptune.ai | <a href="https://web.archive.org/web/20220926093908/https://app.neptune.ai/dhruvil/kedro-optuna/experiments?split=tbl&amp;dash=charts&amp;viewId=standard-view" target="_blank" rel="noreferrer noopener">Source</a></em></figcaption></figure></div>





<p id="block_624af30017351" class="separator separator-20"/>



<div class="wp-block-image"><figure class="aligncenter size-large"><a href="https://web.archive.org/web/20220926093908/https://neptune.ai/kedro-pipelines-with-optuna-running-hyperparameter-sweeps/attachment/kedro-optuna-neptune-runs" target="_blank" rel="noopener"><img data-attachment-id="64520" data-permalink="https://web.archive.org/web/20220926093908/https://neptune.ai/kedro-pipelines-with-optuna-running-hyperparameter-sweeps/attachment/kedro-optuna-neptune-runs" data-orig-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-optuna-neptune-runs.png?fit=1249%2C921&amp;ssl=1" data-orig-size="1249,921" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Kedro-optuna-neptune runs" data-image-description="" data-image-caption="" data-medium-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-optuna-neptune-runs.png?fit=300%2C221&amp;ssl=1" data-large-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-optuna-neptune-runs.png?fit=1024%2C755&amp;ssl=1" src="../Images/0c57da05e0ce65d835754fd6f7ef84a6.png" alt="Kedro-optuna-neptune runs" class="wp-image-64520 jetpack-lazy-image" data-recalc-dims="1" data-lazy-src="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-optuna-neptune-runs.png?resize=1024%2C755&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-original-src="https://web.archive.org/web/20220926093908im_/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-optuna-neptune-runs.png?resize=1024%2C755&amp;ssl=1"/><noscript><img data-lazy-fallback="1" data-attachment-id="64520" data-permalink="https://web.archive.org/web/20220926093908/https://neptune.ai/kedro-pipelines-with-optuna-running-hyperparameter-sweeps/attachment/kedro-optuna-neptune-runs" data-orig-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-optuna-neptune-runs.png?fit=1249%2C921&amp;ssl=1" data-orig-size="1249,921" data-comments-opened="0" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="Kedro-optuna-neptune runs" data-image-description="" data-image-caption="" data-medium-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-optuna-neptune-runs.png?fit=300%2C221&amp;ssl=1" data-large-file="https://web.archive.org/web/20220926093908/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-optuna-neptune-runs.png?fit=1024%2C755&amp;ssl=1" src="../Images/0c57da05e0ce65d835754fd6f7ef84a6.png" alt="Kedro-optuna-neptune runs" class="wp-image-64520" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20220926093908im_/https://i0.wp.com/neptune.ai/wp-content/uploads/Kedro-optuna-neptune-runs.png?resize=1024%2C755&amp;ssl=1"/></noscript></a><figcaption><em>Kedro-Optuna dashboard in Neptune.ai | <a href="https://web.archive.org/web/20220926093908/https://app.neptune.ai/dhruvil/kedro-optuna/experiments?compare=EwBgNMEUA&amp;split=cmp&amp;dash=leaderboard&amp;viewId=standard-view" target="_blank" rel="noreferrer noopener">Source</a></em></figcaption></figure></div>



<p>您可以记录和比较任意多的运行，从而克服Kedro强加的三个实验限制。您还可以<a href="https://web.archive.org/web/20220926093908/https://docs.neptune.ai/you-should-know/comparing-runs" target="_blank" rel="noreferrer noopener">添加或删除您希望比较</a>很容易完成的列(指标),在这种情况下，我们已经选择了训练和测试的准确性和执行时间。除了所有的指标和图表，Neptune还记录了<a href="https://web.archive.org/web/20220926093908/https://docs.neptune.ai/you-should-know/what-can-you-log-and-display#code" target="_blank" rel="noreferrer noopener">源代码</a>、<a href="https://web.archive.org/web/20220926093908/https://docs.neptune.ai/you-should-know/what-can-you-log-and-display#hardware-consumption" target="_blank" rel="noreferrer noopener">资源利用率</a>，以及一组更丰富的<a href="https://web.archive.org/web/20220926093908/https://docs.neptune.ai/you-should-know/what-can-you-log-and-display" target="_blank" rel="noreferrer noopener">元数据</a>。</p>



<h2>结论</h2>



<p>数据科学家在一个非常混乱的环境中工作，可能会有许多可能被忽视的重大错误来源。因此，我们需要可靠的系统来减少项目的组织开销。Kedro和Optuna将大部分端到端工作流自动化，让数据科学家专注于设计方法和实验的关键任务。此外，当与诸如Neptune之类的工具的综合实验管理工具相结合时，在实验中进行比较和协作变得更加容易。</p>



<p>ML-Ops空间是一个广阔的空间，而且增长速度比以往任何时候都快。在本文中，我们讨论了用于管道和<a href="/web/20220926093908/https://neptune.ai/blog/hyperparameter-tuning-in-python-complete-guide" target="_blank" rel="noreferrer noopener">超参数优化</a>的工具。然而，<a href="/web/20220926093908/https://neptune.ai/blog/mlops" target="_blank" rel="noreferrer noopener"> MLOps </a>包含了更多的领域，比如特性存储、模型版本控制等等。你可以在这里找到关于同一<a href="https://web.archive.org/web/20220926093908/https://mlops.neptune.ai/" target="_blank" rel="noreferrer noopener">的完整列表。一定要检查一下，保持学习的势头。</a></p>



<h3>参考</h3>






<div id="author-box-new-format-block_60421833aff63" class="article__footer article__author">
  

  <div class="article__authorContent">
          <h3 class="article__authorContent-name">德鲁维尔·卡拉尼</h3>
    
          <p class="article__authorContent-text">i3systems India的数据科学家 <br/>一位热爱数学和编程的数据科学家。他以前的经验使他能够处理大规模的自然语言处理问题，如聊天机器人和文档理解。他认为，教育大众了解技术及其影响与开发新技术同样重要。</p>
    
          
    
  </div>
</div>


<div class="wp-container-1 wp-block-group"><div class="wp-block-group__inner-container">
<hr class="wp-block-separator"/>



<p class="has-text-color"><strong>阅读下一篇</strong></p>



<h2>如何跟踪机器学习模型的超参数？</h2>



<p class="has-small-font-size">卡米尔·卡什马雷克|发布于2020年7月1日</p>


<p id="block_5ffc75def9f8e" class="separator separator-10"/>



<p><strong>机器学习算法可通过称为超参数</strong>的多个量规进行调整。最近的深度学习模型可以通过数十个超参数进行调整，这些超参数与数据扩充参数和训练程序参数一起创建了非常复杂的空间。在强化学习领域，您还应该计算环境参数。</p>



<p>数据科学家要<strong>控制好</strong> <strong>超参数</strong> <strong>空间</strong>，才能<strong>使</strong> <strong>进步</strong>。</p>



<p>在这里，我们将向您展示<strong>最近的</strong> <strong>实践</strong>，<strong>提示&amp;技巧，</strong>和<strong>工具</strong>以最小的开销高效地跟踪超参数。你会发现自己掌控了最复杂的深度学习实验！</p>



<h2>为什么我应该跟踪我的超参数？也就是为什么这很重要？</h2>



<p>几乎每一个深度学习实验指南，像<a href="https://web.archive.org/web/20220926093908/https://www.deeplearningbook.org/contents/guidelines.html" target="_blank" rel="noreferrer noopener">这本深度学习书籍</a>，都建议你如何调整超参数，使模型按预期工作。在<strong>实验-分析-学习循环</strong>中，数据科学家必须控制正在进行的更改，以便循环的“学习”部分正常工作。</p>



<p>哦，忘了说<strong>随机种子也是一个超参数</strong>(特别是在RL领域:例如检查<a href="https://web.archive.org/web/20220926093908/https://www.reddit.com/r/MachineLearning/comments/76th74/d_why_random_seeds_sometimes_have_quite_large/" target="_blank" rel="noreferrer noopener">这个Reddit </a>)。</p>



<h2>超参数跟踪的当前实践是什么？</h2>



<p>让我们逐一回顾一下管理超参数的常见做法。我们关注于如何构建、保存和传递超参数给你的ML脚本。</p>


<a class="button continous-post blue-filled" href="/web/20220926093908/https://neptune.ai/blog/how-to-track-hyperparameters" target="_blank">
    Continue reading -&gt;</a>



<hr class="wp-block-separator"/>
</div></div>
</div>
      </div>    
</body>
</html>