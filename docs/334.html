<html>
<head>
<title>Keras Metrics: Everything You Need to Know </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Keras Metrics:æ‚¨éœ€è¦çŸ¥é“çš„ä¸€åˆ‡</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://web.archive.org/web/https://neptune.ai/blog/keras-metrics#0001-01-01">https://web.archive.org/web/https://neptune.ai/blog/keras-metrics#0001-01-01</a></blockquote><div><div class="article__content col-lg-10">
<p>KerasæŒ‡æ ‡æ˜¯ç”¨äºè¯„ä¼°æ·±åº¦å­¦ä¹ æ¨¡å‹æ€§èƒ½çš„å‡½æ•°ã€‚ä¸ºæ‚¨çš„é—®é¢˜é€‰æ‹©ä¸€ä¸ªå¥½çš„åº¦é‡æ ‡å‡†é€šå¸¸æ˜¯ä¸€é¡¹å›°éš¾çš„ä»»åŠ¡ã€‚</p>


<div class="custom-point-list">
<ul><li>ä½ éœ€è¦äº†è§£ã€tf.keraså’Œtf.kerasä¸­å“ªäº›æŒ‡æ ‡å·²ç»å¯ç”¨ä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒä»¬ï¼Œ</li><li>åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦<strong>å®šä¹‰æ‚¨è‡ªå·±çš„å®šåˆ¶æŒ‡æ ‡</strong>ï¼Œå› ä¸ºæ‚¨æ­£åœ¨å¯»æ‰¾çš„æŒ‡æ ‡æ²¡æœ‰éšKerasä¸€èµ·æä¾›ã€‚</li><li>æœ‰æ—¶ï¼Œæ‚¨å¸Œæœ›<strong>é€šè¿‡åœ¨æ¯ä¸ªæ—¶æœŸåæŸ¥çœ‹ROCæ›²çº¿æˆ–æ··æ·†çŸ©é˜µ</strong>ç­‰å›¾è¡¨æ¥ç›‘æ§æ¨¡å‹æ€§èƒ½ã€‚</li></ul>
</div>

<div class="note">
    <h3>æœ¬æ–‡å°†è§£é‡Šä¸€äº›æœ¯è¯­:</h3>
    <div class="content">
                    <div class="wysiwyg_editor">
                                    <ul id="block-4c25750e-81b5-410c-ba1f-bb452e425e74" class="block-editor-block-list__block is-selected rich-text block-editor-rich-text__editable wp-block" tabindex="0" role="textbox" contenteditable="true" spellcheck="false" aria-label="Write listâ€¦" aria-multiline="true" data-block="4c25750e-81b5-410c-ba1f-bb452e425e74" data-type="core/list" data-title="List">
<li>kerasåº¦é‡å‡†ç¡®æ€§</li>
<li>kerasç¼–è¯‘æŒ‡æ ‡</li>
<li>kerasè‡ªå®šä¹‰æŒ‡æ ‡</li>
<li>å›å½’çš„kerasåº¦é‡</li>
<li>kerasæ··æ·†çŸ©é˜µ</li>
<li>tf.kerac.metrics.meaniou</li>
<li>tf.keras.metrics f1åˆ†æ•°</li>
<li>tf.keras.metrics.auc</li>
</ul>
                            </div>
            </div>
</div>



<h2>Keras metrics 101</h2>



<p>åœ¨Kerasä¸­ï¼Œåº¦é‡åœ¨ç¼–è¯‘é˜¶æ®µä¼ é€’ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚æ‚¨å¯ä»¥é€šè¿‡é€—å·åˆ†éš”æ¥ä¼ é€’å¤šä¸ªæŒ‡æ ‡ã€‚</p>



<pre class="hljs"><span class="hljs-keyword">from</span> keras <span class="hljs-keyword">import</span> metrics

model.compile(loss=<span class="hljs-string">'mean_squared_error'</span>, optimizer=<span class="hljs-string">'sgd'</span>,
              metrics=[metrics.mae,
                       metrics.categorical_accuracy])</pre>



<p>æ‚¨åº”è¯¥å¦‚ä½•é€‰æ‹©è¿™äº›è¯„ä¼°æŒ‡æ ‡ï¼Ÿ</p>



<p>å…¶ä¸­ä¸€äº›åœ¨Kerasä¸­å¯ç”¨ï¼Œå¦ä¸€äº›åœ¨tf.kerasä¸­å¯ç”¨ã€‚</p>



<p>è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹æ‰€æœ‰è¿™äº›æƒ…å†µã€‚</p>



<h2>Kerasä¸­æä¾›äº†å“ªäº›æŒ‡æ ‡ï¼Ÿ</h2>



<p>Kerasæä¾›äº†ä¸°å¯Œçš„å†…ç½®æŒ‡æ ‡ã€‚æ ¹æ®ä½ çš„é—®é¢˜ï¼Œä½ ä¼šä½¿ç”¨ä¸åŒçš„ã€‚</p>



<p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹ä½ å¯èƒ½æ­£åœ¨è§£å†³çš„ä¸€äº›é—®é¢˜ã€‚</p>



<h3>äºŒå…ƒåˆ†ç±»</h3>



<p>äºŒå…ƒåˆ†ç±»åº¦é‡ç”¨äºåªæ¶‰åŠä¸¤ä¸ªç±»åˆ«çš„è®¡ç®—ã€‚ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ˜¯å»ºç«‹æ·±åº¦å­¦ä¹ <strong>æ¨¡å‹æ¥é¢„æµ‹çŒ«å’Œç‹—</strong>ã€‚æˆ‘ä»¬æœ‰ä¸¤ä¸ªç±»åˆ«è¦é¢„æµ‹ï¼Œé˜ˆå€¼å†³å®šäº†å®ƒä»¬ä¹‹é—´çš„åˆ†ç¦»ç‚¹ã€‚<strong> <em> binary_accuracy </em> </strong>å’Œ<strong> <em> accuracy </em> </strong>å°±æ˜¯Kerasä¸­çš„ä¸¤ä¸ªè¿™æ ·çš„å‡½æ•°ã€‚</p>



<p><em> <strong> binary_accuracy </strong>ï¼Œ</em>ä¾‹å¦‚ï¼Œè®¡ç®—äºŒè¿›åˆ¶åˆ†ç±»é—®é¢˜çš„æ‰€æœ‰é¢„æµ‹çš„å¹³å‡å‡†ç¡®ç‡ã€‚</p>



<pre class="hljs">keras.metrics.binary_accuracy(y_true, y_pred, threshold=<span class="hljs-number">0.5</span>)
</pre>



<p><strong> <em>å‡†ç¡®æ€§</em> </strong>æŒ‡æ ‡è®¡ç®—æ‰€æœ‰é¢„æµ‹çš„å‡†ç¡®ç‡ã€‚<em> y_true </em>ä»£è¡¨çœŸå®æ ‡ç­¾ï¼Œè€Œ<em> y_pred </em>ä»£è¡¨é¢„æµ‹æ ‡ç­¾ã€‚</p>



<pre class="hljs">keras.metrics.accuracy(y_true, y_pred)
</pre>



<p><em> <strong> confusion_matrix </strong> </em>æ˜¾ç¤ºä¸€ä¸ªè¡¨æ ¼ï¼Œæ˜¾ç¤ºçœŸé˜³æ€§ã€çœŸé˜´æ€§ã€å‡é˜³æ€§å’Œå‡é˜´æ€§ã€‚</p>



<pre class="hljs">keras.metrics.confusion_matrix(y_test, y_pred)
</pre>







<p>åœ¨ä¸Šé¢çš„æ··æ·†çŸ©é˜µä¸­ï¼Œæ¨¡å‹åšå‡ºäº†3305 + 375ä¸ªæ­£ç¡®çš„é¢„æµ‹ï¼Œ106 + 714ä¸ªé”™è¯¯çš„é¢„æµ‹ã€‚</p>



<p>ä½ ä¹Ÿå¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªmatplotlibå›¾è¡¨ï¼Œæˆ‘ä»¬ç¨åä¼šè®²åˆ°ã€‚</p>


<div class="note">
    <h3>ä»€ä¹ˆæ˜¯Kerasç²¾åº¦ï¼Ÿ</h3>
    <div class="content">
                    <div class="wysiwyg_editor">
                                    <p>è¿™ä¼¼ä¹å¾ˆç®€å•ï¼Œä½†å®é™…ä¸Šå¹¶ä¸æ˜æ˜¾ã€‚</p>
                            </div>
                    
                    <div class="wysiwyg_editor">
                                    <blockquote><p>æœ¯è¯­â€œå‡†ç¡®åº¦â€æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè®©<a href="https://web.archive.org/web/20220926093651/https://github.com/keras-team/keras/blob/d8b226f26b35348d934edb1213061993e7e5a1fa/keras/engine/training.py#L651" target="_blank" rel="noopener">è®­ç»ƒæ–‡ä»¶</a>å†³å®šåº”è¯¥ä½¿ç”¨å“ªä¸ªåº¦é‡æ ‡å‡†(<strong>äºŒè¿›åˆ¶å‡†ç¡®åº¦</strong>ã€<strong>åˆ†ç±»å‡†ç¡®åº¦</strong>æˆ–<strong>ç¨€ç–åˆ†ç±»å‡†ç¡®åº¦</strong>)ã€‚è¯¥å†³å®šåŸºäºæŸäº›å‚æ•°ï¼Œå¦‚è¾“å‡ºå½¢çŠ¶(ç”±è¯¥å±‚äº§ç”Ÿçš„å¼ é‡çš„å½¢çŠ¶ï¼Œå¹¶ä¸”å°†æ˜¯ä¸‹ä¸€å±‚çš„è¾“å…¥)å’ŒæŸå¤±å‡½æ•°ã€‚</p></blockquote>
                            </div>
                    <div class="wysiwyg_editor">
                                    <p>å› æ­¤ï¼Œæœ‰æ—¶è´¨ç–‘ç”šè‡³æ˜¯æœ€ç®€å•çš„äº‹æƒ…ä¹Ÿæ˜¯å¥½çš„ï¼Œå°¤å…¶æ˜¯å½“æ‚¨çš„åº¦é‡å‘ç”Ÿäº†æ„æƒ³ä¸åˆ°çš„äº‹æƒ…æ—¶ã€‚</p>
                            </div>
            </div>
</div>



<h3>å¤šç±»åˆ†ç±»</h3>



<p>è¿™äº›åº¦é‡ç”¨äºæ¶‰åŠä¸¤ä¸ªä»¥ä¸Šç±»åˆ«çš„åˆ†ç±»<strong>é—®é¢˜ã€‚æ‰©å±•æˆ‘ä»¬çš„åŠ¨ç‰©åˆ†ç±»ä¾‹å­ï¼Œä½ å¯ä»¥æœ‰ä¸‰ç§åŠ¨ç‰©ï¼ŒçŒ«ã€ç‹—å’Œç†Šã€‚å› ä¸ºæˆ‘ä»¬è¦å¯¹ä¸¤ç§ä»¥ä¸Šçš„åŠ¨ç‰©è¿›è¡Œåˆ†ç±»ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªå¤šç±»åˆ†ç±»é—®é¢˜ã€‚</strong></p>



<p><em> y_true </em>çš„å½¢çŠ¶æ˜¯æ¡ç›®æ•°ä¹˜ä»¥1ï¼Œå³(nï¼Œ1 ),ä½†æ˜¯<em> y_pred </em>çš„å½¢çŠ¶æ˜¯æ¡ç›®æ•°ä¹˜ä»¥ç±»æ•°(nï¼Œc)</p>



<p><em><strong>category _ accuracy</strong></em>æŒ‡æ ‡è®¡ç®—æ‰€æœ‰é¢„æµ‹çš„å¹³å‡å‡†ç¡®ç‡ã€‚</p>



<pre class="hljs">keras.metrics.categorical_accuracy(y_true, y_pred)
</pre>



<p><em><strong>sparse _ categorial _ accuracy</strong></em>ä¸<em>categorial _ accuracy</em>ç±»ä¼¼ï¼Œä½†å¤§å¤šåœ¨å¯¹ç¨€ç–ç›®æ ‡è¿›è¡Œé¢„æµ‹æ—¶ä½¿ç”¨<strong>ã€‚ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ˜¯åœ¨æ·±åº¦å­¦ä¹ é—®é¢˜ä¸­å¤„ç†æ–‡æœ¬ï¼Œå¦‚word2vecã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€ä¸ªäººç”¨<strong>æ•°åƒä¸ªç±»</strong>å·¥ä½œï¼Œç›®çš„æ˜¯é¢„æµ‹ä¸‹ä¸€ä¸ªå•è¯ã€‚è¿™ä¸ªä»»åŠ¡ä¼šäº§ç”Ÿä¸€ç§æƒ…å†µï¼Œy_trueæ˜¯ä¸€ä¸ªå‡ ä¹å…¨æ˜¯é›¶çš„å·¨å¤§çŸ©é˜µï¼Œè¿™æ˜¯ä½¿ç”¨ç¨€ç–çŸ©é˜µçš„æœ€ä½³ä½ç½®ã€‚</strong></p>



<pre class="hljs">keras.metrics.sparse_categorical_accuracy(y_true, y_pred)
</pre>



<p><em><strong>top _ k _ category _ accuracy</strong></em>è®¡ç®—top-kåˆ†ç±»å‡†ç¡®ç‡ã€‚æˆ‘ä»¬ä»æˆ‘ä»¬çš„æ¨¡å‹ä¸­å–å‡ºå‰kä¸ªé¢„æµ‹ç±»ï¼Œå¹¶æŸ¥çœ‹æ­£ç¡®çš„ç±»æ˜¯å¦è¢«é€‰ä¸ºå‰kä¸ªã€‚å¦‚æœæ˜¯ï¼Œæˆ‘ä»¬è¯´æˆ‘ä»¬çš„æ¨¡å‹æ˜¯æ­£ç¡®çš„ã€‚</p>



<pre class="hljs">keras.metrics.top_k_categorical_accuracy(y_true, y_pred, k=<span class="hljs-number">5</span>)
</pre>



<h3>å›å½’</h3>



<p>å›å½’é—®é¢˜ä¸­ä½¿ç”¨çš„åº¦é‡åŒ…æ‹¬<strong>å‡æ–¹è¯¯å·®ã€å¹³å‡ç»å¯¹è¯¯å·®å’Œå¹³å‡ç»å¯¹ç™¾åˆ†æ¯”è¯¯å·®ã€‚</strong>è¿™äº›æŒ‡æ ‡ç”¨äºé¢„æµ‹æˆ¿å±‹é”€å”®å’Œä»·æ ¼ç­‰æ•°å€¼ã€‚æŸ¥çœ‹è¿™ä¸ªå‚è€ƒèµ„æ–™ï¼Œè·å¾—å…³äºå›å½’åº¦é‡çš„<a href="https://web.archive.org/web/20220926093651/https://scikit-learn.org/stable/modules/model_evaluation.html#regression-metrics" target="_blank" rel="noreferrer noopener">å®Œæ•´æŒ‡å—ã€‚</a></p>



<pre class="hljs"><span class="hljs-keyword">from</span> keras <span class="hljs-keyword">import</span> metrics

model.compile(loss=<span class="hljs-string">'mse'</span>, optimizer=<span class="hljs-string">'adam'</span>, 
              metrics=[metrics.mean_squared_error, 
                       metrics.mean_absolute_error, 
                       metrics.mean_absolute_percentage_error])
                       metrics.categorical_accuracy])</pre>





<h2>å¦‚ä½•åœ¨Kerasä¸­åˆ›å»ºè‡ªå®šä¹‰æŒ‡æ ‡ï¼Ÿ</h2>



<p>æ­£å¦‚æˆ‘ä»¬å‰é¢æåˆ°çš„ï¼ŒKerasè¿˜å…è®¸æ‚¨å®šä¹‰è‡ªå·±çš„å®šåˆ¶æŒ‡æ ‡ã€‚</p>



<p>æ‚¨å®šä¹‰çš„å‡½æ•°<strong>å¿…é¡»å°†<em> y_true </em>å’Œ<em> y_pred </em>ä½œä¸ºå‚æ•°ï¼Œå¹¶ä¸”å¿…é¡»è¿”å›å•ä¸ªå¼ é‡å€¼</strong>ã€‚è¿™äº›å¯¹è±¡æ˜¯å…·æœ‰float32æ•°æ®ç±»å‹çš„å¼ é‡ç±»å‹ã€‚å¯¹è±¡çš„å½¢çŠ¶æ˜¯è¡Œæ•°ä¹˜ä»¥1ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæœ‰4ï¼Œ500ä¸ªæ¡ç›®ï¼Œå½¢çŠ¶å°†æ˜¯(4500ï¼Œ1)ã€‚</p>



<p>å¯ä»¥åœ¨æ·±åº¦å­¦ä¹ æ¨¡å‹çš„ç¼–è¯‘é˜¶æ®µä¼ é€’å‡½æ•°æ¥ä½¿ç”¨ã€‚</p>



<pre class="hljs">model.compile(...metrics=[your_custom_metric])</pre>



<h3>å¦‚ä½•è®¡ç®—Kerasä¸­çš„F1åˆ†æ•°(ç²¾åº¦ï¼Œå¬å›ä½œä¸ºåŠ åˆ†)ï¼Ÿ</h3>



<p>è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åœ¨Kerasä¸­è®¡ç®—<strong> f1åˆ†æ•°ã€ç²¾ç¡®åº¦å’Œå¬å›ç‡ã€‚</strong>æˆ‘ä»¬å°†ä¸ºå¤šç±»åœºæ™¯åˆ›å»ºå®ƒï¼Œä½†æ‚¨ä¹Ÿå¯ä»¥å°†å…¶ç”¨äºäºŒè¿›åˆ¶åˆ†ç±»ã€‚</p>



<p>f1åˆ†æ•°æ˜¯ç²¾ç¡®åº¦å’Œå¬å›ç‡çš„åŠ æƒå¹³å‡å€¼ã€‚å› æ­¤ï¼Œä¸ºäº†è®¡ç®—f1ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆåˆ›å»ºè®¡ç®—ç²¾åº¦å’Œå¬å›ç‡çš„å‡½æ•°ã€‚è¯·æ³¨æ„ï¼Œåœ¨å¤šç±»åœºæ™¯ä¸­ï¼Œæ‚¨éœ€è¦æŸ¥çœ‹æ‰€æœ‰çš„ç±»ï¼Œè€Œä¸ä»…ä»…æ˜¯æ­£ç±»(è¿™æ˜¯äºŒè¿›åˆ¶åˆ†ç±»çš„æƒ…å†µ)</p>



<pre class="hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">recall</span><span class="hljs-params">(y_true, y_pred)</span>:</span>
    y_true = K.ones_like(y_true) 
    true_positives = K.sum(K.round(K.clip(y_true * y_pred, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)))
    all_positives = K.sum(K.round(K.clip(y_true, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)))
    
    recall = true_positives / (all_positives + K.epsilon())
    <span class="hljs-keyword">return</span> recall

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">precision</span><span class="hljs-params">(y_true, y_pred)</span>:</span>
    y_true = K.ones_like(y_true) 
    true_positives = K.sum(K.round(K.clip(y_true * y_pred, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)))
    
    predicted_positives = K.sum(K.round(K.clip(y_pred, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)))
    precision = true_positives / (predicted_positives + K.epsilon())
    <span class="hljs-keyword">return</span> precision

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f1_score</span><span class="hljs-params">(y_true, y_pred)</span>:</span>
    precision = precision_m(y_true, y_pred)
    recall = recall_m(y_true, y_pred)
    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>*((precision*recall)/(precision+recall+K.epsilon()))
</pre>



<p>ä¸‹ä¸€æ­¥æ˜¯åœ¨æˆ‘ä»¬æ·±åº¦å­¦ä¹ æ¨¡å‹çš„ç¼–è¯‘é˜¶æ®µä½¿ç”¨è¿™äº›å‡½æ•°ã€‚æˆ‘ä»¬è¿˜æ·»åŠ äº†é»˜è®¤å¯ç”¨çš„Keras <em>å‡†ç¡®æ€§</em>æŒ‡æ ‡ã€‚</p>



<pre class="hljs">model.compile(...,metrics=[<span class="hljs-string">'accuracy'</span>, f1_score, precision, recall])
</pre>



<p>ç°åœ¨è®©æˆ‘ä»¬æ ¹æ®è®­ç»ƒé›†å’Œæµ‹è¯•é›†æ¥è°ƒæ•´æ¨¡å‹ã€‚</p>



<pre class="hljs">model.fit(x_train, y_train, epochs=<span class="hljs-number">5</span>)
</pre>



<p>ç°åœ¨æ‚¨å¯ä»¥è¯„ä¼°æ‚¨çš„æ¨¡å‹ï¼Œå¹¶è®¿é—®æ‚¨åˆšåˆšåˆ›å»ºçš„æŒ‡æ ‡ã€‚</p>



<pre class="hljs">(loss, 
accuracy, 
f1_score, precision, recall) = model.evaluate(x_test, y_test, verbose=<span class="hljs-number">1</span>)
</pre>



<p>å¾ˆå¥½ï¼Œæ‚¨ç°åœ¨çŸ¥é“å¦‚ä½•åœ¨kerasä¸­åˆ›å»ºå®šåˆ¶æŒ‡æ ‡äº†ã€‚</p>



<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ‰æ—¶ä½ å¯ä»¥ä½¿ç”¨å·²ç»å­˜åœ¨çš„ä¸œè¥¿ï¼Œåªæ˜¯åœ¨ä¸€ä¸ªä¸åŒçš„åº“ä¸­ï¼Œæ¯”å¦‚tf.kerasğŸ™‚</p>



<h2>tf.kerasä¸­æœ‰å“ªäº›æŒ‡æ ‡ï¼Ÿ</h2>



<p>æœ€è¿‘<strong> Keraså·²ç»æˆä¸ºTensorFlow </strong>ä¸­çš„æ ‡å‡†APIï¼Œæœ‰è®¸å¤šæœ‰ç”¨çš„æŒ‡æ ‡å¯ä¾›æ‚¨ä½¿ç”¨ã€‚</p>



<p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹å…¶ä¸­çš„ä¸€äº›ã€‚ä¸åœ¨Kerasä¸­åªä½¿ç”¨<em> keras.metrics </em>å‡½æ•°è°ƒç”¨æŒ‡æ ‡ä¸åŒï¼Œåœ¨tf.kerasä¸­ï¼Œæ‚¨å¿…é¡»å®ä¾‹åŒ–ä¸€ä¸ª<em>æŒ‡æ ‡</em>ç±»ã€‚</p>



<p>ä¾‹å¦‚:</p>



<pre class="hljs">tf.keras.metrics.Accuracy() 
</pre>



<p>kerasæŒ‡æ ‡å’Œtf.keras ä¹‹é—´æœ‰å¾ˆå¤šé‡å ã€‚ä½†æ˜¯ï¼Œæœ‰ä¸€äº›æŒ‡æ ‡ä½ åªèƒ½åœ¨tf.kerasä¸­æ‰¾åˆ°ã€‚</p>



<p>è®©æˆ‘ä»¬çœ‹çœ‹é‚£äº›ã€‚</p>



<h3>tf.kerasåˆ†ç±»æŒ‡æ ‡</h3>



<p><strong><em>TF . keras . metrics . AUC</em></strong>é€šè¿‡<a href="https://web.archive.org/web/20220926093651/https://www.khanacademy.org/math/ap-calculus-ab/ab-integration-new/ab-6-2/a/left-and-right-riemann-sums" target="_blank" rel="noreferrer noopener">é»æ›¼å’Œ</a>è®¡ç®—ROCæ›²çº¿çš„è¿‘ä¼¼AUC(æ›²çº¿ä¸‹é¢ç§¯)ã€‚</p>



<pre class="hljs">model.compile(<span class="hljs-string">'sgd'</span>, loss=<span class="hljs-string">'mse'</span>, metrics=[tf.keras.metrics.AUC()])
</pre>



<p>æ‚¨å¯ä»¥ä½¿ç”¨precisionï¼Œå›æƒ³ä¸€ä¸‹æˆ‘ä»¬ä»¥å‰åœ¨tf.kerasä¸­å®ç°çš„å¼€ç®±å³ç”¨ã€‚</p>



<pre class="hljs">model.compile(<span class="hljs-string">'sgd'</span>, loss=<span class="hljs-string">'mse'</span>, 
               metrics=[tf.keras.metrics.Precision(), 
                        tf.keras.metrics.Recall()])
</pre>



<h3>tf.kerasç»†åˆ†æŒ‡æ ‡</h3>



<p><em><strong>TF . keras . metrics . meaniou</strong></em>â€“<em>Mean Intersection-Over-Union</em>æ˜¯ç”¨äºè¯„ä¼°è¯­ä¹‰å›¾åƒåˆ†å‰²æ¨¡å‹çš„åº¦é‡ã€‚æˆ‘ä»¬é¦–å…ˆè®¡ç®—æ¯ä¸ªç±»çš„æ¬ æ¡:</p>







<p>æ‰€æœ‰ç­çº§çš„å¹³å‡å€¼ã€‚</p>



<pre class="hljs">model.compile(... metrics=[tf.keras.metrics.MeanIoU(num_classes=<span class="hljs-number">2</span>)])
</pre>



<h3>tf.keraså›å½’åº¦é‡</h3>



<p>å°±åƒKerasä¸€æ ·ï¼Œtf.kerasä¹Ÿæœ‰ç±»ä¼¼çš„å›å½’åº¦é‡ã€‚æˆ‘ä»¬ä¸ä¼šè¿‡å¤šè®¨è®ºå®ƒä»¬ï¼Œä½†æœ‰ä¸€ä¸ªæœ‰è¶£çš„æŒ‡æ ‡å€¼å¾—å¼ºè°ƒï¼Œå«åš<em> <strong>è¡¨ç¤ºç›¸å¯¹è¯¯å·®</strong> </em>ã€‚</p>



<p><em> <strong>è¡¨ç¤ºç›¸å¯¹è¯¯å·®</strong> </em>å–ä¸€æ¬¡è§‚æµ‹çš„ç»å¯¹è¯¯å·®ï¼Œé™¤ä»¥å¸¸æ•°ã€‚è¿™ä¸ªå¸¸æ•°ï¼Œ<strong>å½’ä¸€åŒ–å› å­</strong>ï¼Œå¯ä»¥å¯¹æ‰€æœ‰è§‚æµ‹å€¼ç›¸åŒï¼Œä¹Ÿå¯ä»¥å¯¹æ¯ä¸ªæ ·æœ¬ä¸åŒã€‚</p>



<p>å› æ­¤ï¼Œå¹³å‡ç›¸å¯¹è¯¯å·®æ˜¯ç›¸å¯¹è¯¯å·®çš„å¹³å‡å€¼ã€‚</p>



<pre class="hljs">tf.keras.metrics.MeanRelativeError(normalizer=[<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>])</pre>





<h2>å¦‚ä½•åœ¨tf.kerasä¸­åˆ›å»ºè‡ªå®šä¹‰æŒ‡æ ‡ï¼Ÿ</h2>



<p>åœ¨<em> tf.keras </em>ä¸­ï¼Œæ‚¨å¯ä»¥é€šè¿‡æ‰©å±•<em> keras.metrics.Metric </em>ç±»æ¥åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰æŒ‡æ ‡ã€‚</p>



<p>ä¸ºæ­¤ï¼Œæ‚¨å¿…é¡»è¦†ç›–update_stateã€resultå’Œreset_stateå‡½æ•°:</p>


<div class="custom-point-list">
<ul><li><em><strong>ã€update _ state()</strong></em>å¯¹çŠ¶æ€å˜é‡è¿›è¡Œæ‰€æœ‰æ›´æ–°å¹¶è®¡ç®—åº¦é‡ï¼Œ</li><li><em> <strong> result() </strong> </em>ä»çŠ¶æ€å˜é‡ä¸­è¿”å›åº¦é‡å€¼ï¼Œ</li><li><em> <strong> reset_state() </strong> </em>å°†æ¯ä¸ªæ—¶æœŸå¼€å§‹æ—¶çš„åº¦é‡å€¼è®¾ç½®ä¸ºé¢„å®šä¹‰çš„å¸¸æ•°(é€šå¸¸ä¸º0)</li></ul>
</div>


<pre class="hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MulticlassTruePositives</span><span class="hljs-params">(tf.keras.metrics.Metric)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, name=<span class="hljs-string">'multiclass_true_positives'</span>, **kwargs)</span>:</span>
        super(MulticlassTruePositives, self).__init__(name=name, **kwargs)
        self.true_positives = self.add_weight(name=<span class="hljs-string">'tp'</span>, initializer=<span class="hljs-string">'zeros'</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_state</span><span class="hljs-params">(self, y_true, y_pred, sample_weight=None)</span>:</span>
        y_pred = tf.reshape(tf.argmax(y_pred, axis=<span class="hljs-number">1</span>), shape=(<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>))
        values = tf.cast(y_true, <span class="hljs-string">'int32'</span>) == tf.cast(y_pred, <span class="hljs-string">'int32'</span>)
        values = tf.cast(values, <span class="hljs-string">'float32'</span>)
        <span class="hljs-keyword">if</span> sample_weight <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">None</span>:
            sample_weight = tf.cast(sample_weight, <span class="hljs-string">'float32'</span>)
            values = tf.multiply(values, sample_weight)
        self.true_positives.assign_add(tf.reduce_sum(values))

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">result</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-keyword">return</span> self.true_positives

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reset_states</span><span class="hljs-params">(self)</span>:</span>
        
        self.true_positives.assign(<span class="hljs-number">0.</span>)</pre>



<p>ç„¶åæˆ‘ä»¬ç®€å•åœ°åœ¨ç¼–è¯‘é˜¶æ®µä¼ é€’å®ƒ:</p>



<pre class="hljs">model.compile(...,metrics=[MulticlassTruePositives()])
</pre>





<h2>æ€§èƒ½å›¾è¡¨:Kerasä¸­çš„ROCæ›²çº¿å’Œæ··æ·†çŸ©é˜µ</h2>



<p><strong>æœ‰æ—¶ï¼Œæ€§èƒ½ä¸èƒ½ç”¨ä¸€ä¸ªæ•°å­—</strong>æ¥è¡¨ç¤ºï¼Œè€Œæ˜¯ç”¨æ€§èƒ½å›¾è¡¨æ¥è¡¨ç¤ºã€‚è¿™ç§å›¾è¡¨çš„ä¾‹å­æœ‰ROCæ›²çº¿æˆ–æ··æ·†çŸ©é˜µã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½å¸Œæœ›å°†è¿™äº›å›¾è¡¨è®°å½•åœ¨æŸä¸ªåœ°æ–¹ï¼Œä»¥ä¾¿è¿›ä¸€æ­¥æ£€æŸ¥ã€‚</p>



<p>ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œä½ éœ€è¦åˆ›å»ºä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå®ƒå°†åœ¨æ¯ä¸ªæ—¶æœŸç»“æŸæ—¶è·Ÿè¸ªä½ çš„æ¨¡å‹çš„æ€§èƒ½ã€‚ç„¶åï¼Œä½ å¯ä»¥åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­æˆ–è€…åœ¨<a href="https://web.archive.org/web/20220926093651/https://neptune.ai/blog/best-ml-experiment-tracking-tools" target="_blank" rel="noreferrer noopener">å®éªŒè·Ÿè¸ªå·¥å…·</a>ä¸­æŸ¥çœ‹æ”¹è¿›ã€‚è®©æˆ‘ä»¬å¼€å§‹å§ã€‚</p>



<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå›è°ƒï¼Œåœ¨æ¯ä¸ªæ—¶æœŸç»“æŸæ—¶åˆ›å»ºROCæ›²çº¿å’Œæ··æ·†çŸ©é˜µã€‚</p>



<pre class="hljs"><span class="hljs-keyword">import</span> os

<span class="hljs-keyword">from</span> keras.callbacks <span class="hljs-keyword">import</span> Callback
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> scikitplot.metrics <span class="hljs-keyword">import</span> plot_confusion_matrix, plot_roc


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PerformanceVisualizationCallback</span><span class="hljs-params">(Callback)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, model, validation_data, image_dir)</span>:</span>
        super().__init__()
        self.model = model
        self.validation_data = validation_data
        
        os.makedirs(image_dir, exist_ok=<span class="hljs-keyword">True</span>)
        self.image_dir = image_dir

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_epoch_end</span><span class="hljs-params">(self, epoch, logs={})</span>:</span>
        y_pred = np.asarray(self.model.predict(self.validation_data[<span class="hljs-number">0</span>]))
        y_true = self.validation_data[<span class="hljs-number">1</span>]             
        y_pred_class = np.argmax(y_pred, axis=<span class="hljs-number">1</span>)

        
        fig, ax = plt.subplots(figsize=(<span class="hljs-number">16</span>,<span class="hljs-number">12</span>))
        plot_confusion_matrix(y_true, y_pred_class, ax=ax)
        fig.savefig(os.path.join(self.image_dir, f<span class="hljs-string">'confusion_matrix_epoch_{epoch}'</span>))

       
        fig, ax = plt.subplots(figsize=(<span class="hljs-number">16</span>,<span class="hljs-number">12</span>))
        plot_roc(y_true, y_pred, ax=ax)
        fig.savefig(os.path.join(self.image_dir, f<span class="hljs-string">'roc_curve_epoch_{epoch}'</span>))
</pre>



<p>ç°åœ¨æˆ‘ä»¬ç®€å•åœ°å°†å®ƒä¼ é€’ç»™<em> model.fit() </em> callbackså‚æ•°ã€‚</p>



<pre class="hljs">performance_cbk = PerformanceVisualizationCallback(
                      model=model,
                      validation_data=validation_data,
                      image_dir=<span class="hljs-string">'performance_vizualizations'</span>)

history = model.fit(x=x_train,
                    y=y_train,
                    epochs=<span class="hljs-number">5</span>,
                    validation_data=validation_data,
                    callbacks=[performance_cbk])</pre>



<p>å¦‚æœä½ æ„¿æ„ï¼Œä½ å¯ä»¥æœ‰å¤šä¸ªå›è°ƒã€‚</p>



<p>ç°åœ¨ï¼Œæ‚¨å°†èƒ½å¤Ÿåœ¨æ¨¡å‹è®­ç»ƒæ—¶çœ‹åˆ°è¿™äº›å¯è§†åŒ–æ•ˆæœ:</p>



<figure class="wp-block-video"><video controls="" src="https://web.archive.org/web/20220926093651im_/https://neptune.ai/wp-content/uploads/keras_roc_curve_cut_hd.mp4"/></figure>



<p>ä½ ä¹Ÿå¯ä»¥åƒNeptuneä¸€æ ·æŠŠä¸€åˆ‡è®°å½•åˆ°å®éªŒè·Ÿè¸ªå·¥å…·ä¸­ã€‚è¿™ç§æ–¹æ³•å°†è®©æ‚¨åœ¨ä¸€ä¸ªåœ°æ–¹æ‹¥æœ‰æ‰€æœ‰çš„æ¨¡å‹å…ƒæ•°æ®ã€‚ä¸ºæ­¤ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<a href="https://web.archive.org/web/20220926093651/https://docs.neptune.ai/integrations-and-supported-tools/model-training/tensorflow-keras" target="_blank" rel="noreferrer noopener"> Neptune + TensorFlow / Kerasé›†æˆ</a>:</p>



<pre class="hljs">from neptune.new.integrations.tensorflow_keras <span class="hljs-keyword">import</span> NeptuneCallback
<span class="hljs-keyword">import</span> neptune.new <span class="hljs-keyword">as</span> neptune
from scikitplot.metrics <span class="hljs-keyword">import</span> plot_confusion_matrix
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

run = neptune.init(
        project=<span class="hljs-string">'YOUR_WORKSAPCE/YOUR_PROJECT_NAME'</span>,
        api_token=<span class="hljs-string">'YOUR_API_TOKEN'</span>)

</pre>



<p>è¯·æ³¨æ„ï¼Œæ‚¨ä¸éœ€è¦ä¸ºå›¾åƒåˆ›å»ºæ–‡ä»¶å¤¹ï¼Œå› ä¸ºå›¾è¡¨å°†ç›´æ¥å‘é€åˆ°æ‚¨çš„å·¥å…·ã€‚å¦ä¸€æ–¹é¢ï¼Œä½ å¿…é¡»<a href="https://web.archive.org/web/20220926093651/https://docs.neptune.ai/api-reference/management#.create_project" target="_blank" rel="noreferrer noopener">åˆ›å»ºä¸€ä¸ªé¡¹ç›®</a>æ¥å¼€å§‹è·Ÿè¸ªä½ çš„è·‘æ­¥ã€‚</p>



<p>ä¸€æ—¦ä½ åšåˆ°äº†è¿™ä¸€ç‚¹ï¼Œä¸€åˆ‡ç…§å¸¸ã€‚</p>



<pre class="hljs"><span class="hljs-attr">neptune_cbk</span> = NeptuneCallback(<span class="hljs-attr">run=run,</span> <span class="hljs-attr">base_namespace='metrics')</span>


<span class="hljs-attr">history</span> = model.fit(<span class="hljs-attr">x=x_train,</span>
                    <span class="hljs-attr">y=y_train,</span>
                    <span class="hljs-attr">epochs=5,</span>
                    <span class="hljs-attr">validation_data=validation_data,</span>
                    <span class="hljs-attr">callbacks=[neptune_cbk])</span>

fig, <span class="hljs-attr">ax</span> = plt.subplots(<span class="hljs-attr">figsize=(16,</span> <span class="hljs-number">12</span>))
plot_confusion_matrix(y_train, y_train_pred, <span class="hljs-attr">ax=ax)</span>


run['confusion_matrix'].upload(neptune.types.File.as_image(fig))

</pre>



<p>æ‚¨å¯ä»¥åœ¨<a href="https://web.archive.org/web/20220926093651/https://app.neptune.ai/common/tf-keras-integration/e/TFK-18/charts" target="_blank" rel="noreferrer noopener">åº”ç”¨</a>ä¸­æ¢ç´¢æŒ‡æ ‡å’Œæ€§èƒ½å›¾è¡¨ã€‚</p>






<p id="block_5ffefbec57a4c" class="separator separator-5"/>



<h2>å¦‚ä½•ç»˜åˆ¶Keraså†å²å¯¹è±¡ï¼Ÿ</h2>



<p>æ¯å½“è°ƒç”¨<em> fit() </em>æ—¶ï¼Œå®ƒéƒ½è¿”å›ä¸€ä¸ª<strong> <em>å†å²</em> </strong>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ç”¨äºå¯è§†åŒ–è®­ç»ƒå†å²ã€‚<strong>å®ƒåŒ…å«ä¸€ä¸ªå­—å…¸ï¼Œå…¶ä¸­åŒ…å«ä¸ºè®­ç»ƒå’ŒéªŒè¯æ•°æ®é›†è®¡ç®—çš„æ¯ä¸ªå†å…ƒçš„æŸå¤±å’Œåº¦é‡å€¼</strong>ã€‚</p>



<p>ä¾‹å¦‚ï¼Œè®©æˆ‘ä»¬æå–â€œ<em>å‡†ç¡®æ€§</em>â€æŒ‡æ ‡ï¼Œå¹¶ä½¿ç”¨matplotlibç»˜åˆ¶å®ƒã€‚</p>



<pre class="hljs"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

history = model.fit(x_train, y_train, 
                    validation_split=<span class="hljs-number">0.25</span>, 
                    epochs=<span class="hljs-number">50</span>, batch_size=<span class="hljs-number">16</span>, verbose=<span class="hljs-number">1</span>)


plt.plot(history.history[<span class="hljs-string">'accuracy'</span>])
plt.plot(history.history[<span class="hljs-string">'val_â€˜accuracy'</span>])
plt.title(<span class="hljs-string">'Model accuracy'</span>)
plt.ylabel(<span class="hljs-string">'Accuracy'</span>)
plt.xlabel(<span class="hljs-string">'Epoch'</span>)
plt.legend([<span class="hljs-string">'Train'</span>, <span class="hljs-string">'Test'</span>], loc=<span class="hljs-string">'upper left'</span>)
plt.show()</pre>









<h2>KerasæŒ‡æ ‡ç¤ºä¾‹</h2>



<p>å¥½äº†ï¼Œä½ å·²ç»èµ°äº†å¾ˆé•¿ä¸€æ®µè·¯ï¼Œå­¦åˆ°äº†å¾ˆå¤šã€‚ä¸ºäº†å”¤èµ·ä½ çš„è®°å¿†ï¼Œè®©æˆ‘ä»¬æŠŠå®ƒä»¬æ”¾åœ¨ä¸€ä¸ªä¾‹å­ä¸­ã€‚</p>



<p>æˆ‘ä»¬å°†ä»mnistæ•°æ®é›†å¼€å§‹ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªç®€å•çš„CNNæ¨¡å‹:</p>



<pre class="hljs"><span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf

mnist = tf.keras.datasets.mnist

(x_train, y_train), (x_test, y_test) = mnist.load_data()
x_train, x_test = x_train / <span class="hljs-number">255.0</span>, x_test / <span class="hljs-number">255.0</span>
validation_data = x_test, y_test

model = tf.keras.models.Sequential([
    tf.keras.layers.Flatten(input_shape=(<span class="hljs-number">28</span>, <span class="hljs-number">28</span>)),
    tf.keras.layers.Dense(<span class="hljs-number">512</span>, activation=<span class="hljs-string">'relu'</span>),
    tf.keras.layers.Dropout(<span class="hljs-number">0.2</span>),
    tf.keras.layers.Dense(<span class="hljs-number">10</span>, activation=<span class="hljs-string">'softmax'</span>)
])
</pre>



<p>æˆ‘ä»¬å°†åœ¨keras ä¸­åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰æŒ‡æ ‡ã€å¤šç±»åˆ«<strong> f1åˆ†æ•°:</strong></p>



<pre class="hljs"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">recall</span><span class="hljs-params">(y_true, y_pred)</span>:</span>
    y_true = K.ones_like(y_true) 
    true_positives = K.sum(K.round(K.clip(y_true * y_pred, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)))
    all_positives = K.sum(K.round(K.clip(y_true, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)))
    
    recall = true_positives / (all_positives + K.epsilon())
    <span class="hljs-keyword">return</span> recall

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">precision</span><span class="hljs-params">(y_true, y_pred)</span>:</span>
    y_true = K.ones_like(y_true) 
    true_positives = K.sum(K.round(K.clip(y_true * y_pred, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)))
    
    predicted_positives = K.sum(K.round(K.clip(y_pred, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)))
    precision = true_positives / (predicted_positives + K.epsilon())
    <span class="hljs-keyword">return</span> precision

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f1_score</span><span class="hljs-params">(y_true, y_pred)</span>:</span>
    precision = precision_m(y_true, y_pred)
    recall = recall_m(y_true, y_pred)
    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>*((precision*recall)/(precision+recall+K.epsilon()))
</pre>



<p>æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå®šåˆ¶çš„tf.kerasåº¦é‡:<strong>multiclasstruepoints</strong>ç¡®åˆ‡åœ°è¯´:</p>



<pre class="hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MulticlassTruePositives</span><span class="hljs-params">(tf.keras.metrics.Metric)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, name=<span class="hljs-string">'multiclass_true_positives'</span>, **kwargs)</span>:</span>
        super(MulticlassTruePositives, self).__init__(name=name, **kwargs)
        self.true_positives = self.add_weight(name=<span class="hljs-string">'tp'</span>, initializer=<span class="hljs-string">'zeros'</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update_state</span><span class="hljs-params">(self, y_true, y_pred, sample_weight=None)</span>:</span>
        y_pred = tf.reshape(tf.argmax(y_pred, axis=<span class="hljs-number">1</span>), shape=(<span class="hljs-number">-1</span>, <span class="hljs-number">1</span>))
        values = tf.cast(y_true, <span class="hljs-string">'int32'</span>) == tf.cast(y_pred, <span class="hljs-string">'int32'</span>)
        values = tf.cast(values, <span class="hljs-string">'float32'</span>)
        <span class="hljs-keyword">if</span> sample_weight <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">None</span>:
            sample_weight = tf.cast(sample_weight, <span class="hljs-string">'float32'</span>)
            values = tf.multiply(values, sample_weight)
        self.true_positives.assign_add(tf.reduce_sum(values))

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">result</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-keyword">return</span> self.true_positives

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reset_states</span><span class="hljs-params">(self)</span>:</span>
        
        self.true_positives.assign(<span class="hljs-number">0.</span>)</pre>



<p>æˆ‘ä»¬å°†<strong>ç”¨æˆ‘ä»¬çš„æŒ‡æ ‡ç¼–è¯‘kerasæ¨¡å‹</strong>:</p>



<pre class="hljs"><span class="hljs-keyword">import</span> keras

model.compile(optimizer=<span class="hljs-string">'sgd'</span>,
              loss=<span class="hljs-string">'sparse_categorical_crossentropy'</span>,
              metrics=[<span class="hljs-string">'accuracy'</span>,
                       keras.metrics.categorical_accuracy,
                       f1_score, 
                       recall_score, 
                       precision_score,
                       tf.keras.metrics.TopKCategoricalAccuracy(k=<span class="hljs-number">5</span>),
                       MulticlassTruePositives()])</pre>



<p>æˆ‘ä»¬å°†å®ç°keras <strong>å›è°ƒï¼Œå®ƒå°†ROCæ›²çº¿å’Œæ··æ·†çŸ©é˜µ</strong>ç»˜åˆ¶åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­:</p>



<pre class="hljs"><span class="hljs-keyword">import</span> os

<span class="hljs-keyword">from</span> keras.callbacks <span class="hljs-keyword">import</span> Callback
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> scikitplot.metrics <span class="hljs-keyword">import</span> plot_confusion_matrix, plot_roc

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PerformanceVisualizationCallback</span><span class="hljs-params">(Callback)</span>:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, model, validation_data, image_dir)</span>:</span>
        super().__init__()
        self.model = model
        self.validation_data = validation_data
        
        os.makedirs(image_dir, exist_ok=<span class="hljs-keyword">True</span>)
        self.image_dir = image_dir

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_epoch_end</span><span class="hljs-params">(self, epoch, logs={})</span>:</span>
        y_pred = np.asarray(self.model.predict(self.validation_data[<span class="hljs-number">0</span>]))
        y_true = self.validation_data[<span class="hljs-number">1</span>]             
        y_pred_class = np.argmax(y_pred, axis=<span class="hljs-number">1</span>)

        
        fig, ax = plt.subplots(figsize=(<span class="hljs-number">16</span>,<span class="hljs-number">12</span>))
        plot_confusion_matrix(y_true, y_pred_class, ax=ax)
        fig.savefig(os.path.join(self.image_dir, f<span class="hljs-string">'confusion_matrix_epoch_{epoch}'</span>))

       
        fig, ax = plt.subplots(figsize=(<span class="hljs-number">16</span>,<span class="hljs-number">12</span>))
        plot_roc(y_true, y_pred, ax=ax)
        fig.savefig(os.path.join(self.image_dir, f<span class="hljs-string">'roc_curve_epoch_{epoch}'</span>))

performance_viz_cbk = PerformanceVisualizationCallback(
                                       model=model,
                                       validation_data=validation_data,
                                       image_dir=<span class="hljs-string">'perorfmance_charts'</span>)</pre>



<p>æˆ‘ä»¬å°†<strong>è¿›è¡ŒåŸ¹è®­</strong>å¹¶ç›‘æ§è¡¨ç°:</p>



<pre class="hljs">history = model.fit(x=x_train,
                    y=y_train,
                    epochs=<span class="hljs-number">5</span>,
                    validation_data=validation_data,
                    callbacks=[performance_viz_cbk])</pre>



<p>æˆ‘ä»¬å°†<strong>å¯è§†åŒ–æ¥è‡ªkeraså†å²å¯¹è±¡çš„æŒ‡æ ‡:</strong></p>



<pre class="hljs">plt.plot(history.history[<span class="hljs-string">'accuracy'</span>])
plt.plot(history.history[<span class="hljs-string">'val_accuracy'</span>])
plt.title(<span class="hljs-string">'Model accuracy'</span>)
plt.ylabel(<span class="hljs-string">'Accuracy'</span>)
plt.xlabel(<span class="hljs-string">'Epoch'</span>)
plt.legend([<span class="hljs-string">'Train'</span>, <span class="hljs-string">'Test'</span>], loc=<span class="hljs-string">'upper left'</span>)
plt.show()
</pre>



<p>æˆ‘ä»¬å°†åœ¨TensorBoardæˆ–Neptuneç­‰å·¥å…·ä¸­ç›‘æ§å’Œæ¢ç´¢æ‚¨çš„å®éªŒã€‚</p>






<h2>æµ·ç‹æ˜Ÿ</h2>



<pre class="hljs"><span class="hljs-attr">run</span> = neptune.init(
        <span class="hljs-attr">project='YOUR_WORKSAPCE/YOUR_PROJECT_NAME',</span>
        <span class="hljs-attr">api_token='YOUR_API_TOKEN')</span>

<span class="hljs-attr">neptune_cbk</span> = NeptuneCallback(<span class="hljs-attr">run=run,</span> <span class="hljs-attr">base_namespace='metrics')</span>
<span class="hljs-attr">history</span> = model.fit(..., <span class="hljs-attr">callbacks=[neptune_cbk])</span>

</pre>



<p>å¦‚æœæ‚¨æ„Ÿå…´è¶£ï¼Œè¯·æŸ¥çœ‹æ­¤<a href="https://web.archive.org/web/20220926093651/https://docs.neptune.ai/integrations-and-supported-tools/model-training/tensorflow-keras" target="_blank" rel="noreferrer noopener">æ–‡æ¡£</a>å’Œç¤ºä¾‹<a href="https://web.archive.org/web/20220926093651/https://app.neptune.ai/o/common/org/tf-keras-integration/e/TFK-35541/dashboard/metrics-b11ccc73-9ac7-4126-be1a-cf9a3a4f9b74" target="_blank" rel="noreferrer noopener">å®éªŒè¿è¡Œ</a>:</p>







<p>ğŸ‘‰äº†è§£æ›´å¤šå…³äºNeptuneä¸Kerasçš„æ•´åˆã€‚</p>



<h2>å¼ é‡æ¿</h2>



<p>æ‚¨åªéœ€è¦<strong>æ·»åŠ å¦ä¸€ä¸ªå›è°ƒæˆ–è€…ä¿®æ”¹æ‚¨ä¹‹å‰å·²ç»</strong>åˆ›å»ºçš„å›è°ƒ:</p>



<pre class="hljs"><span class="hljs-keyword">from</span>  tf.keras.callbacks <span class="hljs-keyword">import</span> TensorBoard

tensorboard_cbk = TensorBoard(log_dir=<span class="hljs-string">"logs/training-example/"</span>)

history = model.fit(..., callbacks=[performance_viz_cbk, 
                                    tensorboard_cbk])</pre>



<p>ä½¿ç”¨TensorBoardï¼Œæ‚¨éœ€è¦å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨å¹¶åœ¨æµè§ˆå™¨ä¸­æµè§ˆæ‚¨çš„è·‘æ­¥è®°å½•ã€‚</p>



<pre class="hljs">tensorboard --logdir logs/training-example/</pre>










<h2>æœ€åçš„æƒ³æ³•</h2>



<p>å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½ç»™ä½ ä¸€äº›kerasä¸­æ¨¡å‹è¯„ä¼°æŠ€æœ¯çš„èƒŒæ™¯çŸ¥è¯†ã€‚</p>



<p>æˆ‘ä»¬æ¶µç›–äº†:</p>


<div class="custom-point-list">
<ul><li>keraså’Œtf.kerasä¸­çš„å†…ç½®æ–¹æ³•ï¼Œ</li><li>å®ç°æ‚¨è‡ªå·±çš„å®šåˆ¶æŒ‡æ ‡ï¼Œ</li><li>å¦‚ä½•åœ¨æ¨¡å‹è®­ç»ƒæ—¶å¯è§†åŒ–è‡ªå®šä¹‰æ€§èƒ½å›¾è¡¨ã€‚</li></ul>
</div>


<p>æ¬²äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹KerasçŸ¥è¯†åº“å’Œå¼ é‡æµåº¦é‡æ–‡æ¡£ã€‚</p>



<p>å¿«ä¹è®­ç»ƒï¼</p>




<div id="author-box-new-format-block_6007356684165" class="article__footer article__author">
  

  <div class="article__authorContent">
          <h3 class="article__authorContent-name">å¾·é‡Œå…‹Â·å§†ç»´è’‚</h3>
    
          <p class="article__authorContent-text">Derrick Mwitiæ˜¯ä¸€åæ•°æ®ç§‘å­¦å®¶ï¼Œä»–å¯¹åˆ†äº«çŸ¥è¯†å……æ»¡çƒ­æƒ…ã€‚ä»–æ˜¯æ•°æ®ç§‘å­¦ç¤¾åŒºçš„çƒ­å¿ƒè´¡çŒ®è€…ï¼Œä¾‹å¦‚Heartbeatã€Towards Data Scienceã€Datacampã€Neptune AIã€KDnuggetsç­‰åšå®¢ã€‚ä»–çš„å†…å®¹åœ¨ç½‘ä¸Šè¢«æµè§ˆäº†è¶…è¿‡ä¸€ç™¾ä¸‡æ¬¡ã€‚å¾·é‡Œå…‹ä¹Ÿæ˜¯ä¸€åä½œå®¶å’Œåœ¨çº¿æ•™å¸ˆã€‚ä»–è¿˜åŸ¹è®­å„ç§æœºæ„å¹¶ä¸ä¹‹åˆä½œï¼Œä»¥å®æ–½æ•°æ®ç§‘å­¦è§£å†³æ–¹æ¡ˆå¹¶æå‡å…¶å‘˜å·¥çš„æŠ€èƒ½ã€‚ä½ å¯èƒ½æƒ³çœ‹çœ‹ä»–åœ¨Pythonè¯¾ç¨‹ä¸­å®Œæ•´çš„æ•°æ®ç§‘å­¦å’Œæœºå™¨å­¦ä¹ è®­ç»ƒè¥ã€‚</p>
    
          
    
  </div>
</div>


<div class="wp-container-1 wp-block-group"><div class="wp-block-group__inner-container">
<hr class="wp-block-separator"/>



<p class="has-text-color"><strong>é˜…è¯»ä¸‹ä¸€ç¯‡</strong></p>



<h2>å¦‚ä½•åœ¨æ‚¨çš„é¡¹ç›®ä¸­è·Ÿè¸ªæœºå™¨å­¦ä¹ æ¨¡å‹æŒ‡æ ‡</h2>



<p class="has-small-font-size">3åˆ†é’Ÿé˜…è¯»| Jakub Czakon |å‘å¸ƒäº2020å¹´6æœˆ22æ—¥</p>


<p id="block_5ffc75def9f8e" class="separator separator-10"/>



<p>è·Ÿè¸ªæœºå™¨å­¦ä¹ æ¨¡å‹çš„è¯„ä¼°æŒ‡æ ‡è‡³å…³é‡è¦ï¼Œä»¥ä¾¿:</p>


<div class="custom-point-list">
<ul><li>äº†è§£æ‚¨çš„æ¨¡å‹åšå¾—å¦‚ä½•</li><li>èƒ½å¤Ÿå°†å®ƒä¸ä»¥å‰çš„åŸºçº¿å’Œæƒ³æ³•è¿›è¡Œæ¯”è¾ƒ</li><li>äº†è§£ä½ ç¦»é¡¹ç›®ç›®æ ‡æœ‰å¤šè¿œ</li></ul>
</div>


<p>â€œå¦‚æœä½ ä¸è¡¡é‡å®ƒï¼Œä½ å°±ä¸èƒ½æ”¹è¿›å®ƒã€‚â€</p>



<p>ä½†æ˜¯ä½ åº”è¯¥è·Ÿè¸ªä»€ä¹ˆå‘¢ï¼Ÿ</p>



<p>æˆ‘ä»æ¥æ²¡æœ‰å‘ç°è‡ªå·±åœ¨è¿™æ ·çš„æƒ…å†µä¸‹ï¼Œæˆ‘è®¤ä¸ºæˆ‘å·²ç»ä¸ºæˆ‘çš„æœºå™¨å­¦ä¹ å®éªŒè®°å½•äº†å¤ªå¤šçš„æŒ‡æ ‡ã€‚</p>



<p>æ­¤å¤–ï¼Œåœ¨ç°å®ä¸–ç•Œçš„é¡¹ç›®ä¸­ï¼Œæ‚¨æ‰€å…³å¿ƒçš„æŒ‡æ ‡å¯èƒ½ä¼šç”±äºæ–°çš„å‘ç°æˆ–ä¸æ–­å˜åŒ–çš„è§„èŒƒè€Œæ”¹å˜ï¼Œå› æ­¤è®°å½•æ›´å¤šçš„æŒ‡æ ‡å®é™…ä¸Šå¯ä»¥åœ¨å°†æ¥ä¸ºæ‚¨èŠ‚çœä¸€äº›æ—¶é—´å’Œéº»çƒ¦ã€‚</p>



<p>ä¸ç®¡æ€æ ·ï¼Œæˆ‘çš„å»ºè®®æ˜¯:</p>



<p>â€œè®°å½•æ¯”ä½ è®¤ä¸ºéœ€è¦çš„æ›´å¤šçš„æŒ‡æ ‡ã€‚â€</p>



<p>å¥½å§ï¼Œä½†æ˜¯ä½ å…·ä½“æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿ</p>



<h3>è·Ÿè¸ªå•ä¸€æ•°å­—çš„æŒ‡æ ‡</h3>



<p>åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä¸ºæœºå™¨å­¦ä¹ æ¨¡å‹çš„æ€§èƒ½åˆ†é…ä¸€ä¸ªæ•°å€¼ã€‚æ‚¨å¯ä»¥è®¡ç®—ä¿ç•™éªŒè¯é›†çš„å‡†ç¡®åº¦ã€AUCæˆ–å¹³å‡ç²¾åº¦ï¼Œå¹¶å°†å…¶ç”¨ä½œæ¨¡å‹è¯„ä¼°æŒ‡æ ‡ã€‚</p>



<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨åº”è¯¥è·Ÿè¸ªæ¯æ¬¡å®éªŒè¿è¡Œçš„æ‰€æœ‰è¿™äº›å€¼ã€‚</p>


<a class="button continous-post blue-filled" href="/web/20220926093651/https://neptune.ai/blog/how-to-track-machine-learning-model-metrics" target="_blank">
    Continue reading -&gt;</a>



<hr class="wp-block-separator"/>
</div></div>



<p/>
</div>
      </div>    
</body>
</html>