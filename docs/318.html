<html>
<head>
<title>How to Keep Track of PyTorch Lightning Experiments With Neptune </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>å¦‚ä½•è·Ÿè¸ªæµ·ç‹æ˜Ÿçš„PyTorché—ªç”µå®éªŒ</h1>
<blockquote>åŸæ–‡ï¼š<a href="https://web.archive.org/web/https://neptune.ai/blog/pytorch-lightning-neptune-integration#0001-01-01">https://web.archive.org/web/https://neptune.ai/blog/pytorch-lightning-neptune-integration#0001-01-01</a></blockquote><div><div class="l-content content-wrapper js-content">
            
<p>ä½¿ç”¨PyTorch Lightningå¹¶æƒ³çŸ¥é“æ‚¨åº”è¯¥é€‰æ‹©å“ªä¸ªè®°å½•å™¨æ¥<a href="/web/20221206015925/https://neptune.ai/experiment-tracking" target="_blank" rel="noreferrer noopener">è·Ÿè¸ªæ‚¨çš„å®éªŒ</a>ï¼Ÿ</p>



<p>æƒ³è¦æ‰¾åˆ°ä¿å­˜è¶…å‚æ•°ã€æŒ‡æ ‡å’Œå…¶ä»–å»ºæ¨¡å…ƒæ•°æ®çš„å¥½æ–¹æ³•å—ï¼Ÿ</p>



<p>è€ƒè™‘ä½¿ç”¨PyTorch Lightningæ¥æ„å»ºæ‚¨çš„æ·±åº¦å­¦ä¹ ä»£ç ï¼Œå¹¶ä¸”ä¸ä»‹æ„äº†è§£å®ƒçš„æ—¥å¿—è®°å½•åŠŸèƒ½ï¼Ÿ</p>



<p>ä¸çŸ¥é“é—ªç”µæœ‰ä¸€ä¸ªç›¸å½“å¯æ€•çš„æµ·ç‹æ˜Ÿç§¯åˆ†ï¼Ÿ</p>



<p>è¿™ç¯‡æ–‡ç« (å¾ˆå¯èƒ½)é€‚åˆä½ ã€‚</p>



<h2 id="h-why-pytorch-lightning-and-neptune">ä¸ºä»€ä¹ˆæ˜¯PyTorché—ªç”µå’Œæµ·ç‹æ˜Ÿï¼Ÿ</h2>



<p>å¦‚æœä½ ä»æœªå¬è¯´è¿‡ï¼ŒPyTorch Lightning æ˜¯PyTorchä¹‹ä¸Šçš„ä¸€ä¸ªéå¸¸è½»é‡çº§çš„åŒ…è£…å™¨ï¼Œå®ƒæ›´åƒæ˜¯ä¸€ä¸ªç¼–ç æ ‡å‡†è€Œä¸æ˜¯æ¡†æ¶ã€‚è¿™ç§æ ¼å¼å¯ä»¥è®©ä½ æ‘†è„±å¤§é‡çš„æ ·æ¿ä»£ç ï¼ŒåŒæ—¶ä¿æŒç®€å•æ˜“æ‡‚ã€‚</p>



<p>å…¶ç»“æœæ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œä¸ºç ”ç©¶äººå‘˜ã€å­¦ç”Ÿå’Œç”Ÿäº§å›¢é˜Ÿæä¾›äº†å°è¯•ç–¯ç‹‚æƒ³æ³•çš„ç»ˆæçµæ´»æ€§ï¼Œè€Œä¸å¿…å­¦ä¹ å¦ä¸€ä¸ªæ¡†æ¶ï¼ŒåŒæ—¶è‡ªåŠ¨åŒ–æ‰æ‰€æœ‰çš„å·¥ç¨‹ç»†èŠ‚ã€‚</p>



<p>æ‚¨å¯ä»¥è·å¾—çš„ä¸€äº›å‡ºè‰²åŠŸèƒ½åŒ…æ‹¬:</p>



<ul><li>åœ¨ä¸æ”¹å˜ä»£ç çš„æƒ…å†µä¸‹ï¼Œåœ¨CPUã€GPUæˆ–TPUsä¸Šè¿›è¡Œè®­ç»ƒï¼Œ</li><li>çç¢çš„å¤šGPUå’Œå¤šèŠ‚ç‚¹è®­ç»ƒ</li><li>å¾®ä¸è¶³é“çš„16ä½ç²¾åº¦æ”¯æŒ</li><li>å†…ç½®æ€§èƒ½åˆ†æå™¨(è®­ç»ƒå™¨(profile=True))</li></ul>



<p>ä»¥åŠä¸€å¤§å †å…¶ä»–ä¼Ÿå¤§çš„åŠŸèƒ½ã€‚</p>







<p>ä½†æ˜¯ï¼Œä¼´éšç€è¿™ç§è½»æ¾è¿è¡Œå®éªŒçš„å¼ºå¤§åŠŸèƒ½å’Œéšæ„è°ƒæ•´çš„çµæ´»æ€§ï¼Œå‡ºç°äº†ä¸€ä¸ªé—®é¢˜ã€‚</p>



<p>å¦‚ä½•è·Ÿè¸ªæ‰€æœ‰å˜åŒ–ï¼Œä¾‹å¦‚:</p>



<ul><li>æŸå¤±å’ŒæŒ‡æ ‡ï¼Œ</li><li>è¶…å‚æ•°</li><li>æ¨¡å‹äºŒè¿›åˆ¶</li><li>éªŒè¯é¢„æµ‹</li></ul>



<p>å’Œå…¶ä»–èƒ½å¸®åŠ©ä½ ç»„ç»‡å®éªŒè¿‡ç¨‹çš„ä¸œè¥¿ï¼Ÿ</p>



<h3>PyTorché—ªç”µè®°å½•å™¨</h3>



<p>å¹¸è¿çš„æ˜¯ï¼ŒPyTorch Lightningä¸ºæ‚¨æä¾›äº†ä¸€ä¸ªå°†è®°å½•å™¨è½»æ¾è¿æ¥åˆ°plçš„é€‰é¡¹ã€‚è®­ç»ƒå™¨å’Œä¸€ä¸ª<a href="https://web.archive.org/web/20221206015925/https://pytorch-lightning.readthedocs.io/en/latest/api_references.html#loggers" target="_blank" rel="noreferrer noopener nofollow">æ”¯æŒçš„è®°å½•å™¨</a>å¯ä»¥è·Ÿè¸ªä¹‹å‰æåˆ°çš„æ‰€æœ‰ä¸œè¥¿(å’Œè®¸å¤šå…¶ä»–ä¸œè¥¿)æ˜¯NeptuneLoggerï¼Œå®ƒä¿å­˜ä½ çš„å®éªŒåœ¨â€¦ä½ çŒœå¯¹äº†ï¼Œ<a href="https://web.archive.org/web/20221206015925/https://docs.neptune.ai/integrations-and-supported-tools/model-training/pytorch-lightning" target="_blank" rel="noreferrer noopener">æµ·ç‹æ˜Ÿ</a>ã€‚</p>



<p>æµ·ç‹æ˜Ÿä¸ä»…è·Ÿè¸ªä½ çš„å®éªŒæ–‡ç‰©ï¼Œè€Œä¸”:</p>







<p>æœ€å¥½çš„éƒ¨åˆ†æ˜¯ï¼Œè¿™ç§é›†æˆä½¿ç”¨èµ·æ¥çœŸçš„å¾ˆç®€å•ã€‚</p>



<p>è®©æˆ‘ç»™ä½ çœ‹çœ‹å®ƒæ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚</p>



<section id="blog-intext-cta-block_61cade7df0a30" class="block-blog-intext-cta  c-box c-box--default c-box--dark c-box--no-hover c-box--standard ">

            
    
            <p>ä½ ä¹Ÿå¯ä»¥çœ‹çœ‹è¿™ä¸ª<a href="https://web.archive.org/web/20221206015925/https://colab.research.google.com/drive/1EThGG9EbN6rjMITFUKNtUwQdth_Zuu36?usp=sharing" target="_blank" rel="noreferrer noopener nofollow"> colabç¬”è®°æœ¬</a>ï¼Œç©ç©æˆ‘ä»¬å°†è¦è°ˆåˆ°çš„ä½ è‡ªå·±çš„ä¾‹å­ã€‚</p>
    
    </section>



<h2 id="h-pytorch-lightning-logging-basic-integration-save-hyperparameters-metrics-and-more">PyTorché—ªç”µæ—¥å¿—:åŸºæœ¬é›†æˆ(ä¿å­˜è¶…å‚æ•°ã€æŒ‡æ ‡ç­‰)</h2>



<p>åœ¨æœ€ç®€å•çš„æƒ…å†µä¸‹ï¼Œæ‚¨åªéœ€åˆ›å»º<code>NeptuneLogger</code>:</p>



<pre class="hljs"><span class="hljs-keyword">from</span> pytorch_lightning.loggers <span class="hljs-keyword">import</span> NeptuneLogger

neptune_logger = NeptuneLogger(
    api_key=<span class="hljs-string">"ANONYMOUS"</span>,
    project_name=<span class="hljs-string">"shared/pytorch-lightning-integration"</span>)</pre>



<p>å¹¶å°†å…¶ä¼ é€’ç»™<code>Trainer</code>çš„loggerå‚æ•°ï¼Œä»¥ç¬¦åˆæ‚¨çš„æ¨¡å‹ã€‚</p>



<pre class="hljs"><span class="hljs-keyword">from</span> pytorch_lightning <span class="hljs-keyword">import</span> Trainer

trainer = Trainer(logger=neptune_logger)
trainer.fit(model)
</pre>



<p>é€šè¿‡è¿™æ ·åšï¼Œæ‚¨å¯ä»¥è‡ªåŠ¨:</p>



<ul><li>è®°å½•æŒ‡æ ‡å’ŒæŸå¤±(å¹¶åˆ›å»ºå›¾è¡¨)ï¼Œ</li><li>è®°å½•å¹¶ä¿å­˜è¶…å‚æ•°(å¦‚æœé€šè¿‡lightning hparamså®šä¹‰)ï¼Œ</li><li>è®°å½•ç¡¬ä»¶åˆ©ç”¨ç‡</li><li>è®°å½•Gitä¿¡æ¯å’Œæ‰§è¡Œè„šæœ¬</li></ul>



<p>çœ‹çœ‹è¿™ä¸ªå®éªŒã€‚</p>







<p>ä½ å¯ä»¥ç›‘æ§ä½ çš„å®éªŒï¼Œæ¯”è¾ƒå®ƒä»¬ï¼Œå¹¶ä¸ä»–äººåˆ†äº«ã€‚</p>



<p>å¯¹ä¸€è¾†å››ç¼¸è½¦æ¥è¯´è¿˜ä¸é”™ã€‚</p>



<p>ä½†æ˜¯åªè¦å¤šä¸€ç‚¹åŠªåŠ›ï¼Œä½ å°±èƒ½å¾—åˆ°æ›´å¤šã€‚</p>



<h2 id="h-pytorch-lightning-logging-advanced-options">PyTorché—ªç”µæµ‹äº•:é«˜çº§é€‰é¡¹</h2>



<p>Neptuneä¸ºæ‚¨æä¾›äº†è®¸å¤šå®šåˆ¶é€‰é¡¹ï¼Œæ‚¨å¯ä»¥ç®€å•åœ°è®°å½•æ›´å¤šç‰¹å®šäºå®éªŒçš„å†…å®¹ï¼Œå¦‚å›¾åƒé¢„æµ‹ã€æ¨¡å‹æƒé‡ã€æ€§èƒ½å›¾è¡¨ç­‰ç­‰ã€‚</p>



<p>æ‰€æœ‰è¿™äº›åŠŸèƒ½å¯¹Lightningç”¨æˆ·éƒ½æ˜¯å¯ç”¨çš„ï¼Œåœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•å……åˆ†åˆ©ç”¨Neptuneã€‚</p>



<h3>åˆ›å»ºNeptuneLoggeræ—¶è®°å½•é¢å¤–ä¿¡æ¯</h3>



<p>åˆ›å»ºè®°å½•å™¨æ—¶ï¼Œæ‚¨å¯ä»¥è®°å½•å…¶ä»–æœ‰ç”¨çš„ä¿¡æ¯:</p>



<ul><li><a href="https://web.archive.org/web/20221206015925/https://docs.neptune.ai/you-should-know/what-can-you-log-and-display#code" target="_blank" rel="noreferrer noopener">ä»£ç </a>:å¿«ç…§è„šæœ¬ã€jupyterç¬”è®°æœ¬ã€é…ç½®æ–‡ä»¶ç­‰ç­‰ï¼Œ</li><li>è¶…å‚æ•°:è®°å½•å­¦ä¹ ç‡ã€å†å…ƒæ•°å’Œå…¶ä»–ä¸œè¥¿(å¦‚æœä½ æ­£åœ¨ä½¿ç”¨lightningçš„lightning <code>hparams</code>å¯¹è±¡ï¼Œå®ƒå°†è¢«è‡ªåŠ¨è®°å½•)</li><li><a href="https://web.archive.org/web/20221206015925/https://docs.neptune.ai/you-should-know/what-can-you-log-and-display#data-versions" target="_blank" rel="noreferrer noopener">å±æ€§</a>:æ—¥å¿—æ•°æ®ä½ç½®ã€æ•°æ®ç‰ˆæœ¬æˆ–å…¶ä»–</li><li><a href="https://web.archive.org/web/20221206015925/https://docs.neptune.ai/you-should-know/what-can-you-log-and-display#tags" target="_blank" rel="noreferrer noopener">æ ‡ç­¾</a>:æ·»åŠ â€œresnet50â€æˆ–â€œæ— å¢å¼ºâ€ç­‰æ ‡ç­¾æ¥ç»„ç»‡æ‚¨çš„è·‘æ­¥ã€‚</li></ul>



<p>åªéœ€å°†è¿™äº›ä¿¡æ¯ä¼ é€’ç»™ä½ çš„è®°å½•å™¨:</p>



<pre class="hljs">neptune_logger = NeptuneLogger(
    api_key=<span class="hljs-string">"ANONYMOUS"</span>,
    project=<span class="hljs-string">"shared/pytorch-lightning-integration"</span>,
    tags=[<span class="hljs-string">"pytorch-lightning"</span>, <span class="hljs-string">"mlp"</span>],
)
</pre>



<h3>ç”¨PyTorch Lightningè®°å½•è®­ç»ƒä¸­çš„é¢å¤–äº‹æƒ…</h3>



<p>è®­ç»ƒä¸­å¯ä»¥è®°å½•å¾ˆå¤šæœ‰è¶£çš„ä¿¡æ¯ã€‚</p>



<p>æ‚¨å¯èƒ½å¯¹ç›‘æ§ä»¥ä¸‹å†…å®¹æ„Ÿå…´è¶£:</p>



<ul><li>æ¯ä¸ªæ—¶æœŸåçš„æ¨¡å‹é¢„æµ‹(è€ƒè™‘é¢„æµ‹é®ç½©æˆ–è¦†ç›–çš„è¾¹ç•Œæ¡†)</li><li>è¯Šæ–­å›¾è¡¨ï¼Œå¦‚ROC AUCæ›²çº¿æˆ–æ··æ·†çŸ©é˜µ</li><li><a href="https://web.archive.org/web/20221206015925/https://docs.neptune.ai/you-should-know/what-can-you-log-and-display#model-checkpoints" target="_blank" rel="noreferrer noopener">æ¨¡å‹æ£€æŸ¥ç‚¹</a>ï¼Œæˆ–å…¶ä»–å¯¹è±¡</li></ul>



<p>è¿™çœŸçš„å¾ˆç®€å•ã€‚åªéœ€è½¬åˆ°æ‚¨çš„<code>LightningModule</code>å¹¶è°ƒç”¨ä½œä¸º<code>self.logger.experiment</code>å¯ç”¨çš„Neptuneå®éªŒçš„æ–¹æ³•ã€‚</p>



<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥è®°å½•æ¯ä¸ªæ—¶æœŸåçš„æŸå¤±ç›´æ–¹å›¾:</p>



<pre class="hljs"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CoolSystem</span><span class="hljs-params">(pl.LightningModule)</span>:</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validation_epoch_end</span><span class="hljs-params">(self, outputs)</span>:</span>
        
        avg_loss = torch.stack([x[<span class="hljs-string">'val_loss'</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> outputs]).mean()
        
        fig = plt.figure()
        losses = np.stack([x[<span class="hljs-string">'val_loss'</span>].numpy() <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> outputs])
        plt.hist(losses)
        neptune_logger.experiments[<span class="hljs-string">'loss_histograms'</span>].log(File.as_image(fig))
        plt.close(fig)

        <span class="hljs-keyword">return</span> {<span class="hljs-string">'avg_val_loss'</span>: avg_loss}</pre>



<p><a href="https://web.archive.org/web/20221206015925/https://app.neptune.ai/shared/pytorch-lightning-integration/e/PYTOR-173293/all?path=imgs&amp;attribute=loss_histograms" target="_blank" rel="noreferrer noopener">è‡ªå·±æ¢ç´¢å®ƒä»¬</a>ã€‚</p>







<p><a href="https://web.archive.org/web/20221206015925/https://docs.neptune.ai/you-should-know/what-can-you-log-and-display" target="_blank" rel="noreferrer noopener">åœ¨åŸ¹è®­æœŸé—´ï¼Œæ‚¨å¯èƒ½å¸Œæœ›è®°å½•çš„å…¶ä»–äº‹æƒ…</a>æœ‰:</p>



<ul><li><code>neptune_logger.experiment["your/metadata/metric"].log(metric)</code> #è®°å½•è‡ªå®šä¹‰æŒ‡æ ‡</li><li><code>neptune_logger.experiment["your/metadata/text"].log(text)</code> #æ—¥å¿—æ–‡æœ¬å€¼</li><li><code>neptune_logger.experiment["your/metadata/file"].upload(artifact)</code> #æ—¥å¿—æ–‡ä»¶</li><li><code>neptune_logger.experiment["your/metadata/figure"].upload(File.as_image(artifact))</code> #æ—¥å¿—å›¾ç‰‡ã€å›¾è¡¨</li><li><code>neptune_logger.experiment["properties/key"] = value</code> #æ·»åŠ é”®å€¼å¯¹</li><li><code>neptune_logger.experiment["sys/tags"].add(['tag1', 'tag2'])</code> #ä¸ºç»„ç»‡æ·»åŠ æ ‡ç­¾</li></ul>



<p>å¾ˆé…·å§ï¼Ÿ</p>



<p>ä½†æ˜¯â€¦è¿™ä¸æ˜¯ä½ èƒ½åšçš„å…¨éƒ¨ï¼</p>



<h3>PyTorché—ªç”µè®­ç»ƒç»“æŸåè®°å½•ä¸œè¥¿</h3>



<p>è·Ÿè¸ªä½ çš„å®éªŒä¸ä¸€å®šè¦åœ¨ä½ åšå®Œåæ‰ç»“æŸã€‚å®‰è£…å¾ªç¯æœ«ç«¯ã€‚</p>



<p>æ‚¨å¯èƒ½æƒ³è¦è·Ÿè¸ª<code>trainer.test(model)</code>çš„æŒ‡æ ‡ï¼Œæˆ–è€…è®¡ç®—ä¸€äº›é¢å¤–çš„éªŒè¯æŒ‡æ ‡å¹¶è®°å½•ä¸‹æ¥ã€‚</p>



<p>è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œä½ åªéœ€è¦å‘Šè¯‰<code>NeptuneLogger</code>ä¸è¦åœ¨å®‰è£…åå…³é—­:</p>



<pre class="hljs">neptune_logger = NeptuneLogger(
    api_key=<span class="hljs-string">"ANONYMOUS"</span>,
    project_name=<span class="hljs-string">"shared/pytorch-lightning-integration"</span>,
    ...
)
</pre>



<p>â€¦æ‚¨å¯ä»¥ç»§ç»­è®°å½•ğŸ™‚</p>



<p><strong>æµ‹è¯•æŒ‡æ ‡:</strong></p>



<pre class="hljs">trainer.test(model)</pre>



<p><strong>å…¶ä»–(å¤–éƒ¨)æŒ‡æ ‡:</strong></p>



<pre class="hljs"><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score
...
accuracy = accuracy_score(y_true, y_pred)
neptune_logger.experiment[<span class="hljs-string">'test/accuracy'</span>].log(accuracy)</pre>



<p><strong>æµ‹è¯•é›†ä¸Šçš„æ€§èƒ½å›¾è¡¨:</strong></p>



<pre class="hljs"><span class="hljs-keyword">from</span> scikitplot.metrics <span class="hljs-keyword">import</span> plot_confusion_matrix
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
...
fig, ax = plt.subplots(figsize=(<span class="hljs-number">16</span>, <span class="hljs-number">12</span>))
plot_confusion_matrix(y_true, y_pred, ax=ax)
neptune_logger.experiment[<span class="hljs-string">'test/confusion_matrix'</span>].upload(File.as_image(fig))</pre>



<p><strong>æ•´ä¸ªæ¨¡å‹æ£€æŸ¥ç‚¹ç›®å½•:</strong></p>



<pre class="hljs">neptune_logger.experiment(<span class="hljs-string">'checkpoints'</span>).upload(<span class="hljs-string">'my/checkpoints'</span>)
</pre>



<p><a href="https://web.archive.org/web/20221206015925/https://app.neptune.ai/shared/pytorch-lightning-integration/e/PYTOR-173293/all?path=&amp;attribute=confusion_matrix" target="_blank" rel="noreferrer noopener">è½¬åˆ°æœ¬å®éªŒ</a>æŸ¥çœ‹è¿™äº›å¯¹è±¡æ˜¯å¦‚ä½•è¢«è®°å½•çš„:</p>







<p>ä½†æ˜¯â€¦è¿˜æœ‰æ›´å¤šï¼</p>



<p>æµ·ç‹æ˜Ÿè®©ä½ åœ¨è®­ç»ƒåè·å–å®éªŒã€‚</p>



<p>è®©æˆ‘å‘Šè¯‰ä½ æ€ä¹ˆåšã€‚</p>



<h3>æŠŠä½ çš„PyTorché—ªç”µå®éªŒä¿¡æ¯ç›´æ¥æ‹¿åˆ°ç¬”è®°æœ¬ä¸Š</h3>



<p>æ‚¨å¯ä»¥åœ¨å®éªŒå®Œæˆåè·å–å®éªŒï¼Œåˆ†æç»“æœï¼Œå¹¶æ›´æ–°åº¦é‡ã€å·¥ä»¶æˆ–å…¶ä»–ä¸œè¥¿ã€‚</p>



<p>ä¾‹å¦‚ï¼Œè®©æˆ‘ä»¬å°†å®éªŒä»ªè¡¨æ¿æå–åˆ°ç†ŠçŒ«æ•°æ®å¸§:</p>



<pre class="hljs"><span class="hljs-keyword">import</span> neptune.new <span class="hljs-keyword">as</span> neptune

project = neptune.init(<span class="hljs-string">'shared/pytorch-lightning-integration'</span>)
project.fetch_runs_table().to_pandas()
</pre>



<p>æˆ–è€…è·å–ä¸€ä¸ªå•ç‹¬çš„å®éªŒå¹¶ç”¨è®­ç»ƒåè®¡ç®—çš„ä¸€äº›å¤–éƒ¨åº¦é‡æ¥æ›´æ–°å®ƒ:</p>



<pre class="hljs">exp = neptune.init(project=<span class="hljs-string">'shared/pytorch-lightning-integration'</span>, id=<span class="hljs-string">'PYTOR-63'</span>)
exp[<span class="hljs-string">'some_external_metric'</span>].log(<span class="hljs-number">0.92</span>)</pre>



<p>æˆ–è€…è·å–ä¸€ä¸ªå•ç‹¬çš„å®éªŒå¹¶ç”¨è®­ç»ƒåè®¡ç®—çš„ä¸€äº›å¤–éƒ¨åº¦é‡æ¥æ›´æ–°å®ƒ:</p>



<pre class="hljs">exp = project.get_experiments(id=<span class="hljs-string">'PYTOR-63'</span>)[<span class="hljs-number">0</span>]
exp.log_metric(<span class="hljs-string">'some_external_metric'</span>, <span class="hljs-number">0.92</span>)
</pre>



<p>å¦‚ä½ æ‰€è§ï¼Œä½ å¯ä»¥ä»Pytorch Lightningå°†å¾ˆå¤šä¸œè¥¿è®°å½•åˆ°Neptuneã€‚</p>



<p>å¦‚æœä½ æƒ³æ·±å…¥äº†è§£è¿™ä¸ªé—®é¢˜:</p>







<h2 id="h-final-thoughts">æœ€åçš„æƒ³æ³•</h2>



<p>Pytorch Lightningæ˜¯ä¸€ä¸ªå¾ˆæ£’çš„åº“ï¼Œå¯ä»¥å¸®åŠ©æ‚¨:</p>



<ul><li>ç»„ç»‡ä½ çš„æ·±åº¦å­¦ä¹ ä»£ç ï¼Œè®©å…¶ä»–äººå®¹æ˜“ç†è§£ï¼Œ</li><li>å°†å¼€å‘æ ·æ¿å¤–åŒ…ç»™ç»éªŒä¸°å¯Œçš„å·¥ç¨‹å¸ˆå›¢é˜Ÿï¼Œ</li><li>è®¿é—®å¤§é‡æœ€å…ˆè¿›çš„åŠŸèƒ½ï¼Œå‡ ä¹ä¸éœ€è¦ä¿®æ”¹æ‚¨çš„ä»£ç </li></ul>



<p>å€ŸåŠ©Neptune integrationï¼Œæ‚¨å¯ä»¥å…è´¹è·å¾—ä¸€äº›é¢å¤–çš„ä¸œè¥¿:</p>



<ul><li>ä½ å¯ä»¥ç›‘æ§å’Œè·Ÿè¸ªä½ çš„æ·±åº¦å­¦ä¹ å®éªŒ</li><li>ä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°ä¸å…¶ä»–äººåˆ†äº«ä½ çš„ç ”ç©¶</li><li>æ‚¨å’Œæ‚¨çš„å›¢é˜Ÿå¯ä»¥è®¿é—®å®éªŒå…ƒæ•°æ®å¹¶æ›´æœ‰æ•ˆåœ°åä½œã€‚</li></ul>



<p>å¸Œæœ›æœ‰äº†è¿™ç§åŠ›é‡ï¼Œä½ å°†ç¡®åˆ‡åœ°çŸ¥é“ä½ (å’Œå…¶ä»–äºº)å°è¯•äº†ä»€ä¹ˆï¼Œä½ çš„æ·±åº¦å­¦ä¹ ç ”ç©¶å°†ä»¥é—ªç”µèˆ¬çš„é€Ÿåº¦å‰è¿›</p>



<h2 id="h-full-pytorch-lightning-tracking-script">å®Œæ•´çš„PyTorché—ªç”µè¿½è¸ªè„šæœ¬</h2>



<pre class="hljs">pip install --upgrade torch pytorch-lightning&gt;=<span class="hljs-number">1.5</span><span class="hljs-number">.0</span>
    neptune-client
    matplotlib scikit-plot
</pre>



<pre class="hljs"><span class="hljs-keyword">import</span> os

<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> neptune.new <span class="hljs-keyword">as</span> neptune
<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">from</span> torch.nn <span class="hljs-keyword">import</span> functional <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> DataLoader
<span class="hljs-keyword">from</span> torchvision.datasets <span class="hljs-keyword">import</span> MNIST
<span class="hljs-keyword">from</span> torchvision <span class="hljs-keyword">import</span> transforms
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-keyword">import</span> pytorch_lightning <span class="hljs-keyword">as</span> pl

MAX_EPOCHS=<span class="hljs-number">15</span>
LR=<span class="hljs-number">0.02</span>
BATCHSIZE=<span class="hljs-number">32</span>
CHECKPOINTS_DIR = <span class="hljs-string">'my_models/checkpoints'</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CoolSystem</span><span class="hljs-params">(pl.LightningModule)</span>:</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        super(CoolSystem, self).__init__()
        
        self.l1 = torch.nn.Linear(<span class="hljs-number">28</span> * <span class="hljs-number">28</span>, <span class="hljs-number">10</span>)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span><span class="hljs-params">(self, x)</span>:</span>
        <span class="hljs-keyword">return</span> torch.relu(self.l1(x.view(x.size(<span class="hljs-number">0</span>), <span class="hljs-number">-1</span>)))

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">training_step</span><span class="hljs-params">(self, batch, batch_idx)</span>:</span>
        
        x, y = batch
        y_hat = self.forward(x)
        loss = F.cross_entropy(y_hat, y)
        self.log(<span class="hljs-string">'train/loss'</span>, loss)
        <span class="hljs-keyword">return</span> {<span class="hljs-string">'loss'</span>: loss}

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validation_step</span><span class="hljs-params">(self, batch, batch_idx)</span>:</span>
        
        x, y = batch
        y_hat = self.forward(x)
        loss = F.cross_entropy(y_hat, y)
        self.log(<span class="hljs-string">'val/loss'</span>, loss)
        <span class="hljs-keyword">return</span> {<span class="hljs-string">'val_loss'</span>: loss}

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">validation_epoch_end</span><span class="hljs-params">(self, outputs)</span>:</span>
        
        avg_loss = torch.stack([x[<span class="hljs-string">'val_loss'</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> outputs]).mean()

        fig = plt.figure()
        losses = np.stack([x[<span class="hljs-string">'val_loss'</span>].numpy() <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> outputs])
        plt.hist(losses)
        neptune_logger.experiment[<span class="hljs-string">'imgs/loss_histograms'</span>].upload(neptune.types.File.as_image(fig))

        <span class="hljs-keyword">return</span> {<span class="hljs-string">'avg_val_loss'</span>: avg_loss}

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_step</span><span class="hljs-params">(self, batch, batch_idx)</span>:</span>
        
        x, y = batch
        y_hat = self.forward(x)
        loss = F.cross_entropy(y_hat, y)
        self.log(<span class="hljs-string">'test/loss'</span>, loss)
        <span class="hljs-keyword">return</span> {<span class="hljs-string">'test_loss'</span>: loss}

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_end</span><span class="hljs-params">(self, outputs)</span>:</span>
        
        avg_loss = torch.stack([x[<span class="hljs-string">'test_loss'</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> outputs]).mean()
        <span class="hljs-keyword">return</span> {<span class="hljs-string">'avg_test_loss'</span>: avg_loss}

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">configure_optimizers</span><span class="hljs-params">(self)</span>:</span>
        
        
        
        <span class="hljs-keyword">return</span> torch.optim.Adam(self.parameters(), lr=LR)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">train_dataloader</span><span class="hljs-params">(self)</span>:</span>
        
        <span class="hljs-keyword">return</span> DataLoader(MNIST(os.getcwd(), train=<span class="hljs-keyword">True</span>, download=<span class="hljs-keyword">True</span>, transform=transforms.ToTensor()), batch_size=BATCHSIZE)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">val_dataloader</span><span class="hljs-params">(self)</span>:</span>
        
        <span class="hljs-keyword">return</span> DataLoader(MNIST(os.getcwd(), train=<span class="hljs-keyword">True</span>, download=<span class="hljs-keyword">True</span>, transform=transforms.ToTensor()), batch_size=BATCHSIZE)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_dataloader</span><span class="hljs-params">(self)</span>:</span>
        
        <span class="hljs-keyword">return</span> DataLoader(MNIST(os.getcwd(), train=<span class="hljs-keyword">False</span>, download=<span class="hljs-keyword">True</span>, transform=transforms.ToTensor()), batch_size=BATCHSIZE)
<span class="hljs-keyword">from</span> pytorch_lightning.loggers.neptune <span class="hljs-keyword">import</span> NeptuneLogger

neptune_logger = NeptuneLogger(
    api_key=<span class="hljs-string">"ANONYMOUS"</span>,
    project_name=<span class="hljs-string">"shared/pytorch-lightning-integration"</span>,
    tags=[<span class="hljs-string">"pytorch-lightning"</span>, <span class="hljs-string">"mlp"</span>],
)
model_checkpoint = pl.callbacks.ModelCheckpoint(filepath=CHECKPOINTS_DIR)

<span class="hljs-keyword">from</span> pytorch_lightning <span class="hljs-keyword">import</span> Trainer

model = CoolSystem()
trainer = Trainer(max_epochs=MAX_EPOCHS,
                  logger=neptune_logger,
                  checkpoint_callback=model_checkpoint,
                  )
trainer.fit(model)
trainer.test(model)


<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

model.freeze()
test_loader = DataLoader(MNIST(os.getcwd(), train=<span class="hljs-keyword">False</span>, download=<span class="hljs-keyword">True</span>, transform=transforms.ToTensor()), batch_size=<span class="hljs-number">256</span>)

y_true, y_pred = [],[]
<span class="hljs-keyword">for</span> i, (x, y) <span class="hljs-keyword">in</span> enumerate(test_loader):
    y_hat = model.forward(x).argmax(axis=<span class="hljs-number">1</span>).cpu().detach().numpy()
    y = y.cpu().detach().numpy()

    y_true.append(y)
    y_pred.append(y_hat)

    <span class="hljs-keyword">if</span> i == len(test_loader):
        <span class="hljs-keyword">break</span>
y_true = np.hstack(y_true)
y_pred = np.hstack(y_pred)


<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score

accuracy = accuracy_score(y_true, y_pred)
neptune_logger.experiment[<span class="hljs-string">'test/accuracy'</span>].log(accuracy)


<span class="hljs-keyword">from</span> scikitplot.metrics <span class="hljs-keyword">import</span> plot_confusion_matrix
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

fig, ax = plt.subplots(figsize=(<span class="hljs-number">16</span>, <span class="hljs-number">12</span>))
plot_confusion_matrix(y_true, y_pred, ax=ax)
neptune_logger.experiment[<span class="hljs-string">'confusion_matrix'</span>].log(File.as_image(fig))


neptune_logger.experiment(<span class="hljs-string">'checkpoints'</span>).upload(CHECKPOINTS_DIR)

neptune_logger.experiment.stop()
</pre>
        </div>
        
    </div>    
</body>
</html>