<html>
<head>
<title>How to Solve the Data Ingestion and Feature Store Component of the MLOps Stack </title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何解决MLOps堆栈的数据接收和功能存储组件</h1>
<blockquote>原文：<a href="https://web.archive.org/web/https://neptune.ai/blog/data-ingestion-and-feature-store-component-mlops-stack#0001-01-01">https://web.archive.org/web/https://neptune.ai/blog/data-ingestion-and-feature-store-component-mlops-stack#0001-01-01</a></blockquote><div><div class="l-content content-wrapper js-content">
            
<p>正如<em>数据科学</em>领域的每个从业者所知，<strong>数据</strong> <strong>是机器学习</strong>的主要燃料。值得信赖的数据源和高质量的数据收集和处理可以支持大量潜在的ML用例。但是拥有一个治理良好的<a href="https://web.archive.org/web/20230106144203/https://aws.amazon.com/data-warehouse/#:~:text=A%20data%20warehouse%20is%20a,typically%20on%20a%20regular%20cadence." target="_blank" rel="noreferrer noopener nofollow">数据仓库</a>需要组织中的每个团队全心全意地照顾和管理他们产生、摄取、分析或利用的每个数据点。<strong>数据质量责任分散到每个人身上</strong>。它不仅仅依赖于数据工程团队。</p>


<div class="wp-block-image">
<figure class="aligncenter size-full is-resized"><img decoding="async" src="../Images/c46001e8993e189536a7c80cce725506.png" alt="Data quality characteristics" class="wp-image-71390" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20230106144203im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/how-to-solve-the-data-ingestion-and-feature-store-component-of-the-MLOps-stack-1.png?resize=668%2C353&amp;ssl=1"/><figcaption><em>Main properties of Data Quality | <a href="https://web.archive.org/web/20230106144203/https://www.aqclab.es/index.php/en/data-quality-iso-25012" target="_blank" rel="noreferrer noopener nofollow">Source</a></em></figcaption></figure></div>


<p>如今组织中最常见的数据架构是<a href="https://web.archive.org/web/20230106144203/https://en.wikipedia.org/wiki/Lambda_architecture" target="_blank" rel="noreferrer noopener nofollow"> Lambda架构</a>。它的特点是有独立的批处理和流管道将数据接收到数据湖中，数据湖由一个<em>着陆</em>或<em>原始</em>阶段组成，其中<a href="https://web.archive.org/web/20230106144203/https://www.ibm.com/cloud/learn/elt" target="_blank" rel="noreferrer noopener nofollow"> ELT </a> <em> </em>进程转储原始数据对象，如事件或数据库记录转储。</p>



<p>这些原始数据随后被接收到更有组织的数据湖表(例如Parquet文件)中，然后被充实到<em>数据仓库</em>中。进入数据仓库的数据是不同业务领域的逻辑组织信息，称为<a href="https://web.archive.org/web/20230106144203/https://www.oracle.com/autonomous-database/what-is-data-mart/" target="_blank" rel="noreferrer noopener nofollow">数据集市</a>。这些数据集市很容易被数据分析师查询和被业务涉众探索。每个数据集市可以与不同的业务单元或产品领域相关联(<em>营销、订阅、注册、产品、用户…) </em>。</p>


<div class="wp-block-image">
<figure class="aligncenter size-large is-resized"><img decoding="async" loading="lazy" src="../Images/f612da0195de0711b192d3cdc3aec3be.png" alt="Example of a typical Data Architecture" class="wp-image-71391" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20230106144203im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/how-to-solve-the-data-ingestion-and-feature-store-component-of-the-MLOps-stack-2.png?resize=840%2C411&amp;ssl=1"/><figcaption><em>Example of a typical Data Architecture in Google Cloud Platform | <a href="https://web.archive.org/web/20230106144203/https://blog.miraclesoft.com/data-foundation-with-modernized-data-lake-data-warehouse/" target="_blank" rel="noreferrer noopener nofollow">Source</a></em></figcaption></figure></div>


<p>还有其他的参考架构模式，例如,<a href="https://web.archive.org/web/20230106144203/https://hazelcast.com/glossary/kappa-architecture/#:~:text=What%20Is%20the%20Kappa%20Architecture,with%20a%20single%20technology%20stack." target="_blank" rel="noreferrer noopener nofollow"> Kappa </a>或Delta，后者得到了商业产品的大量支持，例如【】Databricks 和【】Delta Lake 。</p>



<p>这些基础数据架构模式为分析工作负载铺平了道路。<a href="https://web.archive.org/web/20230106144203/https://en.wikipedia.org/wiki/Online_analytical_processing" target="_blank" rel="noreferrer noopener nofollow"> OLAP </a>大数据数据库和处理引擎，如<a href="https://web.archive.org/web/20230106144203/https://spark.apache.org/" target="_blank" rel="noreferrer noopener nofollow"> Spark </a>和<a href="https://web.archive.org/web/20230106144203/https://www.dask.org/" target="_blank" rel="noreferrer noopener nofollow"> Dask </a>等，已经实现了存储和计算硬件的解耦，允许数据从业者与海量数据进行交互，以进行<em>数据分析</em>和<em>数据科学</em>。</p>



<p>随着<a href="/web/20230106144203/https://neptune.ai/blog/mlops" target="_blank" rel="noreferrer noopener"> MLOps </a>、DataOps的兴起，以及<em>软件工程</em>在生产<em>机器学习</em>中的重要性，出现了不同的创业公司和产品来解决服务特征的问题，如<a href="https://web.archive.org/web/20230106144203/https://www.tecton.ai/" target="_blank" rel="noreferrer noopener nofollow"> Tecton </a>、<a href="https://web.archive.org/web/20230106144203/https://www.hopsworks.ai/" target="_blank" rel="noreferrer noopener nofollow"> HopsWorks </a>、<a href="https://web.archive.org/web/20230106144203/https://feast.dev/" target="_blank" rel="noreferrer noopener nofollow">盛宴</a>、<a href="https://web.archive.org/web/20230106144203/https://aws.amazon.com/sagemaker/feature-store/" target="_blank" rel="noreferrer noopener nofollow"> SageMaker特征店</a>、<a href="https://web.archive.org/web/20230106144203/https://docs.databricks.com/applications/machine-learning/feature-store/index.html" target="_blank" rel="noreferrer noopener nofollow"> Databricks特征店</a>、<a href="https://web.archive.org/web/20230106144203/https://cloud.google.com/vertex-ai/docs/featurestore" target="_blank" rel="noreferrer noopener nofollow">顶点AI特征店</a></p>



<p>此外，每个大规模从事生产数据科学的公司，如果没有使用前面提到的工具之一，都已经建立了自己的内部功能商店(例如，<a href="https://web.archive.org/web/20230106144203/https://www.uber.com/blog/michelangelo-machine-learning-platform/" target="_blank" rel="noreferrer noopener nofollow">优步是第一个发布自己构建ML平台方法的公司</a>，随后是Airbnb)。</p>



<p>在本文中，我们将解释特性商店解决的一些概念和问题，就像它是一个内部平台一样。这是因为我们认为理解底层组件以及它们之间的概念和技术关系更容易。我们不会深究商业产品。</p>



<p>我们还将讨论构建和购买之间的紧张关系，这是当今业界从业者的热门话题，以及实现这一决策的最佳方式。</p>







<h2 id="h-what-is-a-feature-store">什么是功能商店？</h2>



<p>去年，一些<a href="https://web.archive.org/web/20230106144203/https://www.datanami.com/2021/01/19/2021-the-year-of-the-feature-store/" target="_blank" rel="noreferrer noopener nofollow">博客和ML世界中有影响力的人将2021 </a>命名为功能商店年。我们将在下一节讨论这背后的原因。但是，什么是功能商店呢？</p>



<p><a href="https://web.archive.org/web/20230106144203/https://www.featurestore.org/" target="_blank" rel="noreferrer noopener nofollow">Featurestore.org</a>给出的简短定义是:</p>



<blockquote class="wp-block-quote"><p><em>“一个用于机器学习的</em> <strong> <em>数据管理层</em> </strong> <em>，允许共享&amp;发现功能并创建更有效的机器学习管道。”</em></p></blockquote>



<p>这很准确。简单地扩展一些细节，特征库由一组技术、架构、概念和语义组件组成，这些组件使ML从业者能够创建、摄取、发现和获取用于进行离线实验和开发在线生产服务的特征。</p>



<h3>功能存储的组件</h3>


<div class="wp-block-image">
<figure class="aligncenter size-large"><img decoding="async" src="../Images/2614ddb62321793cb34f134093acf150.png" alt="Components of a Feature Store" class="wp-image-71392" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20230106144203im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/how-to-solve-the-data-ingestion-and-feature-store-component-of-the-MLOps-stack-3.png?ssl=1"/><figcaption><em>Components of a feature store |<a href="https://web.archive.org/web/20230106144203/https://www.featureform.com/post/feature-stores-explained-the-three-common-architectures" target="_blank" rel="noreferrer noopener nofollow"> Source</a></em></figcaption></figure></div>


<p>我们应该开始定义什么是特征向量，因为它是特征库处理的核心实体。</p>



<ul><li><strong>特征向量:</strong>这是一个数据元素，包含一个实体标识符和一组在某个时间点描述该元素的属性或特征。例如，实体标识符可以是一个<strong>用户ID </strong>，并且属性可以包含以下值:(<em>时间_自_注册、n _购买、ltv _值、is _免费_试用、平均_购买_每月、累计_购买、最后_购买_ts等)</em></li></ul>



<p>现在，我们来解释托管这些特征向量的不同存储组件:</p>



<ul><li><strong>离线存储:</strong>这是一个分析数据库，可以接收、存储和提供离线工作负载的特征向量，如数据科学实验或批量生产作业。通常，每一行都包含一个由实体ID和给定时间戳唯一标识的特征向量。这个组件通常具体化为S3、红移、BigQuery、Hive等。</li></ul>



<ul><li><strong>在线商店:</strong>也称为<em>热数据</em>，该存储层旨在为低延迟预测服务提供功能。该数据库现在用于以毫秒级速度提取要素。Redis、DynamoDB或Cassandra是扮演这一角色的常见候选人。键值数据库是最好的选择，因为在运行时不经常需要复杂的查询和连接。</li></ul>



<ul><li><strong>特征目录或注册表:</strong>理想情况下，这是一个很好的UI，可以发现特征和训练数据集。</li></ul>



<ul><li><strong>特性商店SDK: </strong>这是一个Python库，抽象了线上和线下商店的访问模式。</li></ul>



<ul><li><strong>元数据管理:</strong>该组件用于跟踪来自不同用户或管道的访问、摄取过程、模式更改以及这类信息。</li></ul>



<ul><li><strong>离线和在线服务API: </strong>这是一个代理服务，位于SDK和在线及功能硬件之间，以方便功能访问。</li></ul>



<p>在下面的时间顺序图中，我们可以看到自2017年优步发布其著名的<a href="https://web.archive.org/web/20230106144203/https://www.uber.com/blog/michelangelo-machine-learning-platform/" target="_blank" rel="noreferrer noopener nofollow">米开朗基罗</a>以来围绕feature store的关键里程碑的总结。几年后，在几个商业和操作系统产品推出后，我们已经看到行业从业者广泛接受了功能商店的概念。一些组织如featurestore.org的T2和T4的mlops.community应运而生。</p>


<div class="wp-block-image">
<figure class="aligncenter size-large"><img decoding="async" src="../Images/2f5841be99c631cb465c67041ef2c938.png" alt=" Feature Store Milestones chart" class="wp-image-71393" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20230106144203im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/how-to-solve-the-data-ingestion-and-feature-store-component-of-the-MLOps-stack-4.png?ssl=1"/><figcaption><em>Feature Store Milestones | <a href="https://web.archive.org/web/20230106144203/https://medium.com/data-for-ai/feature-store-milestones-cca2bafe6e9c" target="_blank" rel="noreferrer noopener nofollow">Source </a></em></figcaption></figure></div>


<p>在与MLOps的关系中，特性存储本身受到影响，并影响堆栈的其他组件，如数据仓库、数据湖、数据作业调度程序、生产数据库等。也是。我们将在后面详细讨论这种关系，即功能商店在MLOps框架的大图中处于什么位置？</p>



<p>现在，让我们讨论一下ML工程师在产品特征工程方面面临的一些主要问题。</p>



<h2 id="h-hassles-around-feature-store">围绕功能商店的争论</h2>



<h3>特征摄取和获取的标准化</h3>



<p>在存在适当的要素存储之前，每个数据科学团队使用非常不同的工具存储和获取要素。这些工作传统上被视为数据工程管道的一部分。因此，围绕这些工作的库、SDK和工具是数据工程师使用的。根据团队的专业知识、成熟水平和背景，他们可以是非常多样化的。</p>



<p>例如，您可以在同一组织中看到以下情况:</p>



<ul><li><strong>团队A: </strong>团队对数据工程不是很了解。他们使用裸露的熊猫和带有psycopg <strong> </strong>连接器的SQL <strong> </strong>脚本在Redshift中存储离线特性，使用boto在DynamoDb中存储在线特性。</li><li><strong>团队B: </strong>团队成熟，自主。他们建立了一个库，使用sqlalchemy <strong> </strong>或PySpark <strong> </strong>进行大数据作业，抽象出与几个数据源的连接。他们还有自定义的包装器，用于向DynamoDb和其他热门数据库发送数据。</li></ul>



<p>这在大型组织中非常典型，在这些组织中，ML团队不是完全集中的，或者ML跨团队不存在。</p>



<p>在不同项目中使用相同数据库的团队倾向于围绕它们构建包装器，这样他们就可以抽象连接器并封装公共实用程序或领域定义。这个问题已经被团队b解决了。但是团队A不太熟练，他们可能会开发另一个内部库来以更简单的方式处理他们的特性。</p>



<p>这导致了团队之间的摩擦，因为他们想在整个组织中推行他们的工具。这也降低了团队的生产力水平，因为每个团队都在以自己的方式重新发明轮子，将开发人员与项目联系起来。</p>



<p>通过引入特性存储SDK，两个团队可以利用相同的接口与Redshift和DynamoDb以及其他数据源进行交互。团队A的学习曲线会更陡，但他们会保持相同的操作标准。因此，总体生产率将会提高。这允许更好的特性治理。SDK通常隐藏其他API调用来记录用户请求和版本数据集，允许回滚等。</p>



<p>大多数商业特性商店都提供特定的SDK来与他们的中心服务进行交互。例如，在下一个片段的<a href="https://web.archive.org/web/20230106144203/https://github.com/feast-dev/feast#5-build-a-training-dataset" target="_blank" rel="noreferrer noopener nofollow">中，您可以看到如何构建一个从Feast获取特性的数据集。</a></p>


<div class="wp-block-image">
<figure class="aligncenter size-full is-resized"><img decoding="async" loading="lazy" src="../Images/4b88573516faf7e9548b1fc075e33acb.png" alt="Building a dataset " class="wp-image-71394" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20230106144203im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/how-to-solve-the-data-ingestion-and-feature-store-component-of-the-MLOps-stack-5.png?resize=840%2C651&amp;ssl=1"/><figcaption><em>Build a dataset fetching features from Feast | <a href="https://web.archive.org/web/20230106144203/https://github.com/feast-dev/feast#5-build-a-training-dataset" target="_blank" rel="noreferrer noopener nofollow">Source </a></em></figcaption></figure></div>


<p>这不仅对标准化特色商店运营有价值，而且对抽象线上和线下商店的硬件也有价值。数据科学家不需要知道离线存储是BigQuery还是Redshift数据库。这是一个很大的好处，因为您可以根据用例、数据等使用不同的源。</p>



<h3>时间旅行数据</h3>



<p>如果我们想预测一个用户是否会购买一个产品，我们必须建立一个包含直到那个特定时刻的特征的数据集。<strong>我们需要非常小心不要引入未来的数据，因为这会导致</strong> <a href="https://web.archive.org/web/20230106144203/https://machinelearningmastery.com/data-leakage-machine-learning/" target="_blank" rel="noreferrer noopener nofollow"> <strong>数据泄露</strong> </a> <strong>。</strong>但是如何？</p>



<p>如果我们将未来数据引入关于每个观察的训练数据集中，<em>机器学习</em>模型将学习不可靠的模式。当将模型投入实时生产时，它将无法访问相同的功能(除非你可以旅行到未来)，其预测能力将会退化。</p>



<p>回到产品购买预测的例子，假设您想要使用关于用户的特定特征，例如，保存在购物车中的商品数量。训练数据集将包含关于看到并购买产品的用户(正标签)和看到但没有购买产品的用户(负标签)的事件。如果您想使用购物车中的商品数量作为一个特性，那么您需要专门查询那些记录在同一个会话中添加到购物车中的每个商品的事件，并且就在purchase/seen事件之前。</p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><img decoding="async" src="../Images/5f7c4db67da23f4d512334afb0cac36e.png" alt="Time Travel in ML" class="wp-image-71395" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20230106144203im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/how-to-solve-the-data-ingestion-and-feature-store-component-of-the-MLOps-stack-6.png?ssl=1"/><figcaption><em>Tecton: Time Travel in ML | <a href="https://web.archive.org/web/20230106144203/https://www.tecton.ai/blog/time-travel-in-ml/" target="_blank" rel="noreferrer noopener nofollow">Source</a></em></figcaption></figure></div>


<p>因此，在构建这样一个数据集时，我们需要专门查询关于每个事件在那个时间点可用的<strong>特征。有必要再现事件发生的世界。</strong></p>



<h4>如何有一个准确的图片？</h4>



<ul><li><strong>记录并等待</strong>:你只需要记录特定的特性，比如<em>n _ cumulative _ items _ in _ the _ cart，</em>，然后我们就可以知道用户在那个时间点有多少商品。主要的缺点是这种特性收集策略需要时间来为用例收集足够的数据点。但另一方面，实现起来也很容易。<br/></li><li><strong>回填</strong> <em> : </em>该技术基本上旨在在给定的时间点重建期望的特征。例如，通过查看记录的事件，我们可以在每次购买之前将所有商品添加到购物车中。然而，这可能会变得非常复杂，因为我们必须为每个要素选择时间窗口截止点。这些查询通常被称为<strong>时间点</strong>连接。<br/></li><li><strong>快照<em> : </em> </strong>基于定期转储生产数据库的状态。这允许在任何给定的时间点拥有特性，缺点是连续快照之间的数据更改将不可用。</li></ul>



<h3>用于生产的功能可用性</h3>



<p>当一个新的ML用例被提出时，有经验的ML工程师倾向于在运行时(在线)考虑哪些特性是可用的。在大多数情况下，设计支持特性的系统是ML架构中最耗时的部分。</p>



<p>让最新的特征向量准备好被馈送给ML模型以进行预测不是一件容易的任务。涉及到许多组件，需要特别注意将它们粘合在一起。</p>



<p>生产中的特征可能来自非常不同的来源。它们可以在请求体参数中提供给算法，可以从特定的API中获取，从SQL或NoSQL数据库中检索，从Kafka主题事件中检索，从键值存储中检索，或者可以从其他数据中即时计算和导出。每一个都意味着不同程度的复杂性和资源容量。</p>



<h4>这些来源是什么？</h4>



<ol><li><strong>请求车身参数</strong></li></ol>



<p>这是接收用于预测的特征的最简单方式。获取这些特性并将它们传递给ML模型的责任被委托给推理API Web服务的客户或消费者。然而，这并不是最常见的特征供给方式。事实上，请求参数往往包含从其他来源获取特征向量所需的唯一标识符。这些通常是用户id、内容id、时间戳、搜索查询等。</p>



<ol start="2"><li><strong>数据库</strong></li></ol>



<p>根据特性模式和延迟的可发展性需求，特性可以存在于不同的数据库中，如Cassandra、DynamoDb、Redis、PostgreSQL或任何其他快速NoSQL或SQL数据库。从在线服务获取这些功能非常简单。您可以使用任何Python库，如用于DynamoDb的boto、用于redis的pyredis、用于PostgreSQL的psycopg2、用于mysql的mysql-connector-python、用于cassandra的cassandra-driver等等。</p>





<p>数据库中的每一行都有一个主键或索引，在运行时可用于每个预测请求。其余的列或值将是您可以使用的功能。</p>



<p>为了填写这些表格，我们可以根据要计算的特征的性质使用不同的方法:</p>



<ul><li><strong>批处理作业:</strong>这些是计算密集型、繁重且“缓慢”的，这就是为什么它们只提供由它们需要多<em>新鲜</em>所定义的特定类型的功能。当构建不同的用例时，你会意识到不是每个模型都需要实时特性。如果你使用的是产品的平均评分，你不需要每秒计算一次平均值。像这样的大多数特征只需要一个日常计算。如果该功能需要高于1天的更新频率，您应该开始考虑批处理作业。</li></ul>


<div class="wp-block-image">
<figure class="aligncenter size-full"><img decoding="async" src="../Images/59c1b1adf8ede3545e8da11f45f40523.png" alt=" Batch processing example" class="wp-image-71397" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20230106144203im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/how-to-solve-the-data-ingestion-and-feature-store-component-of-the-MLOps-stack-8.png?ssl=1"/><figcaption><em>An example of a batch processing | <a href="https://web.archive.org/web/20230106144203/https://datawhatnow.com/batch-processing-mapreduce/" target="_blank" rel="noreferrer noopener nofollow">Source</a></em></figcaption></figure></div>


<p>谈到常见的技术堆栈，老朋友们开始为不同的目的和规模服务:</p>



<ul><li>气流+ DBT或Python是调度和运行这些作业的良好开端。</li><li>如果在分布式内存方面需要更大的规模，我们可以开始考虑Kubernetes集群来执行Spark或Dask作业。</li></ul>



<p>一些流程编排工具的替代品是Prefect、Dagster、Luigi或Flyte。看看<a href="/web/20230106144203/https://neptune.ai/blog/best-workflow-and-pipeline-orchestration-tools">数据科学编排和工作流工具</a>的对比。</p>



<ul><li><strong>流接收:</strong> <a href="https://web.archive.org/web/20230106144203/https://medium.com/data-for-ai/building-real-time-ml-pipelines-with-a-feature-store-9f90091eeb4"> </a>需要流或(近)实时计算的功能对时间很敏感。需要实时功能的常见用例有欺诈检测、实时产品推荐、预测性维护、动态定价、语音助手、聊天机器人等。对于这样的用例，我们需要一个非常快速的数据转换服务。</li></ul>


<div class="wp-block-image">
<figure class="aligncenter size-large"><img decoding="async" src="../Images/c6e03fa1b5bb2973cc9db53e328bd3df.png" alt="Building ML pipeline with Feature" class="wp-image-71398" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20230106144203im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/how-to-solve-the-data-ingestion-and-feature-store-component-of-the-MLOps-stack-10.png?ssl=1"/><figcaption><em>Building ML pipeline with Feature | <a href="https://web.archive.org/web/20230106144203/https://medium.com/data-for-ai/building-real-time-ml-pipelines-with-a-feature-store-9f90091eeb4" target="_blank" rel="noreferrer noopener">Source</a></em></figcaption></figure></div>


<p>这里有两个重要的维度需要考虑——<strong>频率</strong>和<strong>复杂度</strong>。例如，计算单个交易的“当前价格与月平均价格的标准差”既是实时的，也是复杂的汇总。</p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><img decoding="async" src="../Images/fc411d4faea2a2f74b4397eb17d1f51c.png" alt="Feature Store Streaming Ingestion" class="wp-image-71399" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20230106144203im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/how-to-solve-the-data-ingestion-and-feature-store-component-of-the-MLOps-stack-11.png?ssl=1"/><figcaption><em>Amazon SageMaker Feature Store Streaming Ingestion | <a href="https://web.archive.org/web/20230106144203/https://aws.amazon.com/es/blogs/aws-spanish/ingesta-de-streaming-con-amazon-sagemaker-feature-store-para-tomar-decisiones-respaldadas-por-ml-casi-en-tiempo-real/" target="_blank" rel="noreferrer noopener nofollow">Source</a></em></figcaption></figure></div>


<p>除了有一个收集事件的流工具(Kafka)之外，我们还需要一个高速和可伸缩的(每秒处理任意数量的事件)功能即服务(如AWS Lambda)来读取和处理这些事件。更重要的是，转换服务需要支持聚合、分组、连接、自定义函数、过滤器、滑动窗口，以便在给定的时间段内每隔X分钟或小时计算数据，等等。</p>



<h2 id="h-where-does-the-feature-store-sit-in-the-mlops-architecture">特性存储在MLOps架构中处于什么位置？</h2>



<p>特征库是ML平台的固有部分。如前所述，自从第一批ML车型投入生产以来，它就一直是其中的一部分，但直到几年前，这一概念才在MLOps世界中获得了自己的身份。</p>



<p>可以使用Neptune、MLFlow或SageMaker Experiments等实验跟踪工具来跟踪要素数据源。也就是说，假设您正在训练一个欺诈检测模型，并且您使用了另一个团队构建的一些共享功能。如果您将这些要素元数据记录为参数，则在跟踪实验时，它们将与您的实验结果和代码一起被版本化。</p>


<div class="wp-block-image">
<figure class="aligncenter size-large"><img decoding="async" src="../Images/e95e651e74ed5bbeec53828ea6719e74.png" alt=" Orchestrating Spark ML Pipelines and MLflow for Production" class="wp-image-71400" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20230106144203im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/how-to-solve-the-data-ingestion-and-feature-store-component-of-the-MLOps-stack-12.png?ssl=1"/><figcaption>The Killer Feature Store: Orchestrating Spark ML Pipelines and MLflow for Production | <a href="https://web.archive.org/web/20230106144203/https://www.slideshare.net/databricks/the-killer-feature-store-orchestrating-spark-ml-pipelines-and-mlflow-for-production" target="_blank" rel="noreferrer noopener nofollow">Source</a></figcaption></figure></div>


<p>此外，当模型处于生产阶段时，它们成为关键部分。现场直播时，有几个组件需要同步和密切监控。如果其中一个失败，预测可能会很快降级。这些组件是功能计算和摄取管道以及来自生产服务的功能消费。计算管道需要以特定的频率运行，以便特征的新鲜度不会影响在线预测。例如:如果一个推荐系统需要知道你昨天观看的电影，那么在你再次进入媒体流服务之前，应该运行特征管道！</p>



<h2 id="h-how-to-implement-a-feature-store">如何实现功能商店？</h2>



<p>在本节中，我们将讨论不同的架构，这些架构可以针对数据科学团队的不同阶段和规模来实施。在<a href="https://web.archive.org/web/20230106144203/https://eugeneyan.com/writing/feature-stores/" target="_blank" rel="noreferrer noopener nofollow">这篇非常好的文章</a>中，你可以看到作者如何使用<em>需求层次</em>来非常明确地展示哪些是你需要解决的主要问题。他将<strong> <em>访问</em> </strong> <em> </em>需求，包括透明性和血统，作为比<strong> <em>服务</em> </strong>更基础性的需求。我不完全同意，因为产品中的特性可用性释放了更高的商业价值。</p>



<p>下面给出的建议将基于AWS服务(尽管它们可以很容易地与其他公共云服务互换)。</p>



<h3>最简单的解决方案</h3>



<p>这种架构基于托管服务，托管服务需要较少的维护开销，更适合能够快速运行的小型团队。</p>



<p>我的初始设置是Redshift作为离线存储，DynamoDB作为在线键值存储，Airflow管理批量特征计算作业。此外，Pandas作为两种选择的数据处理引擎。在这种架构中，所有要素计算管道都在Airflow中进行调度，并且需要使用Python脚本来接收数据，这些脚本从红移或S3中提取数据，对其进行转换，并将其放入DynamoDB以用于在线服务，然后再次放入红移以用于离线要素存储。</p>


<div class="wp-block-image">
<figure class="aligncenter size-large is-resized"><img decoding="async" loading="lazy" src="../Images/2ae92301157bf7d3b4b6da8da28b128f.png" alt="The initial setup chart " class="wp-image-71401" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20230106144203im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/how-to-solve-the-data-ingestion-and-feature-store-component-of-the-MLOps-stack-13.png?resize=850%2C416&amp;ssl=1"/><figcaption><em>The initial setup | Source: author</em></figcaption></figure></div>


<h3>中型功能商店</h3>



<p>如果您已经在处理大数据、接近实时的功能需求以及跨数据科学团队的可重用性需求，那么您可能正在寻求跨功能管道的更多标准化和某种程度的可重用性。</p>



<p>在这种情况下，当数据科学团队规模相对较大时(比如说，超过8-10名数据科学家)，我会建议开始使用第三方功能商店供应商。首先，我会探索Feast，因为它是最常用的开源解决方案，并且可以在现有的基础设施上工作。您可以将Redshift用作离线特性存储，将DynamoDB或Redis用作在线特性存储。对于延迟要求较低的在线预测服务，后者速度更快。<a href="https://web.archive.org/web/20230106144203/https://feast.dev/" target="_blank" rel="noreferrer noopener nofollow"> Feast </a>将通过他们的SDK和网络用户界面(尽管仍处于试验阶段)帮助分类和提供功能。如果你想要一个全面管理的商业工具，我恳求你尝试一下<a href="https://web.archive.org/web/20230106144203/https://www.tecton.ai/product/" target="_blank" rel="noreferrer noopener nofollow">泰克顿</a>。</p>



<p>如果有大数据需求，现在可以使用普通Python或Spark开发特性计算管道，利用<a href="https://web.archive.org/web/20230106144203/https://rtd.feast.dev/en/master/" target="_blank" rel="noreferrer noopener nofollow"> Feast SDK </a>管理数据摄取。</p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><img decoding="async" src="../Images/3f3227b62b8ef978d7d82153ab2afb35.png" alt="" class="wp-image-71402" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20230106144203im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/how-to-solve-the-data-ingestion-and-feature-store-component-of-the-MLOps-stack-14.png?ssl=1"/><figcaption><em>Running Feast in production | <a href="https://web.archive.org/web/20230106144203/https://docs.feast.dev/how-to-guides/running-feast-in-production" target="_blank" rel="noreferrer noopener nofollow">Source</a></em></figcaption></figure></div>


<p>在这种规模下，也很可能有一些实时特性和新鲜度需求的用例。在这种情况下，我们需要一个流媒体服务，将功能直接吸收到在线功能商店中。我们可以使用Kinesis服务和AWS Lambda将特征向量直接写入Redis或DynamoDB。如果需要窗口聚合，那么Kinesis数据分析、KafkaSQL或Spark Streaming可能是合理的选择。</p>



<h3>企业级功能商店</h3>



<p>在这个阶段，我们假设该公司有大量的数据科学家为不同的业务或技术领域创建不同类型的模型。为这种规模的开发团队设置架构的一个关键原则是提供一个可靠的、可伸缩的、安全的、标准化的数据平台。因此，SLA、GDPR、审计和访问控制列表是必须实施的强制性要求。在每个组织规模中，这些都是需要考虑的要点，但在这种情况下，它们扮演着重要的角色。</p>


<div class="wp-block-image">
<figure class="aligncenter size-large"><img decoding="async" src="../Images/16efc40d7321b56d4722dd16ce776507.png" alt="Feature Store" class="wp-image-71403" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20230106144203im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/how-to-solve-the-data-ingestion-and-feature-store-component-of-the-MLOps-stack-15.png?ssl=1"/><figcaption>feature store explained | <a href="https://web.archive.org/web/20230106144203/https://www.featureform.com/post/feature-stores-explained-the-three-common-architectures" target="_blank" rel="noreferrer noopener nofollow">Source </a></figcaption></figure></div>


<p>技术领域的大多数大公司都根据自己的需求、安全原则、现有基础设施和托管可用性建立了自己的功能商店，以避免在服务完全托管的情况下出现单点故障。</p>



<p>但如果情况并非如此，并且你正在运行一个公共云繁重的工作负载，那么使用AWS <a href="https://web.archive.org/web/20230106144203/https://aws.amazon.com/sagemaker/feature-store/" target="_blank" rel="noreferrer noopener nofollow"> SageMaker功能商店</a>或<a href="https://web.archive.org/web/20230106144203/https://cloud.google.com/vertex-ai/docs/featurestore" target="_blank" rel="noreferrer noopener nofollow"> GCP Vertex AI功能商店</a>可能是不错的选择。他们的API与开源产品非常相似，如果你已经在使用SageMaker或Vertex，那么设置他们的特性存储服务应该很简单。</p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><img decoding="async" src="../Images/0918088d3295a875d34de8e14d323a86.png" alt="Amazon SageMaker Feature Store " class="wp-image-71404" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20230106144203im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/how-to-solve-the-data-ingestion-and-feature-store-component-of-the-MLOps-stack-16.png?ssl=1"/><figcaption><em>Amazon SageMaker Feature Store for machine learning | <a href="https://web.archive.org/web/20230106144203/http://amazon%20sagemaker%20feature%20store%20for%20machine%20learning%20(ml)/" target="_blank" rel="noreferrer noopener nofollow">Source</a></em></figcaption></figure></div>


<p>Databricks还提供嵌入式功能存储服务，这也是一个很好的选择，可以与像<a href="https://web.archive.org/web/20230106144203/https://mlflow.org/" target="_blank" rel="noreferrer noopener nofollow"> MLFlow </a>这样的工具完美兼容。</p>


<div class="wp-block-image">
<figure class="aligncenter size-full"><img decoding="async" src="../Images/ad3f4cbd76eaffc0259358d26b500ffb.png" alt="" class="wp-image-71405" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20230106144203im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/how-to-solve-the-data-ingestion-and-feature-store-component-of-the-MLOps-stack-17.png?ssl=1"/><figcaption><em>Databricks Feature Store | <a href="https://web.archive.org/web/20230106144203/https://www.databricks.com/it/product/feature-store" target="_blank" rel="noreferrer noopener nofollow">Source</a></em></figcaption></figure></div>


<h2 id="h-the-buy-versus-build-question">购买还是制造的问题</h2>



<p>MLOps的格局一直由脸书、网飞、优步、Spotify等大玩家主导和塑造。这些年来，通过他们非常有影响力的工程师和博客。但是ML团队应该能够认识到他们在自己的组织、团队和业务领域中运作的环境。一个20万用户的应用程序不需要2000万用户的规模、标准化和僵化。这就是为什么<a href="/web/20230106144203/https://neptune.ai/blog/mlops-at-reasonable-scale">合理规模的m lops</a>成为不在FAANG类公司工作的资深从业者的热门话题。</p>






<div class="wp-block-image">
<figure class="aligncenter size-large"><img decoding="async" src="../Images/5ca493b5c0265ef1acaebc03a371ced7.png" alt="Graphic explanation of a feature store" class="wp-image-71406" data-recalc-dims="1" data-original-src="https://web.archive.org/web/20230106144203im_/https://i0.wp.com/neptune.ai/wp-content/uploads/2022/10/how-to-solve-the-data-ingestion-and-feature-store-component-of-the-MLOps-stack-18.png?ssl=1"/><figcaption><em>Explanation of a feature store | <a href="https://web.archive.org/web/20230106144203/https://towardsdatascience.com/do-you-need-a-feature-store-35b90c3d8963" target="_blank" rel="noreferrer noopener nofollow">Source </a></em></figcaption></figure></div>


<h3>谁应该建立一个功能商店？</h3>



<p>正如本文开头所提到的，在内部构建一个类似于商店的功能平台和购买一个商业或开源产品，如T2盛宴、霍普斯沃斯、T3或T4泰克顿T5之间，存在着一场持续的争斗。这种紧张关系的存在主要是因为这些产品在其架构和SDK中可能会有某种程度的固执己见。因此，这些工具中的大多数需要有一个中央服务来处理在线商店上的功能服务，这成为生产ML服务的单点故障。</p>



<p>此外，一些其他产品是完全SaaS，成为一些团队不确定的关键部分。因此，ML工程师怀疑是否在他们的MLOps旅程中过早地使用这些工具。</p>



<p>在中小型公司或初创公司中，ML和数据工程团队共享相同的技术堆栈是非常常见的。出于这个原因，迁移到一个特性商店可能会引起很大的麻烦，并暴露一些隐藏的成本。在计划、遗产维护、操作性、两面性等方面。，它成为另一个具有不同于传统数据工程的特定SDK的基础设施。</p>



<h3>谁应该购买功能商店？</h3>



<p>为了从商业功能商店中获取最大价值，您的用例以及数据科学团队的设置需要与它们提供的核心优势保持一致。严重依赖实时复杂ML用例的产品，如推荐系统、动态定价或欺诈检测，是最能利用这些工具的产品。</p>



<p>一个庞大的数据科学家团队也是拥有特征库的一个很好的理由，因为它将提高生产率和特征的可重用性。除此之外，它们通常提供一个很好的UI来发现和探索特性。尽管如此，商业特性库SDK和API提供了一组标准，以更为一致的方式获取和检索特性。作为副产品，数据被治理，可靠的元数据总是被记录。</p>



<p>在各种各样的ML团队领域中，上述情况并不总是满足的，并且建立这些新的商业栈有时仅仅是工程师的个人开发愿望，以跟上新技术的发展。</p>



<p>这就是为什么仍然有团队没有迁移到一个完整打包的特性库，而是仍然依赖现有的数据工程栈来运行他们的产品特性工程层。在我看来，这是完全正确的。</p>



<p>总而言之，特性存储只是在现有的数据工程堆栈上添加了一个方便的外壳，以提供统一的访问API，一个发现和管理特性集的漂亮UI，保证在线和特性存储之间的一致性，等等。但是所有这些特性并不是每个ML团队用例的关键。</p>



<h2 id="h-conclusion">结论</h2>



<p>我希望这篇文章提供了一个关于什么是特性存储的广阔的视野。但更重要的是,<strong> </strong>它们之所以必要的原因，以及构建时需要解决的关键组件。</p>



<p>功能存储对于提升数据科学行业的生产服务是必要的。但是你需要他们背后的工程师。ML工程师角色对于处理特征管道是至关重要的，因为它们只是一种特定类型的数据转换和摄取过程。像这样的混合角色使数据科学家能够更加专注于实验方面，并保证高质量的交付成果。</p>



<p>此外，我特别注意解释了<em>构建与购买</em>的困境。从我个人的经验来看，这个问题在任何一个成熟的ML团队中迟早都会出现。我试图描述它们对实现速度和标准化至关重要的情况，但也留下了一些思考，即为什么环境意识对于实现这项新技术是必要的。有经验的高级角色应考虑他们所处的MLOps旅程阶段。</p>



<p>功能商店(商业和开源)世界还很年轻，还没有一个统一的和公认的方法来处理所有不同的用例和需求。所以，在和一个人安定下来之前，尝试所有的方法。</p>



<h3>参考</h3>



<ol><li><a href="https://web.archive.org/web/20230106144203/https://eugeneyan.com/writing/feature-stores/" target="_blank" rel="noreferrer noopener nofollow">特色商店——需求层次</a> <strong> </strong></li><li><a href="https://web.archive.org/web/20230106144203/https://www.featureform.com/post/feature-stores-explained-the-three-common-architectures" target="_blank" rel="noreferrer noopener nofollow">功能商店讲解:三种常见架构|功能形式</a> <strong> </strong></li><li><a href="https://web.archive.org/web/20230106144203/https://www.moderndatastack.xyz/category/feature-store" target="_blank" rel="noreferrer noopener nofollow">特征存储-现代数据堆栈</a></li><li><a href="https://web.archive.org/web/20230106144203/https://www.tecton.ai/blog/time-travel-in-ml/#:~:text=Time-travel" target="_blank" rel="noreferrer noopener nofollow">回到未来:解决机器学习中的时间旅行问题|泰克顿</a></li><li><a href="https://web.archive.org/web/20230106144203/https://maxhalford.github.io/blog/dataset-time-travel/" target="_blank" rel="noreferrer noopener nofollow">数据集时间旅行概述Max Halford </a></li><li><a href="https://web.archive.org/web/20230106144203/https://www.youtube.com/watch?v=fU9hR3kiOK0" target="_blank" rel="noreferrer noopener nofollow">“用Apache Samza彻底改变数据库”,作者Martin Kleppmann </a></li><li><a href="https://web.archive.org/web/20230106144203/https://www.wikiwand.com/en/Temporal_database" target="_blank" rel="noreferrer noopener nofollow">时态数据库–wiki wand</a></li><li><a href="https://web.archive.org/web/20230106144203/https://medium.com/data-for-ai/building-real-time-ml-pipelines-with-a-feature-store-9f90091eeb4" target="_blank" rel="noreferrer noopener nofollow">利用特征库构建实时ML管道| Adi Hirsch tein著</a></li><li><a href="https://web.archive.org/web/20230106144203/https://docs.feast.dev/how-to-guides/running-feast-in-production" target="_blank" rel="noreferrer noopener nofollow">生产中的奔跑盛宴</a></li><li><a href="https://web.archive.org/web/20230106144203/https://www.slideshare.net/databricks/the-killer-feature-store-orchestrating-spark-ml-pipelines-and-mlflow-for-production" target="_blank" rel="noreferrer noopener nofollow">黑仔特色店:协调生产用Spark ML管道和ML flow</a></li><li><a href="https://web.archive.org/web/20230106144203/https://towardsdatascience.com/do-you-need-a-feature-store-35b90c3d8963" target="_blank" rel="noreferrer noopener nofollow">需要特色店吗？</a></li></ol>
        </div>
        
    </div>    
</body>
</html>