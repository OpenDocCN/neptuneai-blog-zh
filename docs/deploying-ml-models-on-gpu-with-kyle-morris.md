# 使用 Kyle Morris 在 GPU 上部署 ML 模型

> 原文：<https://web.archive.org/web/https://neptune.ai/blog/deploying-ml-models-on-gpu-with-kyle-morris>

这篇文章最初是 MLOps Live(T1)的一集，这是一个互动的 Q(T2)环节，在这里，ML 从业者回答来自其他 ML 从业者的问题。

每集都专注于一个特定的 ML 主题，在这一集里，我们和来自 [Banana](https://web.archive.org/web/20230103154737/https://www.banana.dev/) 的 Kyle Morris 谈论了关于**在 GPU 上部署模型的事情。**

你可以在 YouTube 上观看:

[https://web.archive.org/web/20230103154737if_/https://www.youtube.com/embed/LchUTiF50xE?list=PLKePQLVx9tOczB07_oyDkdQqdNiqLV-zX](https://web.archive.org/web/20230103154737if_/https://www.youtube.com/embed/LchUTiF50xE?list=PLKePQLVx9tOczB07_oyDkdQqdNiqLV-zX)

视频

或者作为播客在以下位置收听:

但如果你更喜欢书面版本，这里有！

您将了解到:

## 1 开始部署 GPU 之前需要知道的事情

*   2 GPU 工具及其实用程序
*   3 围绕 GPU 的常见误解
*   4 充分利用 GPU
*   5 最佳 GPU 用例
*   6 使用 GPU 管理权衡
*   7…等等。
*   **Sabine:** 大家好，欢迎来到 MLOps Live。这是与我们今天的嘉宾[凯尔·莫瑞斯](https://web.archive.org/web/20230103154737/https://www.linkedin.com/in/kylejohnmorris/)的互动问答环节&。谁是今天这个话题的专家，就是在 GPU 上部署模型。凯尔，让你暖和一下。你如何解释在一分钟内在 GPU 上部署模型？

凯尔·莫里斯:是的，好问题。

我会说这感觉类似于在 21 世纪初部署一个网站。当我开始我的职业生涯时，没有基础设施来做这件事。我们已经建立了许多工具来使网站上线，并能够处理诸如可扩展性和平衡流量之类的事情，部署在不同的国家。一旦你用 GPU 做事情，基础设施就不存在了。我会称之为非常相似的底层基础设施，直到你深入了解并意识到它还没有建成。

> 当你问自己为什么会意识到有很多独特的延迟边缘情况。我认为 GPU 的游戏名称是延迟。缓慢的启动时间，如果你在做机器学习，缓慢的推理，诸如此类的事情是阻碍市场的原因。生产环境中的延迟越快，托管成本越低，世界就越容易访问它。成本和速度是阻碍生产基于 GPU 的系统的两个因素。我认为这是与传统系统的主要区别。

部署 GPU:开始之前要知道的事情

## 斯蒂芬:再问一个问题，你希望自己在创业时知道的三件事是什么？关于部署 GPU 的事情，通常只是使用基于 GPU 的模型？

凯尔:有两件事我希望一开始就知道。一个是集装箱化，在这方面非常精通。使用 Docker，Kubernetes，Pulumi，设置并能够容器化依赖 GPU 的应用程序。知道了如何设置 CUDA 驱动程序，你会花很多时间去做。假设你是一个早期的初创公司，你正试图部署一个生产应用程序，你不熟悉那些工具，你对 GPU 几乎没有希望。

第二件我觉得很不直观但很有趣的事情是，你用来做机器学习的应用程序主要是为训练而构建的。 [Pytorch](https://web.archive.org/web/20230103154737/https://pytorch.org/) 、 [TensorFlow](https://web.archive.org/web/20230103154737/https://www.tensorflow.org/?gclid=Cj0KCQiAtICdBhCLARIsALUBFcFL3cbSQw-TAnQqvYVDrw4a-RqwrZa3YoBySiqYAB4iZj65zjP2WfYaAuY2EALw_wcB) ，这些都是研发工具，还有 [Flask](https://web.archive.org/web/20230103154737/https://flask.palletsprojects.com/en/2.2.x/) ，你要设置的很多服务器，你都将处于开发模式。人们有一个很大的误解，就是他们带着开发工具去生产，他们没有意识到…

> 举一个具体的例子，我们有多少次客户试图给我们生产应用，他们没有启用 GPU。他们已经在 GPU 上启动了，但他们实际上只是在使用 CPU，他们甚至没有意识到他们没有这样做。然后，当您走到引擎盖下时，您意识到您的 Pytorch 脚本正在 CPU 上部署。诸如此类的小事，但当它深入下去，你会意识到这些工具并不是为快速运行这些事情而构建的。这就是我一直以来的观点，意识到我们需要一套全新的工具来部署生产 GPU 应用程序。

**Stephen:** 你谈到了这些工具中的大部分都是为训练自己而优化的。在我们深入探讨其他领域之前，我只想简单介绍一下这些工具。例如，您用于部署的工具是什么？它们有多相关？考虑在 GPU 上部署时，我是否需要学习一些原则？

Kyle: 我认为从任何编程的角度来说，理解你正在运行的硬件都是非常重要的。我的职业是机器人工程师。在此之前，我从事自动驾驶汽车的工作，如果你不了解硬件是如何执行的，你就无法利用速度优化的优势。这与人们一开始没有意识到他们部署在错误的硬件上有关。

GCP 上的 GPU 机器，或 AWS 上有一个 CPU。人们没有意识到他们甚至没有利用这个系统。一旦你做到了，你需要意识到 GPU 有一种不同的读、写和使用内存的方式。您可以做很多事情来大大提高模型的速度，比在训练环境中要快得多。我认为对 GPU 内存与 CPU 内存的工作原理有一个基本的了解，只是对操作系统有一个基本的了解，会给你一个新的视角。意识到这不仅仅是引擎盖下的计算，如果你认真尝试对生产机器学习进行压力测试，你会想要挖掘不同的提取，如 GPU 应用程序。

生产中的 GPU 与 CPU

## **斯蒂芬:**对。在计算方面，你认为团队在部署 GPU 和 CPU 时应该了解的最大区别是什么？

凯尔:是的。我认为最重要的是你正在使用的 GPU 驱动程序，并了解它们是否针对 ML 设置进行了优化。你真的在快速地加载和卸载一个 GPU 吗？例如，在我所做的工作中，我采用了需要 30 分钟加载的模型，并且我将它们优化为在 10 秒内加载。然后人们会说，“这不可能。”这就像，“不，你还没有打开引擎盖，意识到你正在像在 CPU 上一样按顺序加载它，而 GPU 不是这样工作的。你可以做这些新的事情。”我真的认为对内存接口的理解是一个很大的区别。

当你看一台计算机时，你有处理，就像一个单元，你有从内存读取的操作系统，但然后是 GPU 和 CPU，根本的区别是指令中的并行性。了解您是否真正充分利用了并行性。我建议你深入研究那些可以让你可视化 GPU 使用的工具，比如监控软件，基本上是为了真正看到你正在利用你正在使用的这个昂贵的硬件。

同样，为了将堆栈附加到它上面，我已经…

我在 ML 主机领域，我和几十个人一起工作过，90%的人没有利用 GPU——超过一半，他们没有意识到这一点。即使专家喜欢来自特斯拉、克鲁斯和汽车公司的人，他们仍然没有利用这一点。大多数 CPU 工具都是为了利用我们已经拥有多年的 CPU 而构建的。有了 GPU，还没有大量的生产机器学习。这只是，这只是开始成为一个大事情，所以这就是大优势所在。

> 围绕 GPU 的常见误解

## **Stephen:** 您还发现人们会犯其他错误吗，尤其是在理解他们如何利用或不利用他们在 GPU 上的部署时？

Kyle: 我之前说的不实际使用 GPU 是最大、最昂贵的错误。人们将自动扩展到 10 个 GPU 来处理流量。他们会过来对我说，“嘿，我需要更快地做出推论。”然后，我会意识到您正在使用一个 CPU，但他们已经部署在一个 GPU 上，碰巧他们使用的 CPU 更快，所以他们获得了 20%的速度提升。他们认为这就是 GPU 的力量。然后我们会说，“不，实际上在 GPU 上正确地运行这个并启用并行”，就像一个较低的级别。

如果你不熟悉 Python 全局解释器锁，我认为另一个模块是……它确实很具体，但这阻碍了许多 ML 应用程序，因为在 Python 语言中，大多数机器学习应用程序现在都是用 Python 编写的，它禁用了真正的并发或真正的并行。如果你知道如何把一些东西移植到 C++，或者另一个就像……我没有和 Golang 在机器学习或 infra 方面合作太多，你可以拥有真正的并行性。我说的是 30 倍的速度提升，不是 2 倍，3 倍。我的意思是，比如 10x，30x，32x，具体来说，基于 GPU 的大小。

你可以做很多很酷的事情。这需要努力，但没错，这是一个大障碍，人们通常不会意识到。那他们就不会堕落到承认这一点。他们只是认为，“哦，硬件一定很慢”。我认为一个常见的错误是人们过早地指责硬件。

> 他们没有意识到，如果你知道如何破解，GPU 硬件是非常强大的。如果你是一个新的工程师，我会看到的典型情况是，他们会尝试 CPU，就像这样，“我需要更快。扔在一个 GPU 上。”

他们意识到他们甚至没有使用它，或者他们没有意识到，然后他们会说，“我需要更快，使用 TPU”。他们只是使用这种每月 3000 美元的硬件，并在其上投入开箱即用的东西。我想重点是，如果你深入研究，你可以获得 10 到 30 倍的改进。这需要工作，这就是为什么我试图民主化，我想开始建立那里的工具。那是我的焦点。我在做，这样别人就不用做了。如果你在前沿领域遥遥领先，比方说，你在一家大的 ML 公司工作，但那里什么都没有，那就是你能创造很多价值的地方。

充分利用 GPU

## Stephen: 在回答社区问题之前，我会稍微深入一点。使用 GPU 的主要目的当然是为了加快推理时间。您首先会做什么，尤其是考虑到您希望优化正在进行的任何部署时？无论是从软件端还是硬件端？

凯尔:是的。第一件事是了解你在什么硬件上运行，以及该硬件的基本限制是什么。其次，了解你使用了多少，并知道如何使用调试器。对于 CPU，对于大多数代码，如果你在做 Python，你可以做第三步调试。一旦你开始使用 CUDA，在这个级别上，许多人不再看引擎盖下面，他们说，“哦，那是 CUDA。不是我的事。”可能这个社区有点不一样。

给自己一个周末的时间，就像这样，我要成为一名 GPU 工程师，一头扎进 CUDA。不要把它和一个结果联系在一起，只是强迫自己进入一点点的杂草中。了解 CUDA 如何分配内存，以便能够使用…即使最基本的命令行工具是 NVIDIA-SMI。然后能够理解如何在 GPU 上进行相当于步骤 3 的调试，并查看使用了多少内存。

> 一个好的第一步是什么是我的…假设你正在运行一个 ML 推理。这是一个很常见的方法，如果我把这个给每个人，我会说，“试试这个”。你们中的一半人可能会找到更好地使用 GPU 的方法。这个东西将运行你的应用程序。假设是一个 ML 服务器，看看有多少 GPU 内存。然后，只需对自己思考“我首先使用的是完整的 GPU 吗？”然后意识到可以并行加载东西。这是一个巨大的优势。

然后你会开始意识到有很多基础设施阻碍了内存虚拟化。其实很难做到。还有这些深层的技术问题。我并不是说这些都是容易的，快速的胜利，但是如果你真的想在这些系统上推动大的改变，那是你应该开始的地方。只是理解，我是在使用所有的 GPU 能力，还是有更多的可用？然后你可以开始做批量推理，这样你就可以调整你的模型。希望我使用的是以 ML 为中心的。我假设那是观众，但是如果你正在做 ML 工作负载，你可以开始批量处理输入，然后你可以说，开始。

到目前为止，我有需要 3GB 内存的型号。我开始批量处理。我基本上是并行进行推理，现在我使用 12GB 的内存。还是一个 GPU，除了做更高的吞吐量。这意味着推理之类的成本降低了 4 倍。这一切都始于理解如何调试你正在做的事情。如何真正打开它，看看发生了什么，然后问问题。

你调试得越好，你调试的工具就越好，这些显而易见的东西就会越快出现。人们是聪明的，你会看到什么是错的。但如果没有调试工具，一切都只是黑匣子。那么 GPU 就是这个用数字做事的无定形盒子。你只是无法利用他们提供的性能。

浏览当前的 ML 框架

## **斯蒂芬:**对。稍后我们将回到理解和工具上来。我想我们有几个来自社区的问题。

**萨宾:**是的。凯尔，你肯定已经提到这个了。Pietra 在 chat 中还提到，在 TensorFlow 这样的 ML 框架出现之前，你必须在底层用原生 CUDA 编码。开发起来更困难，需要更多的时间，但是你有很多的控制力和能力来优化你的代码。他想知道，在当前的框架下，你真的能做些什么来使推论更快？什么是典型的瓶颈，你能做些什么？

是的，我可以说你肯定可以。我正在做一个名为 banana.dev 的项目，主要是为了生产而优化 ML。一个例子是，我们让 GPTJ(一个非常大的变压器模型负载)快了近 100 倍。仅仅是通过开放库，在引擎盖下破解一些东西，并开始问一些简单的问题，比如“我们如何分配内存？这是我们能做的最好的吗？这个操作系统允许我们做什么？”所以，你肯定可以。是的，我同意。刚开始编程的时候，我是用 C++从头开始写渐变下降的。我知道这些新的抽象已经消除了这一点。

所以你不再问自己这些问题，但是从 Python 的角度你可以做很多事情。在一定程度上，你必须开始降低到 C++的全局解释器锁之下，因为要实现真正的并行，你肯定可以做到。我认为区别在于训练优化和生产推理。这些是非常不同类别的优化模型。训练更多的是关于机器之间的并行，你如何更快地收敛到一组重量？而生产推理就像，你如何向前传递？

首先，培训是向后传递，生产是向前传递。非常相似的事情，除了在生产中，你试图最小化你使用的计算量。在训练中，你会问，我如何最大限度地提高计算并行性，以便更快地进行训练？你只需要同时做一堆这样的事情。更多的是关于培训的吞吐量优化。在生产中，它是关于单个呼叫延迟和每次呼叫的价格。有一整套的东西，只要想想大多数人。您就培训优化与生产进行了多少次对话。就像人们还没有真正探索它一样。我看到还有第二个问题，但是…

GPU 适合实时推理吗？

## 萨宾:是的，没错。这第二个问题正是关于在生产中使用 GPU 进行推理。问题是，它只是用于批量预测，还是真的可以用于近实时？例如，在引擎盖下使用 GPU 的 REST API 端点。

**Kyle:** 是的，我再次假设，这意味着机器学习推理，并考虑使用 GPU 生产。这个问题取决于您的用例。通常，我可以说，我已经从 CPU 到 GPU 完成了大约 50-100 个项目。根据推理，你将看到的平均加速是通过 GPU 运行的 3-8 倍，就像现有的框架一样。您将更快地看到端到端延迟，并且您可以使用类似 REST API 的东西。

我多次构建的基本上是一个调用后端的 SDK，它只是一个 rest API。获取一个任务 ID，提取它，然后跟踪该任务。你把它作为一个长期的东西登记在一个数据库里。然后检查该任务的状态，并从推理服务器更新该任务。你有一个中间层。

用 GPU 肯定更快。最重要的是价格。如果你在做类似聊天机器人的事情，大多数人最终需要 GPU 推理，因为你不能…如果客户发送一条消息，需要 20 秒钟来响应，这与三秒钟、五秒钟的记忆有很大不同。这里的问题是，应该考虑用 GPU 做生产吗？是的。你需要考虑的最重要的事情是你的成本。您是否有一个支持成本的应用程序？

我不想无耻地插太多，但我在 Banana 做的大事，我正在做的项目，就是让 GPU 主机更便宜，完全公开。我能说的是，如果你有一个 GPU 应用程序，即使你有无服务器的 GPU，你也可以在不使用时关闭它们。如果使用它们的成本超过了客户交互的成本，你就不会想使用 GPU。

例如，有人进来，他们正在与你的聊天机器人聊天，你正在使用 GPU，他们的聊天时间是 10 分钟。如果这 10 分钟的 GPU 成本超过了客户为您的业务创造的成本或支付的成本，那么您就有负单位经济。我认为主要的障碍不是 GPU 很贵，而是人们总是开着它。主要的障碍是永远在线的图形处理器让你的单位经济变得很糟糕。你需要无服务器的…你可能会减少很多。

我会考虑这些不同的权衡。应该考虑 GPU 吗？当然，这样更快。客户喜欢更快的体验。也许你可以给出一个你可能不想使用 GPU 的边缘案例。我认为，如果您正在处理客户不需要响应的批量工作负载，比如说，在周五晚上，您将运行一个 cron 作业或他们现在的名称，这是一个基本的自动化作业，可以处理大量数据。CPU 可以便宜很多。这对你来说可能是一个不错的选择，但是一旦速度成为一个因素，GPU 肯定应该被考虑用于 ML。

**观看与凯尔·莫里斯的另一次精彩谈话:**

* * *

[https://web.archive.org/web/20230103154737if_/https://www.youtube.com/embed/eDFCZNZnN-Q?feature=oembed](https://web.archive.org/web/20230103154737if_/https://www.youtube.com/embed/eDFCZNZnN-Q?feature=oembed)

视频

实时 GPU 使用技巧

* * *

## 斯蒂芬:是的，我会跟进这个问题。一名社区成员向我们提出了一个问题。因此，这个特殊的团队过去常常通过他们的批处理工作流来运行 GPU 推断。现在，他们正在转向更实时的工作流程，因为这是业务发展的方向。这是更好地为他们的用户服务的东西。团队现在询问您在使用 GPU 实时节省成本以及优化资源方面有什么建议。我是说，这就是我们目前为止所说的。也许是更具体的东西。

凯尔:对不起。首先，我想澄清一下，当你说批处理时，你的意思是有两种类型的批处理。一种是批处理，你的电话在一周的某个时间打进来，你可以一次处理所有的电话。那么第二次批处理就是并行推理。你实际上是在向你的神经网络发送更大的有效载荷。我假设这需要后者，也就是你同时处理多个入口。就像你发送一个更大的有效载荷，然后问题是，如果你想把它像单独的调用一样分散，你不需要做这个庞大笨重的调用。你如何使它实时，这是我对这个问题的理解。

如果你想加快速度，我要考虑的主要事情是为你的用例重写内核，所以思考 GPU 所做的底层主要操作就像是网络的内核乘法，很多时候，我发现这一点。同样，有一种误解，认为你使用的工具是完美优化的，一旦你进入生产推理，你需要挑战这个假设。

你需要意识到，如果你深入了解——例如，我已经进入了最先进的图书馆，查看了他们的 GPU 所使用的内核。我会说，“嘿，这里有一个更好的方法来做矩阵乘法，”然后建立像 2-3x 这样的推理。我得说这是一个立竿见影的好方法。是的，它是这样的，因为你试图成为一个单一的调用速度内核，像乘法是最好的方式，或者尝试具有更快时钟周期的硬件，诸如此类，因为如果你不做批处理，那么这些都是你的选择。

如果你愿意沿着 JAX 的道路走下去，开始进行即时编译并查看你使用的硬件，即使是 CPU 也是值得考虑的，但我认为如果你想要 2 倍的速度，内核重写将是最容易实现的。那也许能让你实时。

最佳 GPU 用例

## **Sabine:** 是的，我们确实有一个关于 GPU 用例的问题。你在哪里看到最好的用例？显然，ML 训练和推理，尤其是神经网络，但是对于一些数据处理工作流或类似的东西是否也有好处？约书亚在问。有哪些最好的用例？

在我看来，我还是不知道真相。我希望你去发现你认为最好的，因为有很多东西要学。我所看到的是，视频处理是仅次于 banana.dev 的客户。这是他们来找我们进行视频处理的地方，他们没有使用机器学习，他们只是试图做基本上，我不能进入太多的细节，但基本上处理大型视频和做搜索之类的事情，没有神经网络，这只是传统的处理，但在 GPU 上你可以做得很好，因为你可以开始抨击帧，你可以比 CPU 快 10-30 倍。

我在想还有什么。机器人感知，我的意思是，这是我以前在克鲁斯时研究的。处理现场。同样，很多都是在引擎盖下进行的机器学习，但基本上，快速处理复杂丰富的场景就像是 GPU 的事情。视频最终会成为机器人感知，因为如果你在建造一辆自动驾驶汽车，你会不断地拍摄世界，你基本上是在创建一个视频，但你也可以有不同帧的视频，如点云和不同的数据类型。

任何需要像非 ML 那样的高帧率的地方。ML 是预测输出的东西，比如在 bash 过程和传统方法中进行推理。这些是我在实践中看到的主要事情。

无服务器 GPU 的问题

## **Stephen:** 说到基础设施，我们有一个问题，实际上是来自社区提交的。这个人问你怎么看待无服务器 GPU？您在与他们合作时发现了什么问题，他们正计划将其工作流程迁移到无服务器。问题是，他们在考虑无服务器的低延迟容忍度和冷启动问题。

凯尔:我的意思是，这是我的激情问题，我要试着回答正确。基本上，这里的理解是为什么？

**Stephen:** 你在使用无服务器 GPU 时发现了哪些问题？

凯尔:是的。第一个问题是它们没有被提供，所以这就是为什么我试图为它们建立一个解决方案，像一些可靠的东西。他们不存在的主要原因，从我的理解，是冷启动一个模型的能力。我可以给你一个例子，如果你要去建立无服务器的 GPU，我可以解释你接下来的三个月基本上会怎样。

这就像如果你从一个模型开始，你想设置自动缩放或什么的。你会发现的第一件事是，配置 GPU 可能需要几分钟时间来访问某些东西。一旦你有一个可用的 GPU，使用 Torch 或 TensorFlow，任何传统的库，加载一个典型的模型可能需要 5 到 20 分钟才能放入 GPU 内存。您需要进入并真正优化模型启动时间。在 Banana，这是我们唯一的焦点。这就是我们如何将启动一个模型的时间从 20 分钟缩短到几秒钟。基本上，如果你能做到这一点，你的推理速度是相同的速度，那么你就可以关闭电脑。

我认为这种类比就像，想象你有一辆车，你知道你可能要去做一次非常重要的旅行，比如说，去医院或者去朋友家什么的，你不知道什么时候，你只知道，在某个时候，你不得不这样做，那辆车需要 30 分钟才能熄火，然后你可能会一直开着车。这就是我们对 GPU 的问题，因为机器学习工作负载需要很长时间，人们只是让他们的 GPU 开着，因为这是保证客户拥有良好体验的唯一方法。

无服务器 GPU 的主要问题是启用它们，延迟，并消除这一点，因为这样你就有了一台永远在线的机器。他们擅长客户体验，除了你节省 90%或更多。我们正在朝这个方向努力。我们已经将它降低了 95%到 99%，但在许多应用程序中仍然不够，如果你有，比如说，一个客户进来，你可以通知 GPU 打开，你有 5，10 秒的时间，但如果你的应用程序需要亚秒，它还不存在，这是非常困难的。

我可以解释为什么这很难，但如果你想在一秒钟内启动一台机器，你需要能够在一秒钟内将内存加载到 GPU 上，最先进的固态硬盘的加载速率为 3-4GB/s，所以这就像是将内存加载到硬件上的能力有一个理论界限，足够快，可以在不到 5 秒钟内将 20GB 的型号加载到内存中。我们正试图寻找解决方法。这是一个限制，我们可能正在试验分片加载，一次跨多个 GPU 加载，我们正在进行分片推理，这样一来，每个 GPU 只需加载一秒钟的工作，因此在网络中展开各层，这基本上是我们试图解决的问题。

使用 GPU 进行模型维护

## **Sabine:** 然后，Piatra 向我们提出了更多的模型维护问题。让我们假设我们有一个生产模型，由数据科学家手动重新训练，可能每三个月改变一次网络架构、额外功能等。这是否意味着生产代码必须由 ML 工程师手动重写，以便在每次更新时针对 GPU 进行优化？

凯尔:这真是个好问题。只是说，只是权重在变化，还是有其他东西，因为 ML 模型有不同的组件，有代码和权重，基本上，想想看，你只是用某种语言定义了这个网络，然后你就有一堆权重加载到网络上。通常，如果权重发生变化，您不必更改底层代码。权重是最常见的，如果你微调模型，你不必改变底层代码，因此你不必重新优化。

第二件事是，即使权重或架构发生变化，通常情况下，你会希望编写抽象来捕获一组广泛的神经网络，你不会希望为一个网络硬编码你的优化，这通常不是它的工作方式。例如，如果你正在做像 Keras 这样的东西，这是一个非常高级的抽象，他们有什么，他们有一些层 API，如果你在优化它，你希望它能确保任何类型的层通过该 API，被编译成优化的 GPU 代码，或解释什么取决于你在使用什么。通常情况下，您不必对其进行太多更改。

我正试图想出一个例外，因为我认为这比只是说你不必这样做更有价值。我想一个例外是，如果你正在做—在 Banana，我们做了很多关于启动的事情，快速启动机器。一个很酷的例子是，如果您不断改变重量，或者您有许多不同的重量，您需要考虑如何快速存储和加载这些重量，因此存储成为一个实际的瓶颈，这成为您更多问题的来源，就是我在哪里放置所有这些优化的重量，我如何跟踪哪些需要进入瓶子，然后缓存它，使这个过程变得更快？这是花费时间最多的地方，而不是你的代码。

使用 GPU 管理权衡

## 萨宾:谢谢。马塞洛还有一个问题。正如您所说，在进行推理时拥有低延迟和降低成本之间似乎存在矛盾。如果你想能够足够快地进行推理，内存必须被加载到内存中，并且一直在为它的成本付费，即使是在不使用的时候。有没有解决这个问题的办法，基本上是让 GPU 的延迟和使用费用都很低？

凯尔:是的。我认为这取决于最终客户的体验。我假设每个人都在为客户构建，也许这是一个不正确的假设，但有人在消费你的模型的输出，这是我的假设。如果您的客户需要真正快速的响应，您可以做一些事情，如 GPU 的预测可用性。基本上，速度和成本是相互权衡的，我发现解决这个问题的唯一方法是在需要时让 GPU 可用，即无服务器 GPU，但有两个阵营，无服务器 GPU 仍然需要几秒钟才能启动，所以如果可以的话，对于您的应用程序，我会使用无服务器 GPU，就个人而言，这是节省大量成本的主要方式。

如果您的应用程序需要实时响应，而它何时出现是完全不可预测的，这是另一个未解决的问题，您只需要在成本不变高的情况下更快地做出推断。再说一遍，核仁是一个东西。沿着 ASIC 的道路，创建一个定制电路，在硬编码的网络架构上执行操作，这绝对是另一个角度。

我认为一个简单的方法是尝试预测流量，例如，您的应用程序需要快速响应，并且您有五个始终运行的 GPU，您能找到一种方法让其中一个始终运行，然后在需要时让其他四个自动扩展吗？然后，你可以处理 99%的流量高峰，除了你不用为五台永不停机的机器付费，这是你最省钱的地方。

我想我应该换一种说法，如何在不牺牲延迟的情况下省钱？这是我迄今为止想到的最好的办法。如果你想换一种方式，那就是真正的深度 R&D，解决这些硬件能源瓶颈，这是一样的。在 Cruise，我们正在进入这个领域，进入非常非常低的层次，深入到硬件之下。大多数团队可能不会这样做。如果这里有人对无服务器 GPU 感兴趣，显然，我不知道如何联系，但 DM 我，这是我正在努力做的事情。我很乐意帮忙。

云与本地 GPU

## **Sabine:**Sri Kant 向我们提出了一个关于本地与云的问题。例如，您如何看待由 NVIDIA AI 企业软件套件结合 Red Hat OpenShift 或 VMware Tanzu 管理的内部 GPU 集群，而不是由 EKS 管理的相同 GPU 集群的 AWS 堆栈或 Azure 堆栈？

凯尔:我想确定我收到了。他们特别询问现场体验。在 VPC，一个虚拟的私有云，可以访问您的资源，我假设存在隐私问题或其他问题，并且您正在询问多个不同的云。我没有和所有的软件都进行过深入的合作，我使用过 GCP 和 AWS，并对其他一些软件进行过实验。我认为，当你开始使用 Kubernetes 时，需要优化的是，如果你在所有东西上都有一个容器抽象，你基本上可以相当容易地改变云提供商。

我发现有一些令人头痛的问题，但我正在寻找一个提供最容易部署您的应用程序的抽象概念作为第一步，因为我认为大多数人在公司早期遇到的瓶颈还不是延迟或成本，而是他们是否为人们建立了有价值的东西，特别是如果你是一家初创公司，所以我会优化部署快速学习。我注意到的是，在很大程度上，许多提供商平衡了他们的 GCP 在一个领域的成本，但这将为您在其他产品上节省资金。

例如，我不能引用 Azure 的确切数字，但我知道 AWS 上有一组 EC2 实例要贵得多，而 GCP 上没有。这是一个立竿见影的效果，但当你进入后，你会看到网络成本或更多，然后开始正常化。我真的会优化，比如，我会问这样的问题，你的团队熟悉哪一个？您是否使用了使云不可知论者变得容易的抽象？如果不是，那就更成问题了。

如果你不使用像 Pulumi 这样的东西，我会认真考虑的。Pulumi 是我去年发现的最喜欢的工具之一，因为基本上，你可以使用相同的 Python 代码在 GCP 的 AWS 上部署。你不必进入控制台，这样会减少很多决策变量。它专注于在全球范围内为您节省最多时间的决策，比如如何使您的代码云不可知？那么仅仅选择决定也是高风险的。对吗？因为你真正要问的是，哦，所有这些供应商锁定了我，所以我必须做出这个重大决定，因为我知道这很难改变。

如果你去掉这个假设，你就很容易改变。你可以两全其美。你可以做一个多云部署，你可以说对于高 GPU 工作负载，使用 GCP，我认为这是我推荐的一个非常好的选择，不确定 Azure，然后如果你做一些高网络带宽或隐私中心，AWS 有很多好的产品，如 EKS。

削减 GPU 使用成本

## **Stephen:** 好的，在我们进入社区之前，当然，我们一直在说的一件事是成本节约，特别是在 GPU 方面。当然，使用 GPU 的一个关键障碍是价格。你不想有一天醒来，你有几千美元，因为你只是简单地让一个 EC2 实例和你的 GPU 等一切都开着。你节约成本的最佳秘诀是什么？我们谈到了无服务器，这是一方面，或者我可以通过使用 GPU 或部署模型和 GPU 来节省成本吗？

凯尔:这是个好问题。最简单的？我是根据做起来有多难以及能为你节省多少来衡量的。最简单的就是我前面说的，就是看你的模型占用多少内存，放在内存少的 GPU 上。如果可以的话，像这样，你只需要在内部削减成本。这真是太神奇了。

很多推理服务器在 Torch 中都有内存泄漏。很多 Torch 代码都有内存泄漏，比如超过 50%。事实是它一直在你的记忆痕迹中蔓延。如果你能够修复这样的东西，你可以把它保存在一台 GPU 内存更少的机器上。另一个问题是，如何将多个模型打包到一个 GPU 上？这是我们目前正在努力解决的问题。我们正在努力，因为在引擎盖下，这些工具，你可以自然地做到这一点。GPU 内存没有一个可访问的虚拟化层，因此这变得令人头痛，但这将是第二个赌注，就像自然的事情一样。就像，怎么把多个内存的东西放到同一个 GPU 上？

第三，我认为这是如果你愿意牺牲一点点性能，这在我的经验中是大多数团队都不愿意的，但是如果你愿意放弃 1%到 5%的性能量化，那么就像通过将浮点 64、浮点 32 改为 8 位浮点来减少模型权重的大小，你可以将模型大小减少 2-4 倍，并且你牺牲了性能，但是这看起来像是一个非常容易的胜利，我推荐你。我推荐一种混合的方法，所以如果你，再次，我在和种子阶段的 A 轮公司说话，就像早期阶段的产品，但是看看你正在做一个演示应用。

你需要速度。你能对模型进行量化吗？所以好像便宜了四倍。你只需要让它一直开着，你可以把它作为一个演示来提供，然后给那些需要真正高质量的超级用户。向你付费的人，你给他们一个不同的模型，没有那个，有额外的 5%，我会看到很多团队这样做，他们基本上根据客户类型在他们使用的模型之间切换。

我认为，如果你在这方面很聪明，如果你将产品思维和工程思维结合起来，而不是一切都只是工程问题，这就像，你的客户需要什么？你可以开始变聪明了。你可以说，这是前端人员的廉价模型，然后真正掏钱的人，他们得到这个模型。我认为你可以很容易地做到这些事情，你可以削减一半的成本。

使用 GPU 的分布式处理

## 萨宾:好吧。Ricardo 还有一个问题，您会使用哪些工具或框架来构建一个模型组合，这是一个需要由许多模型处理的推理请求，可能会在不同机器的分布式环境中运行。它们中的每一个都可能具有单独的资源约束、自动缩放策略等等。

Kyle: 有意思，模型链，我试着不要太偏向，因为我有一种方法来做我正在构建的产品，但我试着挑战自己，想想还有什么其他方法可以做到这一点。最简单的抽象是将每个模型视为一个单独的实体，您可以通过抽象掉几行代码来调用它。如果延迟–

让我们来看看目标是一个真正干净的架构的例子。然后你可能想要做的是有一个编排服务，能够发送一个请求给每一个模型，它基本上做一个调用管道。如果假设这些都是大型模型，它们可能运行在不同的服务器上，你基本上需要一个传送带式的过程，像调用一样，服务器将响应插入下一个服务器。

这是一个非常干净的设计，因为这样你就可以在管道的每一步进行日志记录。你将避免 GPU 内存耗尽的混乱，然后优化就会出现，就像，你会有网络延迟，对不对？如果你在所有这些之间做一个网络调用，并把它们链接在一起，那就很容易扩展，因为这样你就可以根据瓶颈自动扩展这个链的各个部分。短期内会容易些。一旦需要长期节省，那么瓶颈就是网络延迟。您可能想要相同的架构，但是如何在同一台机器上打包模型呢？然后，您可以在同一个服务器上调用它们。

> 香蕉就像是一个中间层。你有一个 Python SDK，你有一个类似 banana.run 或你正在使用的任何 SDK 的函数，它调用这个中间层，然后将它路由到一台机器，如果你有一个模型链，你只需调用六个不同的运行命令，你将它们绑定在一起，然后在幕后，你可以将它们打包在同一台机器上作为性能优化，但最终用户不应该改变他们的代码。

我认为最令人头痛的是，你必须不断地修改应用程序代码，以便与这些新的链式推理服务器一起工作。在用户和这个模型网格之间建立一个抽象将为您省去很多麻烦，因为每次您必须更改应用程序代码时，那都是一个新的轮询请求。这是新的测试，它真的增加了，人们低估了它。

使用 GPU 进行模型推理

## **萨宾:**爽。我们对推论有一些疑问。Gagan 想知道像 TFSerb、ONNX Runtime 等推理服务器有多好。帮助我们对付 Q2。例如，将 REST API 包装在一个巨大的模型上，比如拥抱面部变形金刚。

**Kyle:** 为了澄清，相对于仅仅做那件事或者仅仅是除此之外，这些工具有多少帮助——如果你想为一个模型服务，基本上，这些工具有多少帮助。

萨宾:是的，我想是的。

**Kyle:** 是的，我认为他们帮助很大的领域是，如果你在一个生态系统中，你试图快速部署一个开源模型，就像它是一个已经拥有所有这些服务基础架构设置的大型存储库的一部分。你可以做得很快。我使用一个叫做 [Zeep](https://web.archive.org/web/20230103154737/https://docs.python-zeep.org/en/master/) 的工具。这不是我的，它只是一个很酷的东西，基本上可以让您获取这些报告并快速部署它们。我认为 TFServe，很多这种类型的-他们熟悉其他部署软件，有一个标准接口，更容易设置它，而如果您在像 Flask app 这样的准系统中进行操作，您必须思考这样的问题，好吧，这可以处理负载平衡吗？诸如此类的事情。

那里有帮助。我想我有点偏见，因为我已经陷入了足够多的杂草。我用过 Triton 之类的东西。我们现在开始，至少在 Banana，我们正在构建我们自己的东西，因为我们遇到了自然瓶颈，所以我想应该怎么说呢，如果您是部署基础架构、生产和所有方面的新手，我认为这真的会很有帮助，然后如果您试图比市场上的任何其他地方都更快地打包东西，您试图去别人不去的地方，您可以选择这些工具。

最终，你会在它们下面结束，它们都像 Python，C++一样。在这一点上，它只是运行在 GPU 上的一些位，最终，你开始意识到所有这些框架都只是一些抽象，你失去了以同样的方式将它们视为工具的能力。基本上，作为一个初学者，我会从他们开始，直到，一般来说，我会这样，如果有一个工具可以解决你的问题，使用这个工具，而不是构建它，但如果你有任何真正的可伸缩性需求，你可能最终不得不去引擎盖下。然后，你最终必须在我所在的公司建立硬件。

Sabine: 好的，为了防止对这些推理框架有任何补充，我们有 Ricardo，他有兴趣知道你对这些的看法。像比如说 RayServe，TorchServe，KFserving，还有你说的那个 NVIDIA Triton 推理服务器，有用吗？它们只是增加了不必要的复杂性吗？他们中有谁开始超越其他人了吗？有什么要补充的吗？

Kyle: 是的，老实说，这些我都没用过。我还没有用过 [RayServe](https://web.archive.org/web/20230103154737/https://docs.ray.io/en/latest/serve/index.html) 。我用过 TorchServe、KF 和 NVIDIA，所以我可以在这些上面发言。就我个人而言，我是《T4》和《海卫一》的粉丝，我认为在制作环境中，我看到海卫一走得相当远。在中，我看到它扩展到数百人的团队和相当大的生产工作负载，我认为像这样的工具有助于它在 NVIDIA 生态系统中，你有内置的 GPU 兼容性，他们已经在内核优化的掩护下完成了一些工作。他们正在努力，所以越来越好了。如果你想要最好的 GPU 兼容性，我认为这将是我的默认选择。

老实说，TorchServe 已经有一段时间没用了，所以我可以根据我被吸引到的地方来谈论它。我不认为我有足够的全球视野来对哪个更好有一个坚定的看法，但我会说 Triton 是推理服务器的一个很好的起点。此外，我想我认为一件大事不仅仅是推理服务器，而是它所部署的基础设施，就像它是一件大事一样。

酷，你可能有一个准系统 Flask 应用程序或一个 Sanic 应用程序或基本上公开一个端口的东西，你可以发出 post 请求，我们正在进行推理。那是一个推理服务器。我认为更大的问题是您将在哪里部署它。这仅仅是在 EC2 实例上运行而没有自动重启吗？这在 Docker 上吗？在 Kubernetes 上吗？您是否正在进行与云无关的部署？这就是可靠性高于单个服务器的地方。

我几乎要缩小范围说，如果你过度专注于这些单独的服务器，你不会从它们那里获得胜利，那么它可能是不必要的复杂性。我在生产中部署的许多应用程序实际上都是 Torch 或 TensorFlow，我们得到了模型，我喜欢将它打包在一个应用程序中。然后，我注意到最大的故障模式来自——想想看，这不是单个服务器。它让你的服务器运行了很多。现在问题变成了自动扩展、冷启动和负载平衡。所有这些都在单个服务器之外。让我们来看看。

如果你从中获得了巨大的回报，那就继续钻吧，说实话，我不会太在意。感觉 GPU 游戏真的变成了低级游戏。有两个阵营。如果你只是尝试部署一些东西，使用一个框架，使用一个工具，走出去，并有可靠性。如果你试图优化一个 GPU 生产工作负载，那么你将不得不放弃这些框架。您可能会向这些提交拉取请求。我们需要更多的人这样做。

**萨宾:**没关系。我们之前确实跟进过这个问题，对于实时推理，你会推荐什么编排框架？

**凯尔:**是的，我显然会选择[香蕉](https://web.archive.org/web/20230103154737/https://www.banana.dev/)，因为我认为这是我们正在努力解决的问题之一。你会有永远在线的机器，但就像我们正在开发一个自助服务工具，就像尝试制作它，所以你只需上传你的模型，然后恢复调用它的能力，它将是实时的，因为它在 GPU 上。它永远在线，它会花费更多。如果您使用无服务器，基本上会有额外的延迟。我想跟进一下。

我还见过其他一些工具。再次，我会推荐 Zeep，如果你想把一堆推理服务器连在一起，我发现这个工具真的很有帮助。它与云无关。您只需点击一个回购，部署它，然后将它们链接在一起，实时性更多地是关于您在什么硬件上运行，以及它是否支持您的使用情形？在我看来，这不是一个真正的框架级别的事情。真正的实时推理是当你的推理足够快时，比如每秒 32 帧或其他什么。你可以在许多不同的框架上这样做，比如你如何实时连接是你推理的速度，这是两个不同的问题。

其他问题

## 萨宾:好吧。我们可以从聊天中获取一些问题。我们有一个安德烈斯的。您对云中的加密货币挖掘有什么看法吗？在云中部署加密货币挖掘网格并根据哈希算法的复杂性调整 GPU 负载是否可行？

凯尔:我不是密码专家。我很早就在现场，但后来我在过去的十年里一直在做 ML。我可以给出一点背景。是的，你可以。通常，我所看到的是采矿最终没有最大的投资回报，例外是如果你在做与优步相同的模型，即你有一辆未使用的汽车，所以你把它租出去，如果你有一个未使用的 GPU，你为采矿这样做，这可能很酷。

我认为一个非常有趣的使用案例，我很喜欢，如果这里有人构建它，我会成为客户，就是找到那些忘记从云中关闭 GPU 的人，过去，如果你忘记关闭 GPU，用它挖掘一些东西，利用它，这就是一个例子。如果只是部署他们，我觉得是可行的。

我还没有钻够，以了解看哈希率和你的投资回报率是多少，但我已经尝试了采矿的场景。一般来说，你会做一些东西，但必须是非常专注的。从技术上讲，如果你想用香蕉之类的东西来做这件事，你可以部署一个比特币挖矿机。我不知道云提供商是怎么想的，有些人会检查服务条款，但我认为你可以像机器学习一样做这件事。

**Sabine:** 我们也有一个来自 Marcello 的问题，很多时候，ML 模型可以作为 PyTorch 或 TensorFlow 模型使用，但是当将它们转换为 TensorRT 时，它们的性能会提高。这种情况总是发生吗，还是只适用于某些类型的神经网络？

Kyle: 我不知道，老实说，我对底层工作的了解还不足以胜任，我会鼓励你去经历，我不想说，我基本上知道这一点，但我会假设像循环网络这样的东西，会有更好的优化，因为你可以用循环数来兑现任何东西的权重，但是的，我真的不够了解。我对这些工具的底层还不够了解。我只是猜测，我不想浪费任何人的时间去猜测，如果我知道，我宁愿回答。

**Sabine:** 很好，我想我们还有时间回答另一个问题，这个问题是 Piotra 在聊天中提出的。当您通过降低浮点精度来缩小模型时，是否遇到过任何数值稳定性问题？

凯尔:这个问题很复杂。我想确保我理解了这个问题。你说的数值不稳定性是指爆炸梯度吗？基本上，你改变了权重，然后突然，输出变成了垃圾，因为通过改变的权重传播计算？你会得到这个的。这是相对于精度损失的渐近行为。我会注意到，从 64 位浮点到 32 位浮点，几乎没有不稳定性，32 到 16 趋于正常，16 到 8，你会开始看到它，然后 8 更少，它只是很快下降，成为垃圾。我不知道它背后的所有数学原理，但在实践中，我会把它视为一个渐近位，一旦接近 8 位精度，它就会有一堵墙。

我认为这也取决于网络大小，就像网络越长，乘法越多，误差通过精度传播的机会就越大。这尤其是一个给你上下文的东西，尤其是在循环网络中的问题。也许我在这里没有正确地使用递归，网络中有反馈回路，如果你在做重复的计算，你在把东西传递给下一层之前，你要多次运行它。基本上，乘法次数越多，误差就会越大。

仔细想想，64 位和 32 位之间的差异非常大，与 8 位到 7 位或 8 位到 4 位相比，这是一个巨大的差距，相对于另一种类型，这是一个巨大的信息损失，所以你会更快地看到这一点。这是非常特别的。我肯定有论文显示了这方面的实际渐近下降。我记得看到过一些。我不认为我有足够深刻的数学理解或数字来让你确切地知道它何时发生。

把它包起来！

## 斯蒂芬:我们今天已经谈论了很多关于工具的话题。我认为我们应该把它们都集中起来。可能把它们都绑在一起。什么是您部署 GPU 模型的关键工具，您随身携带并觉得有用的工具？

**凯尔:**基本上，就是[码头工人](https://web.archive.org/web/20230103154737/https://www.docker.com/)，[库伯内特](https://web.archive.org/web/20230103154737/https://kubernetes.io/)，[普鲁米](https://web.archive.org/web/20230103154737/https://www.pulumi.com/)。那应该是三个。如果你在一个岛上有三个工具，你必须建立一个生产栈，而你只有这三个工具，那就是我会选择的三个。我知道可能会有一些特定的容器运行时与 Kubernetes 一起工作，如 Containerd，我相信您可能会想探索其他一些容器，但如果您试图做一个生产工作负载，您需要容器编排，因为您需要能够将它连接到前端，像重新启动逻辑等等。这是我最简单的，那三个。

我知道我们的时间不多了，但我还有最后一个问题来总结这一切，把一切都确定下来。我来找你，我在试着优化我的 GPU 模型来进行 like 推理。我来找你，你带我经历你会带我经历的过程，从拥有我的模型到能够在 GPU 上运行实时推理等等。

凯尔:我们有两条路，对吧？我们有自助服务，这是我们现在真正的早期 MVP。你可以尝试一下。我可以跟进一个 git-repo。基本上，你按照一些指示，然后你可以上传你的模型到我们的服务器。你会得到两行你可以调用它的代码。你得到一个 API 模型密钥，这将给你无服务器的 GPU 速度。第二种会帮到你。对于那些不想为计算这些东西而头疼的人，我们可以建立一个 Slack 频道，我们的团队会和你一起工作。

我们仍处于起步阶段，所以我们希望有亲身体验来了解单个客户的痛点。如果后面有分享链接的方法，就像香蕉 ML 和 GitHub 一样。我们有回购协议。这是一条完全自动化的管道。前端 UX 还不多，主要是我们团队不是前端团队。

我们是非常深入的 R&D 工程师，因此如果您遇到任何问题，我们很乐意提供帮助，但我可以说，我们目前提供的通常是 5 到 10 倍的成本降低，因为您不必一直开着机器。我们有像自动驾驶汽车领域的人，我们有音频应用程序，像 GANs 这样的图像生成，以及许多不同类型的应用程序正在运行。很想听听你在做什么。

有没有让人伸手的方法？我不知道，我可以放弃一个 LinkedIn，或者如果你们有它，但基本上这里的任何人，也是非正式的，我喜欢帮助人们解决 GPU 问题。你还有什么问题吗？跟我一拍即合。我很高兴成为一个接触点。这可能是我们最擅长的一件事。我喜欢用它来帮助这个行业。我认为它现在在生产方面非常落后，所以如果它还没有在这次对话中传达出来，我可能会给你几个星期甚至几个月的时间。

**萨宾:**优秀。所以，LinkedIn 是和你联系的地方？是这样吗？也是通过香蕉和松脆？

Kyle: 是的，你可以这么做——我需要仔细检查一下我的 LinkedIn 是什么，但我可以把它放在这里。我认为，就像[凯尔·j·莫里斯一样，](https://web.archive.org/web/20230103154737/https://www.linkedin.com/in/kylejohnmorris/)你可以随心所欲地分享。

Sabine: 是时候结束了。非常感谢你，凯尔，和我们在一起，有你在真是太好了。

**Sabine:** It is indeed time to wrap it up. Thank you so much, Kyle, for being with us here, it was wonderful to have you.